<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conformit√© RGPD - MemoLib</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 10px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #667eea; margin-bottom: 10px; }
        .section { margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea; }
        .section h3 { color: #333; margin-bottom: 15px; }
        .btn { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 14px; margin: 5px; }
        .btn:hover { background: #5568d3; }
        .btn.danger { background: #dc3545; }
        .btn.danger:hover { background: #c82333; }
        .btn.warning { background: #ffc107; color: #212529; }
        .btn.warning:hover { background: #e0a800; }
        .result { padding: 15px; margin-top: 15px; border-radius: 5px; }
        .success { background: #d4edda; border-left: 4px solid #28a745; color: #155724; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; color: #721c24; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; color: #856404; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; color: #0c5460; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th, .data-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        .data-table th { background: #f8f9fa; font-weight: 600; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .status-compliant { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .checkbox-group { margin: 15px 0; }
        .checkbox-group label { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí Conformit√© RGPD</h1>
            <p>Gestion des donn√©es personnelles et respect du r√®glement europ√©en</p>
        </div>

        <div class="section">
            <h3>üìä √âtat de Conformit√©</h3>
            <div id="compliance-status">
                <div class="info">‚è≥ Chargement du rapport de conformit√©...</div>
            </div>
            <button class="btn" onclick="loadComplianceReport()">Actualiser le rapport</button>
        </div>

        <div class="section">
            <h3>üìä Anonymisation Intelligente (Recommand√©e)</h3>
            <p style="margin-bottom: 15px;">
                Anonymise vos donn√©es tout en <strong>pr√©servant leur utilit√©</strong>. 
                Les donn√©es restent exploitables pour vos analyses et statistiques.
            </p>
            <div class="info">
                <strong>‚ÑπÔ∏è Avantages:</strong>
                <ul style="margin-left: 20px; margin-top: 8px;">
                    <li>Donn√©es anonymis√©es mais exploitables</li>
                    <li>Analytics et statistiques pr√©serv√©es</li>
                    <li>R√©versible si n√©cessaire (avec autorisation)</li>
                    <li>Conforme RGPD avec utilit√© maximale</li>
                </ul>
            </div>
            <button class="btn" onclick="smartAnonymizeData()">Anonymisation Intelligente</button>
        </div>
            <p style="margin-bottom: 15px;">
                Anonymise automatiquement toutes vos donn√©es clients (emails, noms, t√©l√©phones, adresses) 
                tout en pr√©servant l'utilit√© des dossiers juridiques.
            </p>
            <div class="warning">
                <strong>‚ö†Ô∏è Attention:</strong> Cette action est irr√©versible. Les donn√©es originales seront remplac√©es par des versions anonymis√©es.
            </div>
            <button class="btn warning" onclick="anonymizeData()">Anonymiser mes donn√©es</button>
        </div>

        <div class="section">
            <h3>üì§ Export des Donn√©es (Portabilit√©)</h3>
            <p style="margin-bottom: 15px;">
                Exportez toutes vos donn√©es dans un format structur√© (JSON) conform√©ment au droit √† la portabilit√© RGPD.
            </p>
            <button class="btn" onclick="exportData()">Exporter mes donn√©es</button>
        </div>

        <div class="section">
            <h3>üóëÔ∏è Droit √† l'Oubli</h3>
            <p style="margin-bottom: 15px;">
                Supprime d√©finitivement toutes vos donn√©es personnelles du syst√®me. 
                <strong>Cette action est irr√©versible et supprimera tous vos dossiers.</strong>
            </p>
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="confirm-deletion">
                    Je comprends que cette action supprimera d√©finitivement toutes mes donn√©es
                </label>
                <label>
                    <input type="checkbox" id="confirm-irreversible">
                    Je confirme que cette action est irr√©versible
                </label>
            </div>
            <button class="btn danger" onclick="deleteAllData()" disabled id="delete-btn">
                Supprimer toutes mes donn√©es
            </button>
        </div>

        <div id="result"></div>
    </div>

    <script>
        let token = localStorage.getItem('authToken');

        // Activer le bouton de suppression seulement si les deux cases sont coch√©es
        document.getElementById('confirm-deletion').addEventListener('change', updateDeleteButton);
        document.getElementById('confirm-irreversible').addEventListener('change', updateDeleteButton);

        function updateDeleteButton() {
            const confirm1 = document.getElementById('confirm-deletion').checked;
            const confirm2 = document.getElementById('confirm-irreversible').checked;
            const deleteBtn = document.getElementById('delete-btn');
            
            deleteBtn.disabled = !(confirm1 && confirm2);
        }

        async function loadComplianceReport() {
            if (!token) {
                showResult('Vous devez √™tre connect√© pour acc√©der aux fonctions RGPD', 'error');
                return;
            }

            try {
                const response = await fetch('/api/gdpr/compliance-report', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const report = await response.json();

                if (response.ok) {
                    displayComplianceReport(report);
                } else {
                    showResult('Erreur lors du chargement du rapport', 'error');
                }
            } catch (error) {
                showResult(`Erreur: ${error.message}`, 'error');
            }
        }

        function displayComplianceReport(report) {
            const statusDiv = document.getElementById('compliance-status');
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Cat√©gorie de Donn√©es</th>
                            <th>Anonymis√©</th>
                            <th>P√©riode de R√©tention</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            report.dataCategories.forEach(category => {
                const statusClass = category.isAnonymized ? 'status-compliant' : 'status-pending';
                const statusText = category.isAnonymized ? 'Conforme' : 'En attente';
                
                html += `
                    <tr>
                        <td>${category.name}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${category.retentionPeriod}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                <div style="margin-top: 15px;">
                    <strong>M√©thodes d'anonymisation:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        ${report.anonymizationMethods.map(method => `<li>${method}</li>`).join('')}
                    </ul>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    Rapport g√©n√©r√© le: ${new Date(report.generatedAt).toLocaleString('fr-FR')}
                </div>
            `;

            statusDiv.innerHTML = html;
        }

        async function smartAnonymizeData() {
            if (!token) {
                showResult('Vous devez √™tre connect√©', 'error');
                return;
            }

            if (!confirm('√ätes-vous s√ªr de vouloir anonymiser intelligemment vos donn√©es ? Elles resteront exploitables.')) {
                return;
            }

            try {
                showResult('‚è≥ Anonymisation intelligente en cours...', 'info');

                const response = await fetch('/api/gdpr/smart-anonymize', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (response.ok) {
                    let analyticsHtml = '';
                    if (result.analytics) {
                        analyticsHtml = `<br><strong>Analytics g√©n√©r√©es:</strong><br>`;
                        if (result.analytics.emailDomainDistribution) {
                            analyticsHtml += `Domaines emails: ${Object.entries(result.analytics.emailDomainDistribution).map(([k,v]) => `${k}(${v})`).join(', ')}<br>`;
                        }
                        if (result.analytics.caseTypeDistribution) {
                            analyticsHtml += `Types de dossiers: ${Object.entries(result.analytics.caseTypeDistribution).map(([k,v]) => `${k}(${v})`).join(', ')}`;
                        }
                    }
                    
                    showResult(`‚úÖ ${result.message}<br>
                        √âv√©nements anonymis√©s: ${result.anonymizedEvents}<br>
                        R√©versible: ${result.isReversible ? 'Oui' : 'Non'}
                        ${analyticsHtml}`, 'success');
                    loadComplianceReport();
                } else {
                    showResult(`‚ùå Erreur: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }
            if (!token) {
                showResult('Vous devez √™tre connect√©', 'error');
                return;
            }

            if (!confirm('√ätes-vous s√ªr de vouloir anonymiser toutes vos donn√©es ? Cette action est irr√©versible.')) {
                return;
            }

            try {
                showResult('‚è≥ Anonymisation en cours...', 'info');

                const response = await fetch('/api/gdpr/anonymize-data', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (response.ok) {
                    showResult(`‚úÖ ${result.message}<br>
                        √âv√©nements anonymis√©s: ${result.anonymizedEvents}<br>
                        Clients anonymis√©s: ${result.anonymizedClients}`, 'success');
                    loadComplianceReport();
                } else {
                    showResult(`‚ùå Erreur: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        async function exportData() {
            if (!token) {
                showResult('Vous devez √™tre connect√©', 'error');
                return;
            }

            try {
                showResult('‚è≥ Export en cours...', 'info');

                const response = await fetch('/api/gdpr/data-export', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    // Cr√©er et t√©l√©charger le fichier
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `memolib-export-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    
                    showResult(`‚úÖ Export r√©ussi!<br>
                        √âv√©nements: ${data.Events.length}<br>
                        Dossiers: ${data.Cases.length}<br>
                        Clients: ${data.Clients.length}`, 'success');
                } else {
                    showResult(`‚ùå Erreur: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        async function deleteAllData() {
            if (!token) {
                showResult('Vous devez √™tre connect√©', 'error');
                return;
            }

            const finalConfirm = prompt('Tapez "SUPPRIMER" en majuscules pour confirmer la suppression d√©finitive:');
            if (finalConfirm !== 'SUPPRIMER') {
                showResult('Suppression annul√©e', 'warning');
                return;
            }

            try {
                showResult('‚è≥ Suppression en cours...', 'info');

                const response = await fetch('/api/gdpr/delete-all-data', {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (response.ok) {
                    showResult(`‚úÖ ${result.message}<br>
                        √âv√©nements supprim√©s: ${result.deletedEvents}<br>
                        Dossiers supprim√©s: ${result.deletedCases}<br>
                        Clients supprim√©s: ${result.deletedClients}`, 'success');
                    
                    // D√©connecter l'utilisateur apr√®s suppression
                    setTimeout(() => {
                        localStorage.removeItem('authToken');
                        window.location.href = '/demo.html';
                    }, 3000);
                } else {
                    showResult(`‚ùå Erreur: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        // Charger le rapport au d√©marrage
        if (token) {
            loadComplianceReport();
        } else {
            showResult('‚ö†Ô∏è Vous devez √™tre connect√© pour acc√©der aux fonctions RGPD. <a href="/demo.html">Se connecter</a>', 'warning');
        }
    </script>
</body>
</html>