// Prisma Schema pour PostgreSQL - Version Temporaire pour Migration
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum InformationUnitStatus {
  RECEIVED
  CLASSIFIED
  ANALYZED
  INCOMPLETE
  AMBIGUOUS
  HUMAN_ACTION_REQUIRED
  RESOLVED
  CLOSED
}

enum InformationUnitSource {
  EMAIL
  UPLOAD
  API
  MANUAL
  SCAN
  FAX
}

// ============================================
// NIVEAU 1 : SUPER ADMIN - GESTION PLATEFORME
// ============================================

model Plan {
  id          String  @id @default(uuid())
  name        String  @unique
  displayName String
  description String?

  priceMonthly Float
  priceYearly  Float
  currency     String @default("EUR")

  maxWorkspaces Int @default(1)
  maxDossiers   Int @default(100)
  maxClients    Int @default(20)
  maxStorageGb  Int @default(5)
  maxUsers      Int @default(5)

  aiAutonomyLevel   Int     @default(1)
  humanValidation   Boolean @default(true)
  advancedAnalytics Boolean @default(false)
  externalAiAccess  Boolean @default(false)

  prioritySupport Boolean @default(false)
  customBranding  Boolean @default(false)
  apiAccess       Boolean @default(false)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenants       Tenant[]
  subscriptions Subscription[]
}

model Tenant {
  id        String  @id @default(uuid())
  name      String
  subdomain String  @unique
  domain    String? @unique

  planId String
  plan   Plan   @relation(fields: [planId], references: [id])

  status      String    @default("active")
  trialEndsAt DateTime?

  billingEmail   String?
  billingAddress String?
  vatNumber      String?

  currentWorkspaces Int   @default(0)
  currentDossiers   Int   @default(0)
  currentClients    Int   @default(0)
  currentStorageGb  Float @default(0)
  currentUsers      Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users              User[]
  clients            Client[]
  dossiers           Dossier[]
  settings           TenantSettings?
  Subscription       Subscription?
  emails             Email[]
  workflowExecutions WorkflowExecution[]
  factures           Facture[]
  calendarEvents     CalendarEvent[]
  documents          Document[]

  @@index([planId])
}

model TenantSettings {
  id       String @id @default(uuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  ollamaEnabled Boolean @default(true)
  ollamaUrl     String  @default("http://localhost:11434")
  ollamaModel   String  @default("llama3.2:latest")

  emailEnabled Boolean @default(false)
  smtpHost     String?
  smtpPort     Int?
  smtpUser     String?
  smtpPass     String?

  maxDossiers  Int @default(100)
  maxUsers     Int @default(5)
  storageLimit Int @default(1000)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id       String @id @default(uuid())
  email    String @unique
  name     String
  password String

  role String

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  clientId String? @unique
  client   Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  avatar    String?
  phone     String?
  status    String    @default("active")
  lastLogin DateTime?

  language String @default("fr")
  timezone String @default("Europe/Paris")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  notifications   Notification[]
  calendarEvents  CalendarEvent[]
  documents       Document[]

  @@index([tenantId, email])
  @@index([role])
}

model Client {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  civilite     String?
  firstName    String
  lastName     String
  nomNaissance String?
  prenomUsuel  String?

  email            String
  emailSecondaire  String?
  phone            String?
  phoneSecondaire  String?
  telephoneUrgence String?

  dateOfBirth        DateTime?
  lieuNaissance      String?
  nationality        String?
  nationaliteOrigine String?

  address    String?
  codePostal String?
  ville      String?
  pays       String  @default("France")

  user User?

  passportNumber  String?
  passportExpiry  DateTime?
  passportCountry String?

  status String @default("actif")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dossiers       Dossier[]
  emails         Email[]
  factures       Facture[]
  calendarEvents CalendarEvent[]
  documents      Document[]

  @@unique([tenantId, email])
  @@index([tenantId, email])
  @@index([tenantId, status])
}

model Dossier {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  numero String

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  typeDossier        String
  articleCeseda      String?
  categorieJuridique String?

  statut   String @default("en_cours")
  priorite String @default("normale")
  phase    String @default("instruction")

  dateCreation       DateTime  @default(now())
  dateOuverture      DateTime?
  dateEcheance       DateTime?
  dateProchaineEtape DateTime?
  dateCloture        DateTime?

  juridiction       String?
  numeroJuridiction String?
  typeRecours       String?

  responsableId  String?
  collaborateurs String?

  objet       String?
  description String?
  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  emails         Email[]
  factures       Facture[]
  calendarEvents CalendarEvent[]
  documents      Document[]

  @@unique([tenantId, numero])
  @@index([tenantId, statut])
  @@index([clientId])
}

// ============================================
// FACTURATION
// ============================================

model Facture {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  clientId  String
  client    Client   @relation(fields: [clientId], references: [id])

  dossierId String?
  dossier   Dossier? @relation(fields: [dossierId], references: [id])

  numero        String
  reference     String?
  description   String?

  montantHT     Float
  tauxTVA       Float    @default(20)
  montantTVA    Float
  montantTTC    Float

  statut        String   @default("brouillon") // brouillon, envoyee, payee, en_retard, annulee
  
  dateEmission  DateTime @default(now())
  dateEcheance  DateTime
  datePaiement  DateTime?

  modePaiement  String?  // virement, cheque, carte, especes
  referencePayment String?

  notes         String?
  conditions    String?

  pdfUrl        String?
  stripeInvoiceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lignes    LigneFacture[]
  paiements Paiement[]

  @@unique([tenantId, numero])
  @@index([tenantId, statut])
  @@index([clientId])
  @@index([dateEcheance])
}

model LigneFacture {
  id        String  @id @default(uuid())
  factureId String
  facture   Facture @relation(fields: [factureId], references: [id], onDelete: Cascade)

  description String
  quantite    Float   @default(1)
  prixUnitaire Float
  montantHT   Float

  ordre       Int     @default(0)

  createdAt DateTime @default(now())

  @@index([factureId])
}

model Paiement {
  id        String   @id @default(uuid())
  factureId String
  facture   Facture  @relation(fields: [factureId], references: [id], onDelete: Cascade)

  montant   Float
  date      DateTime @default(now())
  mode      String   // virement, cheque, carte, especes
  reference String?
  notes     String?

  stripePaymentId String?

  createdAt DateTime @default(now())

  @@index([factureId])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      String   // email, workflow, facture, dossier, system
  title     String
  message   String
  data      String?  // JSON avec données additionnelles

  isRead    Boolean  @default(false)
  readAt    DateTime?

  priority  String   @default("normal") // low, normal, high, urgent

  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
}

// ============================================
// CALENDAR & EVENTS
// ============================================

model CalendarEvent {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  dossierId String?
  dossier   Dossier? @relation(fields: [dossierId], references: [id])

  clientId  String?
  client    Client?  @relation(fields: [clientId], references: [id])

  title     String
  description String?
  location  String?

  startDate DateTime
  endDate   DateTime
  allDay    Boolean  @default(false)

  type      String   @default("rdv") // rdv, audience, deadline, rappel, autre
  status    String   @default("confirmed") // confirmed, tentative, cancelled

  googleEventId String?
  outlookEventId String?

  reminders String?  // JSON array [{minutes: 30, type: 'email'}]
  
  isRecurring Boolean @default(false)
  recurrenceRule String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, startDate])
  @@index([userId])
  @@index([dossierId])
}

// ============================================
// DOCUMENTS & OCR
// ============================================

model Document {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  dossierId String?
  dossier   Dossier? @relation(fields: [dossierId], references: [id])

  clientId  String?
  client    Client?  @relation(fields: [clientId], references: [id])

  filename    String
  originalName String
  mimeType    String
  size        Int
  storageKey  String

  category    String?  // contrat, facture, identite, courrier, autre
  description String?

  ocrProcessed Boolean @default(false)
  ocrText      String?
  ocrConfidence Float?
  extractedData String? // JSON avec données extraites

  aiAnalyzed  Boolean @default(false)
  aiSummary   String?
  aiMetadata  String?  // JSON

  uploadedBy  String
  uploader    User     @relation(fields: [uploadedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([dossierId])
  @@index([clientId])
}

model Subscription {
  id       String @id @default(uuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId String
  plan   Plan   @relation(fields: [planId], references: [id])

  status String @default("active")

  billingCycle String @default("monthly")

  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  trialEnd           DateTime?
  canceledAt         DateTime?
  endedAt            DateTime?

  pricePerMonth Float
  currency      String @default("EUR")

  autoRenew Boolean @default(true)

  metadata String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([status])
}
// ============================================
// EMAIL & WORKFLOW MANAGEMENT
// ============================================

model Email {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  messageId   String?  @unique
  from        String
  to          String
  subject     String
  body        String
  htmlBody    String?
  preview     String?

  category    String   @default("general-inquiry")
  urgency     String   @default("medium")
  sentiment   String   @default("neutral")
  
  isRead      Boolean  @default(false)
  isStarred   Boolean  @default(false)
  isArchived  Boolean  @default(false)
  isProcessed Boolean  @default(false)

  aiAnalysis  String?  // JSON stockant l'analyse IA
  tags        String?  // JSON array de tags

  clientId    String?
  client      Client?  @relation(fields: [clientId], references: [id])
  
  dossierId   String?
  dossier     Dossier? @relation(fields: [dossierId], references: [id])

  receivedAt  DateTime @default(now())
  readAt      DateTime?
  processedAt DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workflows   WorkflowExecution[]
  attachments EmailAttachment[]

  @@index([tenantId, isProcessed])
  @@index([tenantId, category])
  @@index([from])
}

model EmailAttachment {
  id       String @id @default(uuid())
  emailId  String
  email    Email  @relation(fields: [emailId], references: [id], onDelete: Cascade)

  filename    String
  mimeType    String
  size        Int
  storageKey  String?
  
  createdAt DateTime @default(now())

  @@index([emailId])
}

model WorkflowExecution {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  workflowId   String
  workflowName String
  
  emailId      String?
  email        Email?   @relation(fields: [emailId], references: [id])

  status       String   @default("pending") // pending, running, completed, failed, cancelled
  currentStep  String?
  progress     Int      @default(0)

  triggerType  String   @default("email") // email, manual, scheduled, api
  triggerData  String?  // JSON

  steps        String?  // JSON array des étapes exécutées
  result       String?  // JSON résultat final
  error        String?

  startedAt    DateTime?
  completedAt  DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([tenantId, status])
  @@index([workflowId])
  @@index([emailId])
}

// ============================================
// WORKSPACE REASONING - IA AVOCAT
// ============================================

model WorkspaceReasoning {
  id        String   @id @default(uuid())
  tenantId  String
  
  name      String
  description String?
  
  status    String   @default("draft") // draft, active, resolved, closed
  locked    Boolean  @default(false)
  
  dossierId String?
  clientId  String?
  
  context   String?  // JSON contexte du raisonnement
  summary   String?
  
  createdBy String
  closedBy  String?
  closedAt  DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  proposedActions   ProposedAction[]
  reasoningTraces   ReasoningTrace[]
  missingElements   MissingElement[]
  transitions       ReasoningTransition[]

  @@index([tenantId])
  @@index([status])
}

model ProposedAction {
  id          String   @id @default(uuid())
  workspaceId String
  workspace   WorkspaceReasoning @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  type        String   // send_email, create_document, schedule_event, update_dossier, etc.
  content     String
  priority    String   @default("normal") // low, normal, high, urgent
  
  executed    Boolean  @default(false)
  executedBy  String?
  executedAt  DateTime?
  result      String?
  
  rejected    Boolean  @default(false)
  rejectedBy  String?
  rejectedAt  DateTime?
  rejectReason String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId])
  @@index([executed])
}

model ReasoningTrace {
  id          String   @id @default(uuid())
  workspaceId String
  workspace   WorkspaceReasoning @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  step        String
  explanation String
  data        String?  // JSON donnees additionnelles
  
  createdBy   String
  createdAt   DateTime @default(now())

  @@index([workspaceId])
  @@index([createdAt])
}

model MissingElement {
  id          String   @id @default(uuid())
  workspaceId String
  workspace   WorkspaceReasoning @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  type        String   // document, information, decision, action
  description String
  priority    String   @default("normal")
  
  resolved    Boolean  @default(false)
  resolvedBy  String?
  resolvedAt  DateTime?
  resolution  String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId])
  @@index([resolved])
}

model ReasoningTransition {
  id          String   @id @default(uuid())
  workspaceId String
  workspace   WorkspaceReasoning @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  fromStatus  String
  toStatus    String
  reason      String?
  
  triggeredBy String
  createdAt   DateTime @default(now())

  @@index([workspaceId])
}

// ============================================
// INFORMATION UNIT - Zero Ignored Information
// ============================================

model InformationUnit {
  id        String   @id @default(uuid())
  tenantId  String
  
  source        InformationUnitSource
  content       String
  contentHash   String   @unique
  
  currentStatus InformationUnitStatus @default(RECEIVED)
  
  sourceMetadata    String?  // JSON
  linkedWorkspaceId String?
  metadata          String?  // JSON
  
  lastStatusChangeBy String?
  lastStatusChangeAt DateTime?
  
  receivedAt    DateTime @default(now())
  classifiedAt  DateTime?
  analyzedAt    DateTime?
  resolvedAt    DateTime?
  closedAt      DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  statusHistory InformationStatusHistory[]
  proofs        Proof[]

  @@index([tenantId])
  @@index([currentStatus])
  @@index([contentHash])
}

// ============================================
// STATUS HISTORY - Historique statuts inalterable
// ============================================

model InformationStatusHistory {
  id          String   @id @default(uuid())
  unitId      String
  unit        InformationUnit @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  fromStatus  InformationUnitStatus?
  toStatus    InformationUnitStatus
  reason      String?
  
  changedBy   String
  changedAt   DateTime @default(now())
  
  // Horodatage cryptographique inalterable
  timestampHash String?  // SHA-256 du changement
  
  @@index([unitId])
  @@index([changedAt])
}

// ============================================
// AUDIT LOG - Journal d'audit complet
// ============================================

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
  APPROVE
  REJECT
  ESCALATE
  ARCHIVE
}

model AuditLog {
  id        String   @id @default(uuid())
  tenantId  String
  
  userId    String
  userEmail String
  userRole  String
  
  action    AuditAction
  entityType String   // Dossier, Client, Document, Email, etc.
  entityId  String
  
  oldValue  String?  // JSON - valeur avant modification
  newValue  String?  // JSON - valeur apres modification
  
  ipAddress String?
  userAgent String?
  
  // Horodatage inviolable
  timestamp DateTime @default(now())
  timestampHash String?  // SHA-256(action + entityId + timestamp + previousHash)
  previousLogId String?  // Chaine de blocs
  
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([action])
}

// ============================================
// LEGAL DEADLINE - Delais legaux CESEDA
// ============================================

enum DeadlineType {
  RECOURS_GRACIEUX       // 2 mois
  RECOURS_HIERARCHIQUE   // 2 mois
  RECOURS_CONTENTIEUX    // 2 mois TA
  APPEL                  // 1 mois CAA
  CASSATION              // 2 mois CE
  REPONSE_PREFECTURE     // Variable
  CONVOCATION_AUDIENCE   // Variable
  PRODUCTION_PIECES      // Fixe par juge
  EXECUTION_DECISION     // Variable
  OQTF                   // 30/90 jours
  RETENTION              // 48h/28j/45j/90j
  CUSTOM                 // Personnalise
}

enum DeadlineStatus {
  PENDING
  APPROACHING     // J-7
  URGENT          // J-3
  CRITICAL        // J-1
  OVERDUE
  COMPLETED
  CANCELLED
}

model LegalDeadline {
  id        String   @id @default(uuid())
  tenantId  String
  
  dossierId String
  clientId  String
  
  type      DeadlineType
  label     String
  description String?
  
  // Calcul automatique selon CESEDA
  referenceDate DateTime   // Date de notification/decision
  dueDate       DateTime   // Date limite calculee
  
  status    DeadlineStatus @default(PENDING)
  
  // Article de loi reference
  legalBasis    String?    // Ex: "L511-1 CESEDA"
  legalDays     Int?       // Nombre de jours legaux
  
  // Alertes
  alertJ7Sent   Boolean @default(false)
  alertJ3Sent   Boolean @default(false)
  alertJ1Sent   Boolean @default(false)
  
  // Completion
  completedAt   DateTime?
  completedBy   String?
  completionNote String?
  
  // Preuve de respect du delai
  proofId       String?
  
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  alerts        DeadlineAlert[]

  @@index([tenantId])
  @@index([dossierId])
  @@index([status])
  @@index([dueDate])
}

model DeadlineAlert {
  id          String   @id @default(uuid())
  deadlineId  String
  deadline    LegalDeadline @relation(fields: [deadlineId], references: [id], onDelete: Cascade)
  
  alertType   String   // J-7, J-3, J-1, OVERDUE
  sentAt      DateTime @default(now())
  sentTo      String   // userId ou email
  channel     String   // email, sms, notification, push
  
  acknowledged Boolean @default(false)
  acknowledgedAt DateTime?
  acknowledgedBy String?

  @@index([deadlineId])
}

// ============================================
// PROOF - Preuves et justificatifs
// ============================================

enum ProofType {
  DOCUMENT_RECEPTION
  DOCUMENT_ENVOI
  ACCUSE_RECEPTION
  DEPOT_RECOURS
  NOTIFICATION_DECISION
  AUDIENCE_PRESENCE
  SIGNATURE_ELECTRONIQUE
  HORODATAGE_CERTIFIE
  CAPTURE_EMAIL
  SCREENSHOT
  RAPPORT_IA
  AUTRE
}

enum ProofStatus {
  PENDING_VALIDATION
  VALIDATED
  REJECTED
  ARCHIVED
}

model Proof {
  id        String   @id @default(uuid())
  tenantId  String
  
  type      ProofType
  title     String
  description String?
  
  // Liens vers entites
  dossierId String?
  clientId  String?
  documentId String?
  informationUnitId String?
  informationUnit   InformationUnit? @relation(fields: [informationUnitId], references: [id])
  
  // Fichier de preuve
  fileStorageKey String?
  fileHash       String?   // SHA-256 du fichier
  fileMimeType   String?
  fileSize       Int?
  
  // Metadonnees de preuve
  proofDate      DateTime  // Date de la preuve (reception, envoi, etc.)
  capturedAt     DateTime @default(now())
  capturedBy     String
  
  // Validation
  status         ProofStatus @default(PENDING_VALIDATION)
  validatedBy    String?
  validatedAt    DateTime?
  rejectionReason String?
  
  // Horodatage cryptographique
  timestampHash  String?   // Preuve d'integrite
  chainPreviousId String?  // Lien vers preuve precedente (blockchain interne)
  
  // Metadonnees additionnelles
  metadata       String?   // JSON
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([dossierId])
  @@index([type])
  @@index([status])
  @@index([proofDate])
}

// ============================================
// LEGAL REFERENCE - Articles de loi
// ============================================

model LegalReference {
  id        String   @id @default(uuid())
  
  code      String   // CESEDA, Code Civil, CGCT, etc.
  article   String   // L313-11, R311-2, etc.
  version   String?  // Version en vigueur
  
  title     String
  content   String   // Texte de l'article
  summary   String?  // Resume IA
  
  // Applicabilite
  category  String   // titre_sejour, recours, asile, eloignement, etc.
  keywords  String?  // JSON array de mots-cles
  
  // Delais associes
  defaultDeadlineDays Int?
  deadlineType        String?  // franc, calendaire, ouvre
  
  // Source officielle
  legifrance_url String?
  eurlex_url     String?
  
  isActive  Boolean  @default(true)
  validFrom DateTime?
  validUntil DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([code, article, version])
  @@index([code])
  @@index([category])
  @@index([isActive])
}

// ============================================
// ARCHIVE POLICY - Politique RGPD
// ============================================

enum ArchiveStatus {
  ACTIVE
  PENDING_ARCHIVE
  ARCHIVED
  PENDING_DELETION
  DELETED
}

model ArchivePolicy {
  id        String   @id @default(uuid())
  tenantId  String
  
  entityType String   // Dossier, Client, Document, etc.
  entityId   String
  
  status     ArchiveStatus @default(ACTIVE)
  
  // Regles de retention
  retentionDays    Int       // Duree de conservation en jours
  retentionReason  String?   // Obligation legale, contrat, etc.
  
  // Dates cles
  lastAccessAt     DateTime?
  archiveAt        DateTime?  // Date prevue d'archivage
  deleteAt         DateTime?  // Date prevue de suppression
  
  // Actions realisees
  archivedAt       DateTime?
  archivedBy       String?
  deletedAt        DateTime?
  deletedBy        String?
  
  // Exceptions
  holdUntil        DateTime?  // Gel juridique
  holdReason       String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([entityType, entityId])
  @@index([tenantId])
  @@index([status])
  @@index([archiveAt])
  @@index([deleteAt])
}

// ============================================
// REPORT - Rapports generes
// ============================================

enum ReportType {
  DOSSIER_SUMMARY
  CLIENT_PORTFOLIO
  DEADLINE_STATUS
  FINANCIAL_STATEMENT
  AUDIT_TRAIL
  COMPLIANCE_CHECK
  AI_ANALYSIS
  CUSTOM
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
  ARCHIVED
}

model Report {
  id        String   @id @default(uuid())
  tenantId  String
  
  type      ReportType
  title     String
  description String?
  
  // Parametres de generation
  parameters String?  // JSON des filtres/options
  
  // Entites concernees
  dossierId String?
  clientId  String?
  
  // Periode couverte
  periodStart DateTime?
  periodEnd   DateTime?
  
  // Resultat
  status    ReportStatus @default(PENDING)
  fileStorageKey String?
  fileMimeType   String?  // PDF, Excel, etc.
  fileSize       Int?
  
  generatedAt DateTime?
  generatedBy String
  
  // Acces
  isPublic    Boolean @default(false)
  accessCount Int     @default(0)
  lastAccessAt DateTime?
  
  // Expiration
  expiresAt   DateTime?
  
  error       String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@index([dossierId])
}