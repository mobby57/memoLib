// Prisma Schema pour PostgreSQL - Version Temporaire pour Migration
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// NIVEAU 1 : SUPER ADMIN - GESTION PLATEFORME
// ============================================

model Plan {
  id          String  @id @default(uuid())
  name        String  @unique
  displayName String
  description String?

  priceMonthly Float
  priceYearly  Float
  currency     String @default("EUR")

  maxWorkspaces Int @default(1)
  maxDossiers   Int @default(100)
  maxClients    Int @default(20)
  maxStorageGb  Int @default(5)
  maxUsers      Int @default(5)

  aiAutonomyLevel   Int     @default(1)
  humanValidation   Boolean @default(true)
  advancedAnalytics Boolean @default(false)
  externalAiAccess  Boolean @default(false)

  prioritySupport Boolean @default(false)
  customBranding  Boolean @default(false)
  apiAccess       Boolean @default(false)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenants       Tenant[]
  subscriptions Subscription[]
}

model Tenant {
  id        String  @id @default(uuid())
  name      String
  subdomain String  @unique
  domain    String? @unique

  planId String
  plan   Plan   @relation(fields: [planId], references: [id])

  status      String    @default("active")
  trialEndsAt DateTime?

  billingEmail   String?
  billingAddress String?
  vatNumber      String?

  currentWorkspaces Int   @default(0)
  currentDossiers   Int   @default(0)
  currentClients    Int   @default(0)
  currentStorageGb  Float @default(0)
  currentUsers      Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users              User[]
  clients            Client[]
  dossiers           Dossier[]
  settings           TenantSettings?
  Subscription       Subscription?
  emails             Email[]
  workflowExecutions WorkflowExecution[]
  factures           Facture[]
  calendarEvents     CalendarEvent[]
  documents          Document[]

  @@index([planId])
}

model TenantSettings {
  id       String @id @default(uuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  ollamaEnabled Boolean @default(true)
  ollamaUrl     String  @default("http://localhost:11434")
  ollamaModel   String  @default("llama3.2:latest")

  emailEnabled Boolean @default(false)
  smtpHost     String?
  smtpPort     Int?
  smtpUser     String?
  smtpPass     String?

  maxDossiers  Int @default(100)
  maxUsers     Int @default(5)
  storageLimit Int @default(1000)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id       String @id @default(uuid())
  email    String @unique
  name     String
  password String

  role String

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  clientId String? @unique
  client   Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  avatar    String?
  phone     String?
  status    String    @default("active")
  lastLogin DateTime?

  language String @default("fr")
  timezone String @default("Europe/Paris")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  notifications   Notification[]
  calendarEvents  CalendarEvent[]
  documents       Document[]

  @@index([tenantId, email])
  @@index([role])
}

model Client {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  civilite     String?
  firstName    String
  lastName     String
  nomNaissance String?
  prenomUsuel  String?

  email            String
  emailSecondaire  String?
  phone            String?
  phoneSecondaire  String?
  telephoneUrgence String?

  dateOfBirth        DateTime?
  lieuNaissance      String?
  nationality        String?
  nationaliteOrigine String?

  address    String?
  codePostal String?
  ville      String?
  pays       String  @default("France")

  user User?

  passportNumber  String?
  passportExpiry  DateTime?
  passportCountry String?

  status String @default("actif")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dossiers       Dossier[]
  emails         Email[]
  factures       Facture[]
  calendarEvents CalendarEvent[]
  documents      Document[]

  @@unique([tenantId, email])
  @@index([tenantId, email])
  @@index([tenantId, status])
}

model Dossier {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  numero String

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  typeDossier        String
  articleCeseda      String?
  categorieJuridique String?

  statut   String @default("en_cours")
  priorite String @default("normale")
  phase    String @default("instruction")

  dateCreation       DateTime  @default(now())
  dateOuverture      DateTime?
  dateEcheance       DateTime?
  dateProchaineEtape DateTime?
  dateCloture        DateTime?

  juridiction       String?
  numeroJuridiction String?
  typeRecours       String?

  responsableId  String?
  collaborateurs String?

  objet       String?
  description String?
  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  emails         Email[]
  factures       Facture[]
  calendarEvents CalendarEvent[]
  documents      Document[]

  @@unique([tenantId, numero])
  @@index([tenantId, statut])
  @@index([clientId])
}

// ============================================
// FACTURATION
// ============================================

model Facture {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  clientId  String
  client    Client   @relation(fields: [clientId], references: [id])

  dossierId String?
  dossier   Dossier? @relation(fields: [dossierId], references: [id])

  numero        String
  reference     String?
  description   String?

  montantHT     Float
  tauxTVA       Float    @default(20)
  montantTVA    Float
  montantTTC    Float

  statut        String   @default("brouillon") // brouillon, envoyee, payee, en_retard, annulee
  
  dateEmission  DateTime @default(now())
  dateEcheance  DateTime
  datePaiement  DateTime?

  modePaiement  String?  // virement, cheque, carte, especes
  referencePayment String?

  notes         String?
  conditions    String?

  pdfUrl        String?
  stripeInvoiceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lignes    LigneFacture[]
  paiements Paiement[]

  @@unique([tenantId, numero])
  @@index([tenantId, statut])
  @@index([clientId])
  @@index([dateEcheance])
}

model LigneFacture {
  id        String  @id @default(uuid())
  factureId String
  facture   Facture @relation(fields: [factureId], references: [id], onDelete: Cascade)

  description String
  quantite    Float   @default(1)
  prixUnitaire Float
  montantHT   Float

  ordre       Int     @default(0)

  createdAt DateTime @default(now())

  @@index([factureId])
}

model Paiement {
  id        String   @id @default(uuid())
  factureId String
  facture   Facture  @relation(fields: [factureId], references: [id], onDelete: Cascade)

  montant   Float
  date      DateTime @default(now())
  mode      String   // virement, cheque, carte, especes
  reference String?
  notes     String?

  stripePaymentId String?

  createdAt DateTime @default(now())

  @@index([factureId])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      String   // email, workflow, facture, dossier, system
  title     String
  message   String
  data      String?  // JSON avec données additionnelles

  isRead    Boolean  @default(false)
  readAt    DateTime?

  priority  String   @default("normal") // low, normal, high, urgent

  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
}

// ============================================
// CALENDAR & EVENTS
// ============================================

model CalendarEvent {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  dossierId String?
  dossier   Dossier? @relation(fields: [dossierId], references: [id])

  clientId  String?
  client    Client?  @relation(fields: [clientId], references: [id])

  title     String
  description String?
  location  String?

  startDate DateTime
  endDate   DateTime
  allDay    Boolean  @default(false)

  type      String   @default("rdv") // rdv, audience, deadline, rappel, autre
  status    String   @default("confirmed") // confirmed, tentative, cancelled

  googleEventId String?
  outlookEventId String?

  reminders String?  // JSON array [{minutes: 30, type: 'email'}]
  
  isRecurring Boolean @default(false)
  recurrenceRule String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, startDate])
  @@index([userId])
  @@index([dossierId])
}

// ============================================
// DOCUMENTS & OCR
// ============================================

model Document {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  dossierId String?
  dossier   Dossier? @relation(fields: [dossierId], references: [id])

  clientId  String?
  client    Client?  @relation(fields: [clientId], references: [id])

  filename    String
  originalName String
  mimeType    String
  size        Int
  storageKey  String

  category    String?  // contrat, facture, identite, courrier, autre
  description String?

  ocrProcessed Boolean @default(false)
  ocrText      String?
  ocrConfidence Float?
  extractedData String? // JSON avec données extraites

  aiAnalyzed  Boolean @default(false)
  aiSummary   String?
  aiMetadata  String?  // JSON

  uploadedBy  String
  uploader    User     @relation(fields: [uploadedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([dossierId])
  @@index([clientId])
}

model Subscription {
  id       String @id @default(uuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId String
  plan   Plan   @relation(fields: [planId], references: [id])

  status String @default("active")

  billingCycle String @default("monthly")

  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  trialEnd           DateTime?
  canceledAt         DateTime?
  endedAt            DateTime?

  pricePerMonth Float
  currency      String @default("EUR")

  autoRenew Boolean @default(true)

  metadata String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([status])
}
// ============================================
// EMAIL & WORKFLOW MANAGEMENT
// ============================================

model Email {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  messageId   String?  @unique
  from        String
  to          String
  subject     String
  body        String
  htmlBody    String?
  preview     String?

  category    String   @default("general-inquiry")
  urgency     String   @default("medium")
  sentiment   String   @default("neutral")
  
  isRead      Boolean  @default(false)
  isStarred   Boolean  @default(false)
  isArchived  Boolean  @default(false)
  isProcessed Boolean  @default(false)

  aiAnalysis  String?  // JSON stockant l'analyse IA
  tags        String?  // JSON array de tags

  clientId    String?
  client      Client?  @relation(fields: [clientId], references: [id])
  
  dossierId   String?
  dossier     Dossier? @relation(fields: [dossierId], references: [id])

  receivedAt  DateTime @default(now())
  readAt      DateTime?
  processedAt DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workflows   WorkflowExecution[]
  attachments EmailAttachment[]

  @@index([tenantId, isProcessed])
  @@index([tenantId, category])
  @@index([from])
}

model EmailAttachment {
  id       String @id @default(uuid())
  emailId  String
  email    Email  @relation(fields: [emailId], references: [id], onDelete: Cascade)

  filename    String
  mimeType    String
  size        Int
  storageKey  String?
  
  createdAt DateTime @default(now())

  @@index([emailId])
}

model WorkflowExecution {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  workflowId   String
  workflowName String
  
  emailId      String?
  email        Email?   @relation(fields: [emailId], references: [id])

  status       String   @default("pending") // pending, running, completed, failed, cancelled
  currentStep  String?
  progress     Int      @default(0)

  triggerType  String   @default("email") // email, manual, scheduled, api
  triggerData  String?  // JSON

  steps        String?  // JSON array des étapes exécutées
  result       String?  // JSON résultat final
  error        String?

  startedAt    DateTime?
  completedAt  DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([tenantId, status])
  @@index([workflowId])
  @@index([emailId])
}