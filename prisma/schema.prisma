
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  avatar    String?
  role      Role     @default(USER)
  profile   Profile?
  
  emails    Email[]
  templates Template[]
  contacts  Contact[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("users")
}

model Profile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  accessibility AccessibilitySettings?
  preferences   UserPreferences?
  
  @@map("profiles")
}

model AccessibilitySettings {
  id        String  @id @default(cuid())
  profileId String  @unique
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  screenReader    Boolean @default(false)
  highContrast    Boolean @default(false)
  largeText       Boolean @default(false)
  ttsEnabled      Boolean @default(false)
  ttsSpeed        Float   @default(1.0)
  voiceControl    Boolean @default(false)
  
  @@map("accessibility_settings")
}

model UserPreferences {
  id        String  @id @default(cuid())
  profileId String  @unique
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  theme           String  @default("light")
  language        String  @default("fr")
  emailProvider   String  @default("gmail")
  autoSave        Boolean @default(true)
  notifications   Boolean @default(true)
  
  @@map("user_preferences")
}

model Email {
  id        String      @id @default(cuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  recipient String
  subject   String
  body      String      @db.Text
  status    EmailStatus @default(DRAFT)
  
  templateId String?
  template   Template? @relation(fields: [templateId], references: [id])
  
  sentAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  @@map("emails")
}

model Template {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name     String
  subject  String
  body     String @db.Text
  category String @default("general")
  
  emails Email[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("templates")
}

model Contact {
  id           String  @id @default(cuid())
  userId       String
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name         String
  email        String
  organization String?
  category     String  @default("general")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, email])
  @@map("contacts")
}

enum Role {
  USER
  ADMIN
}

enum EmailStatus {
  DRAFT
  SENT
  FAILED
  SCHEDULED
}

// ===== POSTAL SERVICE MODELS =====

model Postman {
  id            String   @id @default(cuid())
  employeeId    String   @unique
  name          String
  email         String   @unique
  phone         String?
  status        PostmanStatus @default(ACTIVE)
  
  // Performance metrics
  totalDeliveries     Int      @default(0)
  successfulDeliveries Int     @default(0)
  averageRating       Float    @default(0)
  
  deliveries    Delivery[]
  shifts        PostmanShift[]
  incidents     Incident[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("postmen")
}

model Route {
  id          String   @id @default(cuid())
  routeCode   String   @unique
  areaCode    String
  areaName    String
  description String?
  
  // Waze integration
  wazeRouteId String?
  estimatedDuration Int?  // minutes
  distance    Float?   // km
  
  // GeoJSON polygon for route area
  geoJson     String?  @db.Text
  
  deliveries  Delivery[]
  incidents   Incident[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("routes")
}

model Delivery {
  id            String   @id @default(cuid())
  trackingNumber String  @unique
  
  postmanId     String
  postman       Postman  @relation(fields: [postmanId], references: [id])
  
  routeId       String
  route         Route    @relation(fields: [routeId], references: [id])
  
  // Delivery details
  recipientName    String
  recipientAddress String
  recipientPhone   String?
  
  packageType      String   @default("letter")
  priority         Priority @default(NORMAL)
  status           DeliveryStatus @default(PENDING)
  
  // Timing
  deliveryDate     DateTime
  startedAt        DateTime?
  completedAt      DateTime?
  
  // Performance
  customerRating   Float?
  deliveryNotes    String?  @db.Text
  
  // Coordinates
  latitude         Float?
  longitude        Float?
  
  incidents        Incident[]
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([postmanId, deliveryDate])
  @@index([status, deliveryDate])
  @@map("deliveries")
}

model Incident {
  id          String   @id @default(cuid())
  
  postmanId   String
  postman     Postman  @relation(fields: [postmanId], references: [id])
  
  deliveryId  String?
  delivery    Delivery? @relation(fields: [deliveryId], references: [id])
  
  routeId     String?
  route       Route?   @relation(fields: [routeId], references: [id])
  
  // Incident details
  type        IncidentType
  severity    IncidentSeverity @default(MEDIUM)
  status      IncidentStatus @default(OPEN)
  
  title       String
  description String   @db.Text
  
  // Resolution
  resolvedAt  DateTime?
  resolution  String?  @db.Text
  rerouteApplied Boolean @default(false)
  
  // Location
  latitude    Float?
  longitude   Float?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([status, severity])
  @@index([postmanId, createdAt])
  @@map("incidents")
}

model PostmanShift {
  id          String   @id @default(cuid())
  
  postmanId   String
  postman     Postman  @relation(fields: [postmanId], references: [id])
  
  shiftDate   DateTime
  startTime   DateTime
  endTime     DateTime?
  
  // Performance
  plannedHours    Float
  actualHours     Float?
  overtimeHours   Float    @default(0)
  
  breakMinutes    Int      @default(0)
  deliveriesCount Int      @default(0)
  
  notes       String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([postmanId, shiftDate])
  @@map("postman_shifts")
}

enum PostmanStatus {
  ACTIVE
  ON_LEAVE
  INACTIVE
  SUSPENDED
}

enum DeliveryStatus {
  PENDING
  IN_PROGRESS
  DELIVERED
  FAILED
  RETURNED
  CANCELLED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum IncidentType {
  ROAD_CLOSURE
  TRAFFIC_JAM
  MISSING_PACKAGE
  WRONG_ADDRESS
  RECIPIENT_ABSENT
  VEHICLE_ISSUE
  WEATHER_DELAY
  SAFETY_CONCERN
  OTHER
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}
