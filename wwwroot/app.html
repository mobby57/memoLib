<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemoLib - Gestion Communications</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 14px; }
        
        .tabs { background: white; display: flex; border-bottom: 2px solid #e0e0e0; overflow-x: auto; }
        .tab { padding: 15px 25px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; white-space: nowrap; }
        .tab:hover { background: #f5f5f5; }
        .tab.active { border-bottom-color: #667eea; color: #667eea; font-weight: 600; }
        
        .content { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .panel { display: none; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .panel.active { display: block; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        
        .btn { padding: 12px 30px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .btn:hover { background: #5568d3; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .message-list { max-height: 500px; overflow-y: auto; }
        .message-item { padding: 15px; border-bottom: 1px solid #eee; }
        .message-item:hover { background: #f9f9f9; }
        .message-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .message-from { font-weight: 600; color: #667eea; }
        .message-date { font-size: 12px; color: #999; }
        .message-text { color: #666; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; }
        .stat-value { font-size: 32px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { opacity: 0.9; font-size: 14px; }
        
        .alert { padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        .help-box { background: #f0f7ff; border-left: 4px solid #667eea; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .help-box h3 { color: #667eea; margin-bottom: 10px; font-size: 16px; }
        .help-box ul { margin-left: 20px; }
        .help-box li { margin-bottom: 5px; color: #666; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìß MemoLib Platform</h1>
        <p>Gestion unifi√©e de toutes vos communications</p>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('inbox')">üì• Bo√Æte de r√©ception</div>
        <div class="tab" onclick="showTab('send')">üì§ Envoyer</div>
        <div class="tab" onclick="showTab('cases')">üìÅ Dossiers</div>
        <div class="tab" onclick="showTab('clients')">üë• Clients</div>
        <div class="tab" onclick="showTab('search')">üîç Recherche</div>
        <div class="tab" onclick="showTab('stats')">üìä Statistiques</div>
        <div class="tab" onclick="showTab('settings')">‚öôÔ∏è Param√®tres</div>
    </div>

    <div class="content">
        <!-- Inbox -->
        <div id="inbox" class="panel active">
            <h2>üì• Bo√Æte de r√©ception unifi√©e</h2>
            <div class="help-box">
                <h3>üí° Comment √ßa marche</h3>
                <ul>
                    <li>Tous vos messages (Email, SMS, WhatsApp, Signal) arrivent ici</li>
                    <li>Cliquez sur "Actualiser" pour voir les nouveaux messages</li>
                    <li>Les messages sont automatiquement transform√©s en dossiers</li>
                </ul>
            </div>
            <button class="btn" onclick="loadInbox()">üîÑ Actualiser</button>
            <div id="messageList" class="message-list"></div>
        </div>

        <!-- Send -->
        <div id="send" class="panel">
            <h2>üì§ Envoyer un message</h2>
            <div class="help-box">
                <h3>üí° Envoi multi-canaux</h3>
                <ul>
                    <li>Choisissez le canal (Email, SMS, WhatsApp, Signal)</li>
                    <li>Entrez le destinataire et votre message</li>
                    <li>Le message sera envoy√© automatiquement</li>
                </ul>
            </div>
            <div id="sendAlert"></div>
            <form onsubmit="sendMessage(event)">
                <div class="form-group">
                    <label>Canal</label>
                    <select id="sendChannel">
                        <option value="email">üìß Email</option>
                        <option value="sms">üì± SMS</option>
                        <option value="whatsapp">üí¨ WhatsApp</option>
                        <option value="signal">üîí Signal</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Destinataire</label>
                    <input type="text" id="sendTo" placeholder="email@example.com ou +33612345678" required>
                </div>
                <div class="form-group">
                    <label>Message</label>
                    <textarea id="sendText" placeholder="Votre message..." required></textarea>
                </div>
                <button type="submit" class="btn">üì§ Envoyer</button>
            </form>
        </div>

        <!-- Cases -->
        <div id="cases" class="panel">
            <h2>üìÅ Mes dossiers</h2>
            <div class="help-box">
                <h3>üí° Gestion des dossiers</h3>
                <ul>
                    <li>Chaque email devient automatiquement un dossier</li>
                    <li>Filtrez par statut (Ouvert, En cours, Ferm√©)</li>
                    <li>Cliquez sur un dossier pour voir les d√©tails</li>
                </ul>
            </div>
            <button class="btn" onclick="loadCases()">üîÑ Actualiser</button>
            <div id="casesList"></div>
        </div>

        <!-- Clients -->
        <div id="clients" class="panel">
            <h2>üë• Mes clients</h2>
            <div class="help-box">
                <h3>üí° Base clients</h3>
                <ul>
                    <li>Clients cr√©√©s automatiquement depuis les emails</li>
                    <li>Informations extraites automatiquement (t√©l√©phone, adresse)</li>
                    <li>Historique complet des √©changes</li>
                </ul>
            </div>
            <button class="btn" onclick="loadClients()">üîÑ Actualiser</button>
            <div id="clientsList"></div>
        </div>

        <!-- Search -->
        <div id="search" class="panel">
            <h2>üîç Recherche</h2>
            <div class="help-box">
                <h3>üí° Recherche intelligente</h3>
                <ul>
                    <li>Recherchez dans tous vos messages et dossiers</li>
                    <li>Recherche par mot-cl√©, client, date</li>
                    <li>R√©sultats instantan√©s</li>
                </ul>
            </div>
            <div class="form-group">
                <input type="text" id="searchQuery" placeholder="Rechercher..." onkeyup="if(event.key==='Enter')search()">
            </div>
            <button class="btn" onclick="search()">üîç Rechercher</button>
            <div id="searchResults"></div>
        </div>

        <!-- Stats -->
        <div id="stats" class="panel">
            <h2>üìä Statistiques</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statMessages">0</div>
                    <div class="stat-label">Messages re√ßus</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statCases">0</div>
                    <div class="stat-label">Dossiers actifs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statClients">0</div>
                    <div class="stat-label">Clients</div>
                </div>
            </div>
            <button class="btn" onclick="loadStats()">üîÑ Actualiser</button>
        </div>

        <!-- Settings -->
        <div id="settings" class="panel">
            <h2>‚öôÔ∏è Param√®tres</h2>
            <div class="help-box">
                <h3>üí° Configuration</h3>
                <ul>
                    <li>Email de monitoring : sarraboudjellal57@gmail.com</li>
                    <li>Signal : +33603983709</li>
                    <li>Secteur actuel : Configurable via change-sector.ps1</li>
                </ul>
            </div>
            <div class="form-group">
                <label>Email de monitoring</label>
                <input type="email" value="sarraboudjellal57@gmail.com" readonly>
            </div>
            <div class="form-group">
                <label>Num√©ro Signal</label>
                <input type="tel" value="+33603983709" readonly>
            </div>
            <div class="form-group">
                <label>Secteur</label>
                <select id="sectorSelect">
                    <option value="legal">‚öñÔ∏è Legal - Avocats</option>
                    <option value="medical">‚öïÔ∏è Medical - M√©decins</option>
                    <option value="consulting">üíº Consulting - Consultants</option>
                </select>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5078';
        let token = localStorage.getItem('token');

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        async function loadInbox() {
            try {
                const response = await fetch(`${API_URL}/api/gateway/inbox?limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const messages = await response.json();
                
                const html = messages.map(m => `
                    <div class="message-item">
                        <div class="message-header">
                            <span class="message-from">${m.from || 'Inconnu'}</span>
                            <span class="message-date">${new Date(m.date).toLocaleString()}</span>
                        </div>
                        <div class="message-text">${m.text || m.subject}</div>
                    </div>
                `).join('');
                
                document.getElementById('messageList').innerHTML = html || '<p>Aucun message</p>';
            } catch (error) {
                document.getElementById('messageList').innerHTML = '<p>Erreur de chargement</p>';
            }
        }

        async function sendMessage(event) {
            event.preventDefault();
            const channel = document.getElementById('sendChannel').value;
            const to = document.getElementById('sendTo').value;
            const text = document.getElementById('sendText').value;
            
            try {
                const response = await fetch(`${API_URL}/api/gateway/send`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ channel, to, text })
                });
                
                if (response.ok) {
                    document.getElementById('sendAlert').innerHTML = '<div class="alert alert-success">‚úÖ Message envoy√© !</div>';
                    document.getElementById('sendText').value = '';
                } else {
                    document.getElementById('sendAlert').innerHTML = '<div class="alert alert-error">‚ùå Erreur d\'envoi</div>';
                }
            } catch (error) {
                document.getElementById('sendAlert').innerHTML = '<div class="alert alert-error">‚ùå Erreur de connexion</div>';
            }
        }

        async function loadCases() {
            try {
                const response = await fetch(`${API_URL}/api/cases`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const cases = await response.json();
                
                const html = cases.map(c => `
                    <div class="message-item">
                        <div class="message-header">
                            <span class="message-from">${c.title}</span>
                            <span class="message-date">${c.status}</span>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('casesList').innerHTML = html || '<p>Aucun dossier</p>';
            } catch (error) {
                document.getElementById('casesList').innerHTML = '<p>Erreur de chargement</p>';
            }
        }

        async function loadClients() {
            try {
                const response = await fetch(`${API_URL}/api/client`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const clients = await response.json();
                
                const html = clients.map(c => `
                    <div class="message-item">
                        <div class="message-header">
                            <span class="message-from">${c.name || c.email}</span>
                            <span class="message-date">${c.email}</span>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('clientsList').innerHTML = html || '<p>Aucun client</p>';
            } catch (error) {
                document.getElementById('clientsList').innerHTML = '<p>Erreur de chargement</p>';
            }
        }

        async function loadStats() {
            document.getElementById('statMessages').textContent = '...';
            document.getElementById('statCases').textContent = '...';
            document.getElementById('statClients').textContent = '...';
        }

        // Auto-login pour d√©mo
        if (!token) {
            fetch(`${API_URL}/api/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: 'admin@memolib.local', password: 'Admin123!' })
            }).then(r => r.json()).then(data => {
                token = data.token;
                localStorage.setItem('token', token);
                loadInbox();
            });
        } else {
            loadInbox();
        }
    </script>
</body>
</html>
