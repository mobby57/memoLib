{% extends "base.html" %}

{% block title %}Templates - IA Poste Manager{% endblock %}

{% block content %}
<div class="templates-container">
    <div class="templates-header">
        <h1>ðŸ“„ Gestion des Templates</h1>
        <button onclick="showCreateModal()" class="btn btn-primary">
            âž• Nouveau Template
        </button>
    </div>
    
    <div class="templates-filters">
        <div class="filter-group">
            <select id="categoryFilter">
                <option value="">Toutes catÃ©gories</option>
                <option value="business">Professionnel</option>
                <option value="follow-up">Relance</option>
                <option value="auto-reply">RÃ©ponse auto</option>
                <option value="marketing">Marketing</option>
            </select>
        </div>
        
        <div class="search-group">
            <input type="text" id="searchTemplates" placeholder="ðŸ” Rechercher...">
        </div>
    </div>
    
    <div class="templates-grid" id="templatesGrid">
        <!-- Templates chargÃ©s dynamiquement -->
    </div>
</div>

<!-- Modal CrÃ©ation/Ã‰dition -->
<div id="templateModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Nouveau Template</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        
        <form id="templateForm">
            <div class="form-group">
                <label for="templateName">Nom du template :</label>
                <input type="text" id="templateName" required 
                       placeholder="Ex: Email de relance client">
            </div>
            
            <div class="form-group">
                <label for="templateCategory">CatÃ©gorie :</label>
                <select id="templateCategory" required>
                    <option value="business">Professionnel</option>
                    <option value="follow-up">Relance</option>
                    <option value="auto-reply">RÃ©ponse automatique</option>
                    <option value="marketing">Marketing</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="templateSubject">Objet :</label>
                <input type="text" id="templateSubject" 
                       placeholder="Objet de l'email">
            </div>
            
            <div class="form-group">
                <label for="templateContent">Contenu :</label>
                <textarea id="templateContent" rows="10" required 
                          placeholder="Contenu du template..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="templateVariables">Variables disponibles :</label>
                <div class="variables-tags">
                    <span class="variable-tag" onclick="insertVariable('{{nom}}')">{nom}</span>
                    <span class="variable-tag" onclick="insertVariable('{{entreprise}}')">{entreprise}</span>
                    <span class="variable-tag" onclick="insertVariable('{{date}}')">{date}</span>
                    <span class="variable-tag" onclick="insertVariable('{{montant}}')">{montant}</span>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" onclick="closeModal()" class="btn btn-secondary">
                    Annuler
                </button>
                <button type="submit" class="btn btn-primary">
                    Sauvegarder
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.templates-container {
    max-width: 1200px;
    margin: 0 auto;
}

.templates-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.templates-filters {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    padding: 1rem;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.filter-group select,
.search-group input {
    padding: 0.5rem;
    border: 2px solid #ddd;
    border-radius: 5px;
    min-width: 200px;
}

.templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
}

.template-card {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s;
}

.template-card:hover {
    transform: translateY(-3px);
}

.template-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
}

.template-category {
    background: #667eea;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
}

.template-actions {
    display: flex;
    gap: 0.5rem;
}

.template-content {
    color: #666;
    font-size: 0.9rem;
    line-height: 1.4;
    margin-bottom: 1rem;
    max-height: 100px;
    overflow: hidden;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 15px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.close {
    font-size: 2rem;
    cursor: pointer;
    color: #999;
}

.variables-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.variable-tag {
    background: #f8f9fa;
    border: 1px solid #ddd;
    padding: 0.25rem 0.5rem;
    border-radius: 3px;
    cursor: pointer;
    font-family: monospace;
    font-size: 0.9rem;
}

.variable-tag:hover {
    background: #e9ecef;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 2rem;
}
</style>

<script>
let templates = [];
let editingTemplate = null;

document.addEventListener('DOMContentLoaded', function() {
    loadTemplates();
    
    document.getElementById('categoryFilter').addEventListener('change', filterTemplates);
    document.getElementById('searchTemplates').addEventListener('input', filterTemplates);
});

async function loadTemplates() {
    try {
        const response = await fetch('/api/templates');
        const data = await response.json();
        templates = data.templates || [];
        renderTemplates();
    } catch (error) {
        console.error('Erreur chargement templates:', error);
    }
}

function renderTemplates() {
    const grid = document.getElementById('templatesGrid');
    
    if (templates.length === 0) {
        grid.innerHTML = '<p class="no-templates">Aucun template trouvÃ©</p>';
        return;
    }
    
    grid.innerHTML = templates.map(template => `
        <div class="template-card">
            <div class="template-header">
                <h3>${template.name}</h3>
                <span class="template-category">${getCategoryLabel(template.type)}</span>
            </div>
            
            <div class="template-content">
                ${template.content || 'Pas de contenu'}
            </div>
            
            <div class="template-actions">
                <button onclick="useTemplate(${template.id})" class="btn btn-info btn-sm">
                    Utiliser
                </button>
                <button onclick="editTemplate(${template.id})" class="btn btn-secondary btn-sm">
                    Ã‰diter
                </button>
                <button onclick="deleteTemplate(${template.id})" class="btn btn-danger btn-sm">
                    Supprimer
                </button>
            </div>
        </div>
    `).join('');
}

function getCategoryLabel(type) {
    const labels = {
        'business': 'Professionnel',
        'follow-up': 'Relance',
        'auto-reply': 'RÃ©ponse auto',
        'marketing': 'Marketing'
    };
    return labels[type] || type;
}

function showCreateModal() {
    editingTemplate = null;
    document.getElementById('modalTitle').textContent = 'Nouveau Template';
    document.getElementById('templateForm').reset();
    document.getElementById('templateModal').style.display = 'flex';
}

function editTemplate(id) {
    const template = templates.find(t => t.id === id);
    if (!template) return;
    
    editingTemplate = template;
    document.getElementById('modalTitle').textContent = 'Ã‰diter Template';
    document.getElementById('templateName').value = template.name;
    document.getElementById('templateCategory').value = template.type;
    document.getElementById('templateSubject').value = template.subject || '';
    document.getElementById('templateContent').value = template.content || '';
    document.getElementById('templateModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('templateModal').style.display = 'none';
}

function insertVariable(variable) {
    const textarea = document.getElementById('templateContent');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    
    textarea.value = text.substring(0, start) + variable + text.substring(end);
    textarea.focus();
    textarea.setSelectionRange(start + variable.length, start + variable.length);
}

document.getElementById('templateForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('templateName').value,
        type: document.getElementById('templateCategory').value,
        subject: document.getElementById('templateSubject').value,
        content: document.getElementById('templateContent').value
    };
    
    try {
        const response = await fetch('/api/templates', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            IAPosteManager.showNotification('Template sauvegardÃ© !', 'success');
            closeModal();
            loadTemplates();
        }
    } catch (error) {
        IAPosteManager.showNotification('Erreur sauvegarde', 'error');
    }
});

function useTemplate(id) {
    const template = templates.find(t => t.id === id);
    if (template) {
        // Rediriger vers composer avec template
        window.location.href = `/compose?template=${id}`;
    }
}

function deleteTemplate(id) {
    if (confirm('Supprimer ce template ?')) {
        templates = templates.filter(t => t.id !== id);
        renderTemplates();
        IAPosteManager.showNotification('Template supprimÃ©', 'success');
    }
}

function filterTemplates() {
    const category = document.getElementById('categoryFilter').value;
    const search = document.getElementById('searchTemplates').value.toLowerCase();
    
    let filtered = templates;
    
    if (category) {
        filtered = filtered.filter(t => t.type === category);
    }
    
    if (search) {
        filtered = filtered.filter(t => 
            t.name.toLowerCase().includes(search) ||
            (t.content && t.content.toLowerCase().includes(search))
        );
    }
    
    const originalTemplates = templates;
    templates = filtered;
    renderTemplates();
    templates = originalTemplates;
}
</script>
{% endblock %}