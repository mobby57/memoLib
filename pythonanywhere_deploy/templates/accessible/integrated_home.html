<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureVault Accessible - Accueil</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/accessible.css') }}">
    <style>
        .integration-banner {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.3);
        }
        
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #4a5568;
            font-size: 1.1em;
        }
        
        .switch-interface {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ed8936;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9em;
            box-shadow: 0 3px 10px rgba(237, 137, 54, 0.3);
        }
        
        .switch-interface:hover {
            background: #dd6b20;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Bouton pour basculer vers interface standard -->
        <button class="switch-interface" onclick="switchToStandard()" title="Basculer vers interface standard">
            ğŸ”„ Interface Standard
        </button>

        <!-- BanniÃ¨re d'intÃ©gration -->
        <div class="integration-banner">
            <h2>âœ… Interface Accessible IntÃ©grÃ©e</h2>
            <p>ConnectÃ© Ã  votre compte SecureVault principal</p>
        </div>

        <!-- Header principal -->
        <header class="header">
            <h1>ğŸ  Accueil Accessible</h1>
            <p>Bienvenue {{ user_name or 'Utilisateur' }} !</p>
            <button class="voice-btn" onclick="speakWelcome()" aria-label="Ã‰couter le message de bienvenue">
                ğŸ”Š Message de bienvenue
            </button>
        </header>

        <!-- Statistiques rapides -->
        <div class="quick-stats" id="quickStats">
            <div class="stat-card">
                <div class="stat-number" id="emailsSent">-</div>
                <div class="stat-label">Emails envoyÃ©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="successRate">-</div>
                <div class="stat-label">Taux de rÃ©ussite</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lastEmail">-</div>
                <div class="stat-label">Dernier envoi</div>
            </div>
        </div>

        <!-- Boutons principaux -->
        <main class="main-buttons">
            
            <!-- Bouton 1: CrÃ©er message intelligent -->
            <div class="big-button" onclick="createSmartMessage()" tabindex="0" role="button" aria-label="CrÃ©er un nouveau message avec IA intÃ©grÃ©e">
                <div class="button-icon">ğŸ§ </div>
                <div class="button-text">Message Intelligent</div>
                <div class="button-subtitle">IA intÃ©grÃ©e + Vocal</div>
            </div>

            <!-- Bouton 2: Envoi rapide -->
            <div class="big-button" onclick="quickSend()" tabindex="0" role="button" aria-label="Envoi rapide avec vos contacts">
                <div class="button-icon">âš¡</div>
                <div class="button-text">Envoi Rapide</div>
                <div class="button-subtitle">Contacts + Templates</div>
            </div>

            <!-- Bouton 3: Historique vocal -->
            <div class="big-button" onclick="voiceHistory()" tabindex="0" role="button" aria-label="Ã‰couter l'historique de vos emails">
                <div class="button-icon">ğŸ“š</div>
                <div class="button-text">Mon Historique</div>
                <div class="button-subtitle">Ã‰couter mes emails</div>
            </div>

        </main>

        <!-- Zone d'Ã©tat intÃ©grÃ©e -->
        <div class="status-zone" id="statusZone">
            <div class="status-text" id="statusText">PrÃªt Ã  utiliser toutes les fonctionnalitÃ©s</div>
        </div>

        <!-- ContrÃ´les vocaux amÃ©liorÃ©s -->
        <div class="voice-controls">
            <button class="voice-control" onclick="startVoiceCommand()" aria-label="Commande vocale globale">
                ğŸ¤ Commande Vocale
            </button>
            <button class="voice-control" onclick="readMyStats()" aria-label="Lire mes statistiques">
                ğŸ“Š Mes Stats
            </button>
            <button class="voice-control" onclick="toggleAdvancedHelp()" aria-label="Aide avancÃ©e">
                ğŸ“ Aide AvancÃ©e
            </button>
        </div>

        <!-- Zone d'aide avancÃ©e -->
        <div class="help-zone" id="advancedHelp" style="display: none;">
            <h3>ğŸ“ Aide AvancÃ©e - Interface IntÃ©grÃ©e</h3>
            <ul class="help-list">
                <li>ğŸ§  <strong>Message Intelligent :</strong> Utilise l'IA principale + reconnaissance vocale</li>
                <li>âš¡ <strong>Envoi Rapide :</strong> AccÃ¨s Ã  vos contacts et templates existants</li>
                <li>ğŸ“š <strong>Historique :</strong> Ã‰coute de tous vos emails prÃ©cÃ©dents</li>
                <li>ğŸ”„ <strong>Basculement :</strong> Retour vers interface standard Ã  tout moment</li>
                <li>ğŸ“Š <strong>Statistiques :</strong> DonnÃ©es synchronisÃ©es avec votre compte</li>
            </ul>
            <button class="action-btn" onclick="readAdvancedHelp()">ğŸ”Š Ã‰couter l'aide complÃ¨te</button>
        </div>

        <!-- Raccourcis d'accessibilitÃ© -->
        <div class="accessibility-shortcuts" style="position: fixed; bottom: 20px; left: 20px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 10px; font-size: 0.8em;">
            <div><strong>Raccourcis :</strong></div>
            <div>1 = Message â€¢ 2 = Envoi â€¢ 3 = Historique</div>
            <div>H = Aide â€¢ Ctrl+Espace = Vocal</div>
        </div>
    </div>

    <script>
        // Variables globales
        let userStats = {};

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadUserStats();
            setupAccessibilityFeatures();
            
            // Message de bienvenue automatique aprÃ¨s 2 secondes
            setTimeout(() => {
                speakWelcome();
            }, 2000);
        });

        // Chargement des statistiques utilisateur
        async function loadUserStats() {
            try {
                const response = await fetch('/accessible/api/user_stats');
                const data = await response.json();
                
                if (data.success) {
                    userStats = data;
                    updateStatsDisplay(data);
                }
            } catch (error) {
                console.error('Erreur chargement stats:', error);
                // Afficher des stats par dÃ©faut
                updateStatsDisplay({
                    emails_sent: 0,
                    success_rate: '100%',
                    last_email: 'Jamais'
                });
            }
        }

        function updateStatsDisplay(stats) {
            document.getElementById('emailsSent').textContent = stats.emails_sent || 0;
            document.getElementById('successRate').textContent = stats.success_rate || '100%';
            document.getElementById('lastEmail').textContent = stats.last_email || 'Jamais';
        }

        // Actions principales
        async function createSmartMessage() {
            await speakText("Ouverture du compositeur intelligent avec IA intÃ©grÃ©e.");
            updateStatus("Chargement compositeur intelligent...");
            window.location.href = '/accessible/compose';
        }

        async function quickSend() {
            await speakText("AccÃ¨s Ã  l'envoi rapide avec vos contacts.");
            updateStatus("Chargement envoi rapide...");
            window.location.href = '/accessible/quick-send';
        }

        async function voiceHistory() {
            await speakText("Chargement de votre historique d'emails.");
            updateStatus("Chargement historique...");
            window.location.href = '/accessible/history';
        }

        // Commandes vocales avancÃ©es
        async function startVoiceCommand() {
            try {
                await speakText("Commande vocale activÃ©e. Que voulez-vous faire ?");
                
                const response = await fetch('/api/listen', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (result.success && result.text) {
                    await processAdvancedVoiceCommand(result.text.toLowerCase());
                } else {
                    await speakText("Commande non reconnue. RÃ©essayez.");
                }
            } catch (error) {
                console.error('Erreur commande vocale:', error);
                await speakText("Erreur de reconnaissance vocale.");
            }
        }

        async function processAdvancedVoiceCommand(command) {
            if (command.includes('message') || command.includes('Ã©crire') || command.includes('intelligent')) {
                await createSmartMessage();
            } else if (command.includes('rapide') || command.includes('envoyer') || command.includes('contact')) {
                await quickSend();
            } else if (command.includes('historique') || command.includes('prÃ©cÃ©dent') || command.includes('ancien')) {
                await voiceHistory();
            } else if (command.includes('statistique') || command.includes('stats') || command.includes('nombre')) {
                await readMyStats();
            } else if (command.includes('aide') || command.includes('help')) {
                await toggleAdvancedHelp();
            } else if (command.includes('standard') || command.includes('normal') || command.includes('classique')) {
                await switchToStandard();
            } else {
                await speakText("Commandes disponibles : message intelligent, envoi rapide, historique, statistiques, aide, ou interface standard.");
            }
        }

        // Lecture des statistiques
        async function readMyStats() {
            const statsText = `Vos statistiques : ${userStats.emails_sent || 0} emails envoyÃ©s, ${userStats.success_rate || '100%'} de rÃ©ussite, dernier envoi ${userStats.last_email || 'jamais'}.`;
            await speakText(statsText);
        }

        // Messages vocaux
        async function speakWelcome() {
            const welcomeText = `Bienvenue dans SecureVault Accessible intÃ©grÃ©. Vous avez accÃ¨s Ã  toutes vos donnÃ©es. ${userStats.emails_sent || 0} emails envoyÃ©s avec ${userStats.success_rate || '100%'} de rÃ©ussite. Trois options : Message intelligent, Envoi rapide, ou Historique.`;
            await speakText(welcomeText);
        }

        function toggleAdvancedHelp() {
            const help = document.getElementById('advancedHelp');
            const isVisible = help.style.display !== 'none';
            help.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                speakText("Aide avancÃ©e affichÃ©e. Interface intÃ©grÃ©e avec toutes les fonctionnalitÃ©s de SecureVault.");
            }
        }

        async function readAdvancedHelp() {
            const helpText = `Interface accessible intÃ©grÃ©e Ã  SecureVault. Message intelligent utilise l'IA principale et la reconnaissance vocale. Envoi rapide accÃ¨de Ã  vos contacts existants. Historique permet d'Ã©couter tous vos emails prÃ©cÃ©dents. Vous pouvez basculer vers l'interface standard Ã  tout moment.`;
            await speakText(helpText);
        }

        // Basculement d'interface
        async function switchToStandard() {
            await speakText("Basculement vers l'interface standard.");
            window.location.href = '/switch_to_standard';
        }

        // Fonctions utilitaires
        async function speakText(text) {
            try {
                await fetch('/api/speak', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text: text})
                });
            } catch (error) {
                console.error('Erreur synthÃ¨se vocale:', error);
            }
        }

        function updateStatus(message) {
            const statusElement = document.getElementById('statusText');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        // Configuration accessibilitÃ©
        function setupAccessibilityFeatures() {
            // Navigation clavier
            document.addEventListener('keydown', function(e) {
                switch(e.key) {
                    case '1':
                        createSmartMessage();
                        break;
                    case '2':
                        quickSend();
                        break;
                    case '3':
                        voiceHistory();
                        break;
                    case 'h':
                    case 'H':
                        toggleAdvancedHelp();
                        break;
                    case 's':
                    case 'S':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            switchToStandard();
                        }
                        break;
                    case ' ':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            startVoiceCommand();
                        }
                        break;
                }
            });

            // Focus visible
            const focusableElements = document.querySelectorAll('button, [tabindex]');
            focusableElements.forEach(element => {
                element.addEventListener('focus', function() {
                    this.style.outline = '3px solid #667eea';
                    this.style.outlineOffset = '2px';
                });
                
                element.addEventListener('blur', function() {
                    this.style.outline = 'none';
                });
            });
        }

        // Gestion des erreurs
        window.addEventListener('error', function(e) {
            console.error('Erreur JavaScript:', e.error);
            speakText("Une erreur s'est produite. FonctionnalitÃ©s de base disponibles.");
        });
    </script>
</body>
</html>