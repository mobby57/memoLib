<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrÃ©er Message - SecureVault Accessible</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/accessible.css') }}">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ“ CrÃ©er votre message</h1>
            <button class="voice-btn" onclick="speakPage()">ğŸ”Š Ã‰couter</button>
        </header>

        <main class="creation-main">
            <!-- Mode vocal -->
            <div class="mode-section vocal-section">
                <h2>ğŸ¤ Parlez votre message</h2>
                <p>Cliquez et dÃ©crivez ce que vous voulez Ã©crire</p>
                
                <button class="big-action-btn" id="voiceBtn" onclick="startVoiceRecording()">
                    ğŸ¤ Commencer Ã  parler
                </button>
                
                <div id="voiceStatus" class="voice-status" style="display: none;">
                    <div class="status-indicator">ğŸ”´ Ã‰coute en cours...</div>
                </div>
                
                <div id="voiceResult" class="voice-result" style="display: none;">
                    <h3>Vous avez dit :</h3>
                    <div class="voice-text" id="voiceText"></div>
                    <button class="action-btn" onclick="generateFromVoice()">âœ¨ GÃ©nÃ©rer le message</button>
                </div>
            </div>

            <!-- SÃ©parateur -->
            <div class="separator"><span>OU</span></div>

            <!-- ModÃ¨les rapides -->
            <div class="mode-section templates-section">
                <h2>ğŸ“‹ ModÃ¨les rapides</h2>
                <p>Choisissez un type de message</p>
                
                <div class="template-grid">
                    <button class="template-card" onclick="useTemplate('demande')">
                        <div class="template-icon">ğŸ“Œ</div>
                        <div class="template-title">Demande d'information</div>
                        <div class="template-desc">Poser une question, demander des renseignements</div>
                    </button>
                    
                    <button class="template-card" onclick="useTemplate('plainte')">
                        <div class="template-icon">âš ï¸</div>
                        <div class="template-title">Signaler un problÃ¨me</div>
                        <div class="template-desc">Faire une rÃ©clamation, signaler un dysfonctionnement</div>
                    </button>
                    
                    <button class="template-card" onclick="useTemplate('confirmation')">
                        <div class="template-icon">âœ…</div>
                        <div class="template-title">Confirmer une prestation</div>
                        <div class="template-desc">Valider un travail effectuÃ©, confirmer une intervention</div>
                    </button>
                </div>
            </div>

            <!-- AperÃ§u du message gÃ©nÃ©rÃ© -->
            <div id="messagePreview" class="message-preview" style="display: none;">
                <h2>ğŸ“„ Votre message :</h2>
                <div class="preview-content">
                    <div class="preview-text" id="previewText"></div>
                    <div class="preview-actions">
                        <button class="action-btn" onclick="readMessage()">ğŸ”Š Ã‰couter le message</button>
                        <button class="action-btn" onclick="editMessage()">âœï¸ Modifier</button>
                    </div>
                </div>
                
                <div class="final-actions">
                    <button class="cancel-btn" onclick="resetMessage()">ğŸ”„ Recommencer</button>
                    <button class="validate-btn" onclick="validateMessage()">âœ… Valider ce message</button>
                </div>
            </div>
        </main>

        <!-- Navigation -->
        <div class="navigation-bar">
            <button class="nav-btn" onclick="goHome()">ğŸ  Accueil</button>
            <button class="nav-btn" onclick="toggleHelp()">â“ Aide</button>
        </div>

        <!-- Zone d'aide -->
        <div class="help-zone" id="helpZone" style="display: none;">
            <h3>â“ Comment crÃ©er un message</h3>
            <ul class="help-list">
                <li>ğŸ¤ <strong>Mode vocal :</strong> Cliquez sur "Commencer Ã  parler" et dÃ©crivez votre message naturellement</li>
                <li>ğŸ“‹ <strong>ModÃ¨les :</strong> Choisissez un type de message prÃ©dÃ©fini selon votre besoin</li>
                <li>ğŸ‘‚ <strong>Ã‰couter :</strong> Le message gÃ©nÃ©rÃ© sera lu Ã  voix haute pour validation</li>
                <li>âœï¸ <strong>Modifier :</strong> Vous pouvez ajuster le message avant de l'envoyer</li>
            </ul>
            <button class="action-btn" onclick="readHelp()">ğŸ”Š Ã‰couter l'aide</button>
        </div>
    </div>

    <script>
        let currentMessage = null;
        let isRecording = false;

        // Reconnaissance vocale
        async function startVoiceRecording() {
            const btn = document.getElementById('voiceBtn');
            const status = document.getElementById('voiceStatus');
            
            if (isRecording) return;
            
            isRecording = true;
            btn.textContent = 'â¹ï¸ ArrÃªter l\'enregistrement';
            status.style.display = 'block';
            
            await speakText("Parlez maintenant. DÃ©crivez votre message.");
            
            try {
                const response = await fetch('/api/listen', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (result.success && result.text) {
                    document.getElementById('voiceText').textContent = result.text;
                    document.getElementById('voiceResult').style.display = 'block';
                    await speakText("Message reÃ§u : " + result.text);
                } else {
                    await speakText("Aucun message dÃ©tectÃ©. RÃ©essayez.");
                }
            } catch (error) {
                console.error('Erreur reconnaissance vocale:', error);
                await speakText("Erreur lors de l'enregistrement. RÃ©essayez.");
            }
            
            isRecording = false;
            btn.textContent = 'ğŸ¤ Commencer Ã  parler';
            status.style.display = 'none';
        }

        // GÃ©nÃ©ration Ã  partir de la voix
        async function generateFromVoice() {
            const voiceText = document.getElementById('voiceText').textContent;
            
            if (!voiceText) return;
            
            await speakText("GÃ©nÃ©ration du message en cours...");
            
            try {
                const response = await fetch('/creer_message', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        mode: 'vocal',
                        contenu: voiceText
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentMessage = result.contenu_genere;
                    showMessagePreview(currentMessage);
                    await speakText("Message gÃ©nÃ©rÃ© avec succÃ¨s. Voulez-vous l'Ã©couter ?");
                } else {
                    await speakText("Erreur lors de la gÃ©nÃ©ration du message.");
                }
            } catch (error) {
                console.error('Erreur gÃ©nÃ©ration:', error);
                await speakText("Erreur lors de la gÃ©nÃ©ration.");
            }
        }

        // Utilisation de modÃ¨les
        async function useTemplate(templateType) {
            await speakText(`ModÃ¨le ${templateType} sÃ©lectionnÃ©.`);
            
            try {
                const response = await fetch('/creer_message', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        mode: 'modele',
                        modele: templateType
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentMessage = result.contenu_genere;
                    showMessagePreview(currentMessage);
                    await speakText("ModÃ¨le appliquÃ©. Voulez-vous l'Ã©couter ?");
                }
            } catch (error) {
                console.error('Erreur modÃ¨le:', error);
                await speakText("Erreur lors de l'application du modÃ¨le.");
            }
        }

        // Affichage de l'aperÃ§u
        function showMessagePreview(content) {
            document.getElementById('previewText').textContent = content;
            document.getElementById('messagePreview').style.display = 'block';
            
            // Scroll vers l'aperÃ§u
            document.getElementById('messagePreview').scrollIntoView({
                behavior: 'smooth'
            });
        }

        // Lecture du message
        async function readMessage() {
            if (currentMessage) {
                await speakText("Lecture du message : " + currentMessage);
            }
        }

        // Validation du message
        async function validateMessage() {
            if (currentMessage) {
                // Sauvegarder en session
                sessionStorage.setItem('currentMessage', currentMessage);
                await speakText("Message validÃ©. Retour Ã  l'accueil pour l'envoyer.");
                goHome();
            }
        }

        // Reset
        function resetMessage() {
            currentMessage = null;
            document.getElementById('messagePreview').style.display = 'none';
            document.getElementById('voiceResult').style.display = 'none';
            document.getElementById('voiceText').textContent = '';
            speakText("Remise Ã  zÃ©ro. Vous pouvez crÃ©er un nouveau message.");
        }

        // Navigation
        function goHome() {
            window.location.href = '/';
        }

        function toggleHelp() {
            const help = document.getElementById('helpZone');
            help.style.display = help.style.display === 'none' ? 'block' : 'none';
        }

        async function readHelp() {
            const helpText = "Pour crÃ©er un message : utilisez le mode vocal en cliquant sur commencer Ã  parler, ou choisissez un modÃ¨le prÃ©dÃ©fini. Le message sera gÃ©nÃ©rÃ© automatiquement et vous pourrez l'Ã©couter avant de le valider.";
            await speakText(helpText);
        }

        // Fonctions utilitaires
        async function speakText(text) {
            try {
                await fetch('/api/speak', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text: text})
                });
            } catch (error) {
                console.error('Erreur synthÃ¨se vocale:', error);
            }
        }

        function speakPage() {
            speakText("Page de crÃ©ation de message. Choisissez le mode vocal pour parler votre message, ou sÃ©lectionnez un modÃ¨le prÃ©dÃ©fini.");
        }

        // Auto-lecture au chargement
        window.addEventListener('load', function() {
            setTimeout(() => {
                speakText("CrÃ©ation de message. Parlez votre message ou choisissez un modÃ¨le.");
            }, 1000);
        });
    </script>
</body>
</html>