{% extends "base.html" %}

{% block title %}Contacts - IA Poste Manager{% endblock %}

{% block content %}
<div class="contacts-container">
    <div class="contacts-header">
        <h1>üë• Gestion des Contacts</h1>
        <div class="header-actions">
            <button onclick="showImportModal()" class="btn btn-info">
                üì• Importer CSV
            </button>
            <button onclick="showAddModal()" class="btn btn-primary">
                ‚ûï Nouveau Contact
            </button>
        </div>
    </div>
    
    <div class="contacts-stats">
        <div class="stat-card">
            <h3>Total Contacts</h3>
            <div class="stat-number" id="totalContacts">0</div>
        </div>
        
        <div class="stat-card">
            <h3>Clients</h3>
            <div class="stat-number" id="clientsCount">0</div>
        </div>
        
        <div class="stat-card">
            <h3>Prospects</h3>
            <div class="stat-number" id="prospectsCount">0</div>
        </div>
        
        <div class="stat-card">
            <h3>Partenaires</h3>
            <div class="stat-number" id="partnersCount">0</div>
        </div>
    </div>
    
    <div class="contacts-filters">
        <div class="filter-row">
            <div class="filter-group">
                <select id="typeFilter">
                    <option value="">Tous types</option>
                    <option value="client">Client</option>
                    <option value="prospect">Prospect</option>
                    <option value="partner">Partenaire</option>
                    <option value="supplier">Fournisseur</option>
                </select>
            </div>
            
            <div class="filter-group">
                <select id="statusFilter">
                    <option value="">Tous status</option>
                    <option value="active">Actif</option>
                    <option value="inactive">Inactif</option>
                    <option value="blocked">Bloqu√©</option>
                </select>
            </div>
            
            <div class="filter-group">
                <input type="text" id="searchContacts" placeholder="üîç Rechercher nom, email, entreprise...">
            </div>
            
            <div class="filter-group">
                <button onclick="exportContacts()" class="btn btn-secondary">
                    üì§ Exporter
                </button>
            </div>
        </div>
    </div>
    
    <div class="contacts-table-container">
        <table class="contacts-table">
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    </th>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>Entreprise</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Derni√®re Activit√©</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="contactsTableBody">
                <!-- Contacts charg√©s dynamiquement -->
            </tbody>
        </table>
    </div>
    
    <div class="bulk-actions" id="bulkActions" style="display: none;">
        <div class="bulk-actions-content">
            <span id="selectedCount">0 contact(s) s√©lectionn√©(s)</span>
            <div class="bulk-buttons">
                <button onclick="bulkEmail()" class="btn btn-info">üìß Envoyer Email</button>
                <button onclick="bulkExport()" class="btn btn-secondary">üì§ Exporter</button>
                <button onclick="bulkDelete()" class="btn btn-danger">üóëÔ∏è Supprimer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajout/√âdition Contact -->
<div id="contactModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="contactModalTitle">Nouveau Contact</h2>
            <span class="close" onclick="closeContactModal()">&times;</span>
        </div>
        
        <form id="contactForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="firstName">Pr√©nom *</label>
                    <input type="text" id="firstName" required>
                </div>
                
                <div class="form-group">
                    <label for="lastName">Nom *</label>
                    <input type="text" id="lastName" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="email">Email *</label>
                <input type="email" id="email" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="company">Entreprise</label>
                    <input type="text" id="company">
                </div>
                
                <div class="form-group">
                    <label for="position">Poste</label>
                    <input type="text" id="position">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="phone">T√©l√©phone</label>
                    <input type="tel" id="phone">
                </div>
                
                <div class="form-group">
                    <label for="contactType">Type *</label>
                    <select id="contactType" required>
                        <option value="client">Client</option>
                        <option value="prospect">Prospect</option>
                        <option value="partner">Partenaire</option>
                        <option value="supplier">Fournisseur</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea id="notes" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label for="tags">Tags (s√©par√©s par des virgules)</label>
                <input type="text" id="tags" placeholder="vip, urgent, nouveau">
            </div>
            
            <div class="modal-actions">
                <button type="button" onclick="closeContactModal()" class="btn btn-secondary">
                    Annuler
                </button>
                <button type="submit" class="btn btn-primary">
                    Sauvegarder
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Import CSV -->
<div id="importModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üì• Importer des Contacts</h2>
            <span class="close" onclick="closeImportModal()">&times;</span>
        </div>
        
        <div class="import-content">
            <div class="import-step">
                <h3>1. T√©l√©charger le mod√®le CSV</h3>
                <button onclick="downloadTemplate()" class="btn btn-info">
                    üìÑ T√©l√©charger mod√®le
                </button>
            </div>
            
            <div class="import-step">
                <h3>2. S√©lectionner votre fichier CSV</h3>
                <input type="file" id="csvFile" accept=".csv" onchange="previewCSV()">
            </div>
            
            <div class="import-step" id="previewStep" style="display: none;">
                <h3>3. Aper√ßu des donn√©es</h3>
                <div id="csvPreview"></div>
                
                <div class="import-actions">
                    <button onclick="importContacts()" class="btn btn-primary">
                        ‚úÖ Importer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.contacts-container {
    max-width: 1400px;
    margin: 0 auto;
}

.contacts-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.contacts-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.contacts-filters {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.contacts-table-container {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

.contacts-table {
    width: 100%;
    border-collapse: collapse;
}

.contacts-table th,
.contacts-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.contacts-table th {
    background: #f8f9fa;
    font-weight: bold;
}

.contacts-table tr:hover {
    background: #f8f9fa;
}

.type-badge,
.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
}

.type-client { background: #d4edda; color: #155724; }
.type-prospect { background: #fff3cd; color: #856404; }
.type-partner { background: #d1ecf1; color: #0c5460; }
.type-supplier { background: #e2e3e5; color: #383d41; }

.status-active { background: #d4edda; color: #155724; }
.status-inactive { background: #f8d7da; color: #721c24; }
.status-blocked { background: #e2e3e5; color: #383d41; }

.bulk-actions {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 1rem 2rem;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    z-index: 100;
}

.bulk-actions-content {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.bulk-buttons {
    display: flex;
    gap: 1rem;
}

.import-content {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.import-step {
    padding: 1rem;
    border: 2px dashed #ddd;
    border-radius: 10px;
}

.import-step h3 {
    margin-bottom: 1rem;
    color: #667eea;
}

#csvPreview {
    max-height: 200px;
    overflow: auto;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 1rem;
    background: #f8f9fa;
}

.import-actions {
    margin-top: 1rem;
}
</style>

<script>
let contacts = [];
let selectedContacts = [];
let editingContact = null;

document.addEventListener('DOMContentLoaded', function() {
    loadContacts();
    initializeFilters();
});

function loadContacts() {
    // Simulation donn√©es contacts
    contacts = [
        {
            id: 1,
            firstName: 'Jean',
            lastName: 'Dupont',
            email: 'jean.dupont@example.com',
            company: 'ACME Corp',
            position: 'Directeur',
            phone: '01 23 45 67 89',
            type: 'client',
            status: 'active',
            lastActivity: '2024-01-15',
            notes: 'Client important',
            tags: ['vip', 'priorit√©']
        },
        {
            id: 2,
            firstName: 'Marie',
            lastName: 'Martin',
            email: 'marie.martin@company.fr',
            company: 'Tech Solutions',
            position: 'Responsable Achats',
            phone: '01 98 76 54 32',
            type: 'prospect',
            status: 'active',
            lastActivity: '2024-01-10',
            notes: 'Int√©ress√©e par nos services',
            tags: ['nouveau', 'tech']
        }
    ];
    
    updateStats();
    renderContacts();
}

function updateStats() {
    document.getElementById('totalContacts').textContent = contacts.length;
    document.getElementById('clientsCount').textContent = contacts.filter(c => c.type === 'client').length;
    document.getElementById('prospectsCount').textContent = contacts.filter(c => c.type === 'prospect').length;
    document.getElementById('partnersCount').textContent = contacts.filter(c => c.type === 'partner').length;
}

function renderContacts() {
    const tbody = document.getElementById('contactsTableBody');
    
    tbody.innerHTML = contacts.map(contact => `
        <tr>
            <td>
                <input type="checkbox" value="${contact.id}" onchange="toggleContactSelection(${contact.id})">
            </td>
            <td>${contact.firstName} ${contact.lastName}</td>
            <td>${contact.email}</td>
            <td>${contact.company || '-'}</td>
            <td><span class="type-badge type-${contact.type}">${getTypeLabel(contact.type)}</span></td>
            <td><span class="status-badge status-${contact.status}">${getStatusLabel(contact.status)}</span></td>
            <td>${formatDate(contact.lastActivity)}</td>
            <td>
                <div class="action-buttons">
                    <button onclick="editContact(${contact.id})" class="btn btn-info btn-sm">
                        ‚úèÔ∏è √âditer
                    </button>
                    <button onclick="emailContact(${contact.id})" class="btn btn-secondary btn-sm">
                        üìß Email
                    </button>
                    <button onclick="deleteContact(${contact.id})" class="btn btn-danger btn-sm">
                        üóëÔ∏è
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function getTypeLabel(type) {
    const labels = {
        'client': 'Client',
        'prospect': 'Prospect',
        'partner': 'Partenaire',
        'supplier': 'Fournisseur'
    };
    return labels[type] || type;
}

function getStatusLabel(status) {
    const labels = {
        'active': 'Actif',
        'inactive': 'Inactif',
        'blocked': 'Bloqu√©'
    };
    return labels[status] || status;
}

function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('fr-FR');
}

function showAddModal() {
    editingContact = null;
    document.getElementById('contactModalTitle').textContent = 'Nouveau Contact';
    document.getElementById('contactForm').reset();
    document.getElementById('contactModal').style.display = 'flex';
}

function editContact(id) {
    const contact = contacts.find(c => c.id === id);
    if (!contact) return;
    
    editingContact = contact;
    document.getElementById('contactModalTitle').textContent = '√âditer Contact';
    
    // Remplir le formulaire
    document.getElementById('firstName').value = contact.firstName;
    document.getElementById('lastName').value = contact.lastName;
    document.getElementById('email').value = contact.email;
    document.getElementById('company').value = contact.company || '';
    document.getElementById('position').value = contact.position || '';
    document.getElementById('phone').value = contact.phone || '';
    document.getElementById('contactType').value = contact.type;
    document.getElementById('notes').value = contact.notes || '';
    document.getElementById('tags').value = contact.tags ? contact.tags.join(', ') : '';
    
    document.getElementById('contactModal').style.display = 'flex';
}

function closeContactModal() {
    document.getElementById('contactModal').style.display = 'none';
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll').checked;
    const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
    
    checkboxes.forEach(cb => {
        cb.checked = selectAll;
        toggleContactSelection(parseInt(cb.value), false);
    });
    
    updateBulkActions();
}

function toggleContactSelection(id, updateCheckbox = true) {
    if (selectedContacts.includes(id)) {
        selectedContacts = selectedContacts.filter(cid => cid !== id);
    } else {
        selectedContacts.push(id);
    }
    
    updateBulkActions();
}

function updateBulkActions() {
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedContacts.length > 0) {
        bulkActions.style.display = 'block';
        selectedCount.textContent = `${selectedContacts.length} contact(s) s√©lectionn√©(s)`;
    } else {
        bulkActions.style.display = 'none';
    }
}

function initializeFilters() {
    document.getElementById('typeFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('searchContacts').addEventListener('input', applyFilters);
}

function applyFilters() {
    // Logique de filtrage
    renderContacts();
}

function emailContact(id) {
    const contact = contacts.find(c => c.id === id);
    if (contact) {
        window.location.href = `/compose?to=${contact.email}&name=${contact.firstName} ${contact.lastName}`;
    }
}

function deleteContact(id) {
    if (confirm('Supprimer ce contact ?')) {
        contacts = contacts.filter(c => c.id !== id);
        updateStats();
        renderContacts();
        IAPosteManager.showNotification('Contact supprim√©', 'success');
    }
}

function exportContacts() {
    const csv = contacts.map(contact => 
        `"${contact.firstName}","${contact.lastName}","${contact.email}","${contact.company || ''}","${contact.type}","${contact.status}"`
    ).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'contacts.csv';
    a.click();
    
    IAPosteManager.showNotification('Contacts export√©s !', 'success');
}

function showImportModal() {
    document.getElementById('importModal').style.display = 'flex';
}

function closeImportModal() {
    document.getElementById('importModal').style.display = 'none';
}

function downloadTemplate() {
    const template = 'Pr√©nom,Nom,Email,Entreprise,Poste,T√©l√©phone,Type,Notes\nJean,Dupont,jean@example.com,ACME Corp,Directeur,0123456789,client,Notes exemple';
    
    const blob = new Blob([template], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'modele_contacts.csv';
    a.click();
}

document.getElementById('contactForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        company: document.getElementById('company').value,
        position: document.getElementById('position').value,
        phone: document.getElementById('phone').value,
        type: document.getElementById('contactType').value,
        notes: document.getElementById('notes').value,
        tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t)
    };
    
    if (editingContact) {
        // Mise √† jour
        Object.assign(editingContact, formData);
        IAPosteManager.showNotification('Contact mis √† jour !', 'success');
    } else {
        // Cr√©ation
        formData.id = Date.now();
        formData.status = 'active';
        formData.lastActivity = new Date().toISOString().split('T')[0];
        contacts.push(formData);
        IAPosteManager.showNotification('Contact cr√©√© !', 'success');
    }
    
    updateStats();
    renderContacts();
    closeContactModal();
});
</script>
{% endblock %}