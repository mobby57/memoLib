{% extends "base.html" %}

{% block title %}Historique - IA Poste Manager{% endblock %}

{% block content %}
<div class="history-container">
    <div class="history-header">
        <h1>üìä Historique des Emails</h1>
        <div class="header-actions">
            <button onclick="exportHistory()" class="btn btn-secondary">
                üì• Exporter
            </button>
            <button onclick="clearHistory()" class="btn btn-danger">
                üóëÔ∏è Vider
            </button>
        </div>
    </div>
    
    <div class="history-stats">
        <div class="stat-card">
            <h3>Total Envoy√©s</h3>
            <div class="stat-number" id="totalSent">0</div>
        </div>
        
        <div class="stat-card">
            <h3>Cette Semaine</h3>
            <div class="stat-number" id="weekSent">0</div>
        </div>
        
        <div class="stat-card">
            <h3>Taux Ouverture</h3>
            <div class="stat-number" id="openRate">0%</div>
        </div>
        
        <div class="stat-card">
            <h3>Taux R√©ponse</h3>
            <div class="stat-number" id="replyRate">0%</div>
        </div>
    </div>
    
    <div class="history-filters">
        <div class="filter-row">
            <div class="filter-group">
                <label>P√©riode :</label>
                <select id="periodFilter">
                    <option value="all">Toute p√©riode</option>
                    <option value="today">Aujourd'hui</option>
                    <option value="week">Cette semaine</option>
                    <option value="month">Ce mois</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Status :</label>
                <select id="statusFilter">
                    <option value="all">Tous</option>
                    <option value="sent">Envoy√©</option>
                    <option value="opened">Ouvert</option>
                    <option value="replied">R√©pondu</option>
                    <option value="failed">√âchec</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Recherche :</label>
                <input type="text" id="searchHistory" placeholder="Destinataire, objet...">
            </div>
        </div>
    </div>
    
    <div class="history-table-container">
        <table class="history-table" id="historyTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Destinataire</th>
                    <th>Objet</th>
                    <th>Status</th>
                    <th>Template</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="historyTableBody">
                <!-- Donn√©es charg√©es dynamiquement -->
            </tbody>
        </table>
    </div>
    
    <div class="pagination" id="pagination">
        <!-- Pagination g√©n√©r√©e dynamiquement -->
    </div>
</div>

<!-- Modal D√©tails Email -->
<div id="emailModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>üìß D√©tails de l'Email</h2>
            <span class="close" onclick="closeEmailModal()">&times;</span>
        </div>
        
        <div class="email-details" id="emailDetails">
            <!-- Contenu charg√© dynamiquement -->
        </div>
    </div>
</div>

<style>
.history-container {
    max-width: 1400px;
    margin: 0 auto;
}

.history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.history-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.history-filters {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.filter-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.filter-group label {
    font-weight: bold;
    color: #333;
}

.filter-group select,
.filter-group input {
    padding: 0.5rem;
    border: 2px solid #ddd;
    border-radius: 5px;
}

.history-table-container {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
}

.history-table th {
    background: #f8f9fa;
    padding: 1rem;
    text-align: left;
    font-weight: bold;
    border-bottom: 2px solid #dee2e6;
}

.history-table td {
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
}

.history-table tr:hover {
    background: #f8f9fa;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
}

.status-sent { background: #d4edda; color: #155724; }
.status-opened { background: #d1ecf1; color: #0c5460; }
.status-replied { background: #d1ecf1; color: #0c5460; }
.status-failed { background: #f8d7da; color: #721c24; }

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

.pagination {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 2rem;
}

.pagination button {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 5px;
}

.pagination button.active {
    background: #667eea;
    color: white;
}

.modal-large {
    width: 90%;
    max-width: 800px;
}

.email-details {
    display: grid;
    gap: 1rem;
}

.detail-section {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 5px;
}

.detail-section h4 {
    margin-bottom: 0.5rem;
    color: #667eea;
}
</style>

<script>
let emailHistory = [];
let currentPage = 1;
const itemsPerPage = 10;

document.addEventListener('DOMContentLoaded', function() {
    loadHistory();
    initializeFilters();
});

function loadHistory() {
    // Simulation donn√©es historique
    emailHistory = [
        {
            id: 1,
            date: '2024-01-15 14:30',
            recipient: 'client@example.com',
            subject: 'Relance facture #001',
            status: 'opened',
            template: 'Relance client',
            content: 'Bonjour, nous vous rappelons...'
        },
        {
            id: 2,
            date: '2024-01-15 10:15',
            recipient: 'prospect@company.com',
            subject: 'Proposition commerciale',
            status: 'sent',
            template: 'Email professionnel',
            content: 'Nous avons le plaisir...'
        }
    ];
    
    updateStats();
    renderHistory();
}

function updateStats() {
    document.getElementById('totalSent').textContent = emailHistory.length;
    document.getElementById('weekSent').textContent = emailHistory.filter(e => 
        new Date(e.date) > new Date(Date.now() - 7*24*60*60*1000)
    ).length;
    
    const opened = emailHistory.filter(e => e.status === 'opened').length;
    const replied = emailHistory.filter(e => e.status === 'replied').length;
    
    document.getElementById('openRate').textContent = 
        emailHistory.length ? Math.round((opened / emailHistory.length) * 100) + '%' : '0%';
    document.getElementById('replyRate').textContent = 
        emailHistory.length ? Math.round((replied / emailHistory.length) * 100) + '%' : '0%';
}

function renderHistory() {
    const tbody = document.getElementById('historyTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageItems = emailHistory.slice(startIndex, endIndex);
    
    tbody.innerHTML = pageItems.map(email => `
        <tr>
            <td>${formatDate(email.date)}</td>
            <td>${email.recipient}</td>
            <td>${email.subject}</td>
            <td><span class="status-badge status-${email.status}">${getStatusLabel(email.status)}</span></td>
            <td>${email.template}</td>
            <td>
                <div class="action-buttons">
                    <button onclick="viewEmail(${email.id})" class="btn btn-info btn-sm">
                        üëÅÔ∏è Voir
                    </button>
                    <button onclick="resendEmail(${email.id})" class="btn btn-secondary btn-sm">
                        üîÑ Renvoyer
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    
    renderPagination();
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
}

function getStatusLabel(status) {
    const labels = {
        'sent': 'Envoy√©',
        'opened': 'Ouvert',
        'replied': 'R√©pondu',
        'failed': '√âchec'
    };
    return labels[status] || status;
}

function renderPagination() {
    const totalPages = Math.ceil(emailHistory.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    
    let html = '';
    
    if (currentPage > 1) {
        html += `<button onclick="changePage(${currentPage - 1})">‚Äπ Pr√©c√©dent</button>`;
    }
    
    for (let i = 1; i <= totalPages; i++) {
        html += `<button onclick="changePage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
    }
    
    if (currentPage < totalPages) {
        html += `<button onclick="changePage(${currentPage + 1})">Suivant ‚Ä∫</button>`;
    }
    
    pagination.innerHTML = html;
}

function changePage(page) {
    currentPage = page;
    renderHistory();
}

function initializeFilters() {
    document.getElementById('periodFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('searchHistory').addEventListener('input', applyFilters);
}

function applyFilters() {
    // Logique de filtrage
    currentPage = 1;
    renderHistory();
}

function viewEmail(id) {
    const email = emailHistory.find(e => e.id === id);
    if (!email) return;
    
    document.getElementById('emailDetails').innerHTML = `
        <div class="detail-section">
            <h4>Informations</h4>
            <p><strong>Date:</strong> ${formatDate(email.date)}</p>
            <p><strong>Destinataire:</strong> ${email.recipient}</p>
            <p><strong>Objet:</strong> ${email.subject}</p>
            <p><strong>Status:</strong> <span class="status-badge status-${email.status}">${getStatusLabel(email.status)}</span></p>
        </div>
        
        <div class="detail-section">
            <h4>Contenu</h4>
            <div style="white-space: pre-wrap; line-height: 1.6;">${email.content}</div>
        </div>
        
        <div class="detail-section">
            <h4>Statistiques</h4>
            <p><strong>Template utilis√©:</strong> ${email.template}</p>
            <p><strong>Heure d'envoi:</strong> ${formatDate(email.date)}</p>
        </div>
    `;
    
    document.getElementById('emailModal').style.display = 'flex';
}

function closeEmailModal() {
    document.getElementById('emailModal').style.display = 'none';
}

function resendEmail(id) {
    if (confirm('Renvoyer cet email ?')) {
        IAPosteManager.showNotification('Email renvoy√© !', 'success');
    }
}

function exportHistory() {
    const csv = emailHistory.map(email => 
        `"${email.date}","${email.recipient}","${email.subject}","${email.status}","${email.template}"`
    ).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'historique_emails.csv';
    a.click();
    
    IAPosteManager.showNotification('Historique export√© !', 'success');
}

function clearHistory() {
    if (confirm('Vider tout l\'historique ? Cette action est irr√©versible.')) {
        emailHistory = [];
        updateStats();
        renderHistory();
        IAPosteManager.showNotification('Historique vid√©', 'success');
    }
}
</script>
{% endblock %}