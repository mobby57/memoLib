"""
load_test.py

Test de performance: pipeline avec 1000+ unit√©s
Objectif: >100 unit√©s/sec
"""

import random
import time
from datetime import datetime, timedelta

from analysis.pipelines.rules_engine import RuleEngine
from analysis.schemas.models import InformationUnitSchema, PriorityEnum


def generate_test_units(count: int = 100) -> list:
    """G√©n√©rer unit√©s de test r√©alistes"""
    sources = ["EMAIL", "UPLOAD", "API"]
    senders = ["tribunal@justice.fr", "admin@gouv.fr", "user@example.com"]

    content_templates = [
        "D√©cision de OQTF prononc√©e. D√©lai d'appel: 30 jours.",
        "Notification administrative. D√©lai de r√©ponse: 2 mois.",
        "Correspondance judiciaire. Audience pr√©vue: 15 jours.",
        "Courrier de demande de documents. D√©lai: 1 mois.",
        "Notification d'appel devant la CAA. D√©lai: 15 jours.",
    ]

    units = []
    for i in range(count):
        unit = InformationUnitSchema(
            id=f"bench-{i}",
            source=random.choice(sources),
            content=random.choice(content_templates),
            content_hash=f"hash_{i}",
            tenant_id="bench-tenant",
            received_at=datetime.now() - timedelta(days=random.randint(0, 30)),
            source_metadata={
                "sender_email": random.choice(senders),
                "client_id": f"client-{i % 10}",
            },
        )
        units.append(unit)

    return units


def benchmark_rule_engine(unit_count: int = 1000):
    """Benchmark le moteur de r√®gles"""
    print(f"\n{'='*60}")
    print(f"BENCHMARK: Pipeline avec {unit_count} unit√©s")
    print(f"{'='*60}")

    # G√©n√©rer les unit√©s
    print(f"\n1Ô∏è‚É£  G√©n√©ration de {unit_count} unit√©s...")
    start = time.time()
    units = generate_test_units(unit_count)
    gen_time = time.time() - start
    print(f"   ‚úÖ {unit_count} unit√©s g√©n√©r√©es en {gen_time:.2f}s")

    # Ex√©cuter le pipeline
    print(f"\n2Ô∏è‚É£  Ex√©cution du pipeline sur {unit_count} unit√©s...")
    engine = RuleEngine()

    start = time.time()
    results = []
    for unit in units:
        priority, rules, score = engine.apply_all_rules(unit)
        results.append(
            {"id": unit.id, "priority": priority, "rules": rules, "score": score}
        )

    pipeline_time = time.time() - start
    units_per_sec = unit_count / pipeline_time if pipeline_time > 0 else 0

    print(f"   ‚úÖ Pipeline ex√©cut√© en {pipeline_time:.2f}s")
    print(f"   üìä {units_per_sec:.1f} unit√©s/sec")

    # Statistiques des r√©sultats
    print(f"\n3Ô∏è‚É£  Analyse des r√©sultats...")
    priority_counts = {}
    for result in results:
        p = str(result["priority"])
        priority_counts[p] = priority_counts.get(p, 0) + 1

    print("\n   Distribution des priorit√©s:")
    for priority in [
        PriorityEnum.CRITICAL,
        PriorityEnum.HIGH,
        PriorityEnum.MEDIUM,
        PriorityEnum.LOW,
    ]:
        count = priority_counts.get(str(priority), 0)
        pct = (count / unit_count) * 100 if unit_count > 0 else 0
        bar = "‚ñà" * int(pct / 2)
        print(f"   {priority:8s}: {count:4d} ({pct:5.1f}%) {bar}")

    # R√©sultat final
    print(f"\n{'='*60}")
    print(f"R√âSULTATS:")
    print(f"{'='*60}")
    print(f"‚úÖ Unit√©s trait√©es: {unit_count}")
    print(f"‚è±Ô∏è  Temps total: {pipeline_time:.2f}s")
    print(f"üìä D√©bit: {units_per_sec:.1f} unit√©s/sec")
    print(f"üéØ Cible: >100 unit√©s/sec")

    if units_per_sec >= 100:
        print(f"‚úÖ PASS: Objectif de performance atteint!")
    else:
        print(f"‚ö†Ô∏è  ATTENTION: D√©bit inf√©rieur √† l'objectif")

    return {
        "unit_count": unit_count,
        "pipeline_time_seconds": pipeline_time,
        "units_per_second": units_per_sec,
        "priority_distribution": priority_counts,
    }


if __name__ == "__main__":
    # Tester avec diff√©rentes tailles
    for size in [100, 500, 1000]:
        try:
            result = benchmark_rule_engine(size)
        except Exception as e:
            print(f"‚ùå Erreur lors du test avec {size} unit√©s: {e}")
