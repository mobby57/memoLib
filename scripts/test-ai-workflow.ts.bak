/**
 * Script de test du workflow IA complet
 * Teste: Email ‚Üí Triage ‚Üí Analyse ‚Üí Formulaire ‚Üí Brouillon ‚Üí Validation
 */

import { getAIService } from '../lib/services/aiService';
import { AIActionType, AutonomyLevel } from '../types';

async function testWorkflow() {
  console.log('üöÄ D√©marrage du test du workflow IA complet\n');
  
  const aiService = getAIService();
  
  // ========================================
  // TEST 1: Triage d'email (ACTION GREEN)
  // ========================================
  console.log('üìß TEST 1: Triage d\'email');
  console.log('‚îÄ'.repeat(50));
  
  const emailContent = `
    Bonjour,
    
    Je souhaite r√©gulariser ma situation en France. Je suis arriv√© il y a 3 ans
    avec un visa touristique qui a expir√©. J'ai trouv√© un emploi stable et mon
    employeur est pr√™t √† m'aider avec les d√©marches.
    
    Pouvez-vous m'aider?
    
    Merci,
    Mohammed Ali
  `;
  
  try {
    const triageResult = await aiService.triageEmail(
      emailContent,
      'Demande de r√©gularisation'
    );
    
    console.log('‚úÖ R√©sultat du triage:');
    console.log(`   Type: ${triageResult.caseType}`);
    console.log(`   Urgence: ${triageResult.urgency}`);
    console.log(`   Niveau autonomie: ${triageResult.autonomyLevel}`);
    console.log(`   Confiance: ${triageResult.confidence}%`);
    console.log(`   Validation requise: ${triageResult.requiresValidation ? 'OUI' : 'NON'}`);
    console.log(`   Justification: ${triageResult.rationale}\n`);
  } catch (error) {
    console.error('‚ùå Erreur triage:', error);
  }
  
  // ========================================
  // TEST 2: Analyse de dossier (ACTION GREEN)
  // ========================================
  console.log('üìä TEST 2: Analyse de dossier');
  console.log('‚îÄ'.repeat(50));
  
  const caseDescription = `
    Client: Mohammed Ali
    Situation: Entr√©e avec visa touristique il y a 3 ans (expir√©)
    Emploi: CDI depuis 1 an dans le BTP
    Employeur: Pr√™t √† soutenir la r√©gularisation
    Documents: Passeport, contrat de travail, fiches de paie
  `;
  
  try {
    const analysisResult = await aiService.analyzeCaseType(caseDescription);
    
    console.log('‚úÖ R√©sultat de l\'analyse:');
    console.log(`   Type de dossier: ${analysisResult.caseType}`);
    console.log(`   Sous-cat√©gorie: ${analysisResult.subCategory}`);
    console.log(`   Complexit√©: ${analysisResult.complexity}`);
    console.log(`   D√©lai estim√©: ${analysisResult.estimatedDuration}`);
    console.log(`   Structure workspace:`);
    analysisResult.suggestedWorkspace.sections.forEach((section: any) => {
      console.log(`     - ${section}`);
    });
    console.log(`   Documents requis:`);
    analysisResult.requiredDocuments.forEach((doc: any) => {
      console.log(`     - ${doc}`);
    });
    console.log();
  } catch (error) {
    console.error('‚ùå Erreur analyse:', error);
  }
  
  // ========================================
  // TEST 3: G√©n√©ration de formulaire (ACTION ORANGE)
  // ========================================
  console.log('üìù TEST 3: G√©n√©ration de formulaire de collecte');
  console.log('‚îÄ'.repeat(50));
  
  try {
    const formResult = await aiService.generateCollectionForm(
      'R√©gularisation par le travail',
      {
        clientName: 'Mohammed Ali',
        hasEmployer: true,
        employmentDuration: '1 an'
      }
    );
    
    console.log('‚úÖ Formulaire g√©n√©r√©:');
    console.log(`   ID: ${formResult.formId}`);
    console.log(`   Validation requise: ${formResult.requiresValidation ? 'OUI' : 'NON'}`);
    console.log(`   Nombre de questions: ${formResult.form.fields.length}`);
    console.log(`   Premi√®res questions:`);
    formResult.form.fields.slice(0, 3).forEach((field: any) => {
      console.log(`     - ${field.label} (${field.type})`);
    });
    console.log();
  } catch (error) {
    console.error('‚ùå Erreur g√©n√©ration formulaire:', error);
  }
  
  // ========================================
  // TEST 4: G√©n√©ration de brouillon (ACTION ORANGE)
  // ========================================
  console.log('‚úâÔ∏è TEST 4: G√©n√©ration de brouillon d\'email');
  console.log('‚îÄ'.repeat(50));
  
  try {
    const draftResult = await aiService.generateDraft(
      'TEMPLATE_DOCUMENT_REQUEST',
      {
        clientName: 'Mohammed Ali',
        documents: 'titre de s√©jour, certificat de r√©sidence',
        deadline: '15 jours',
        contactEmail: 'contact@cabinet-avocat.fr'
      }
    );
    
    console.log('‚úÖ Brouillon g√©n√©r√©:');
    console.log(`   ID: ${draftResult.draftId}`);
    console.log(`   Template utilis√©: ${draftResult.templateId}`);
    console.log(`   Validation requise: ${draftResult.requiresValidation ? 'OUI' : 'NON'}`);
    console.log(`   Aper√ßu du contenu:`);
    console.log(`   "${draftResult.content.substring(0, 150)}..."`);
    console.log();
  } catch (error) {
    console.error('‚ùå Erreur g√©n√©ration brouillon:', error);
  }
  
  // ========================================
  // TEST 5: D√©tection d'alertes (ACTION ORANGE)
  // ========================================
  console.log('üö® TEST 5: D√©tection d\'alertes');
  console.log('‚îÄ'.repeat(50));
  
  const dossierData = {
    id: 'DOSS-2026-001',
    clientName: 'Mohammed Ali',
    type: 'R√©gularisation',
    echeance: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000), // Dans 5 jours
    missingDocuments: ['Passeport', 'Acte de naissance'],
    lastUpdate: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000) // Il y a 15 jours
  };
  
  try {
    const alertsResult = await aiService.detectAlerts(dossierData);
    
    console.log('‚úÖ Alertes d√©tect√©es:');
    alertsResult.forEach((alert: any, index: number) => {
      console.log(`   ${index + 1}. ${alert.message}`);
      console.log(`      S√©v√©rit√©: ${alert.severity}`);
      console.log(`      Actions sugg√©r√©es: ${alert.suggestedActions.join(', ')}`);
    });
    console.log();
  } catch (error) {
    console.error('‚ùå Erreur d√©tection alertes:', error);
  }
  
  // ========================================
  // TEST 6: Proposition d'options (ACTION RED)
  // ========================================
  console.log('üéØ TEST 6: Proposition d\'options strat√©giques');
  console.log('‚îÄ'.repeat(50));
  
  const context = {
    caseType: 'R√©gularisation par le travail',
    situation: 'Visa expir√© depuis 2 ans, CDI actuel',
    obstacles: ['D√©lai d√©pass√©', 'Pas de titre en cours']
  };
  
  try {
    const optionsResult = await aiService.proposeOptions(context);
    
    console.log('‚úÖ Options propos√©es:');
    optionsResult.options.forEach((option: any, index: number) => {
      console.log(`   ${index + 1}. ${option.title}`);
      console.log(`      ${option.description}`);
      console.log(`      Avantages: ${option.pros.join(', ')}`);
      console.log(`      Inconv√©nients: ${option.cons.join(', ')}`);
      console.log(`      Complexit√©: ${option.complexity}/10`);
    });
    console.log(`   ‚ö†Ô∏è Avertissement: ${optionsResult.disclaimer}`);
    console.log(`   Validation requise: ${optionsResult.requiresValidation ? 'OUI (OBLIGATOIRE)' : 'NON'}`);
    console.log();
  } catch (error) {
    console.error('‚ùå Erreur proposition options:', error);
  }
  
  // ========================================
  // R√âSUM√â DU TEST
  // ========================================
  console.log('üìä R√âSUM√â DU TEST');
  console.log('‚ïê'.repeat(50));
  console.log('‚úÖ Workflow complet test√© avec succ√®s');
  console.log('');
  console.log('Actions GREEN (automatiques):');
  console.log('  ‚úì Triage d\'email');
  console.log('  ‚úì Analyse de dossier');
  console.log('');
  console.log('Actions ORANGE (validation requise):');
  console.log('  ‚úì G√©n√©ration de formulaire');
  console.log('  ‚úì G√©n√©ration de brouillon');
  console.log('  ‚úì D√©tection d\'alertes');
  console.log('');
  console.log('Actions RED (d√©cision humaine OBLIGATOIRE):');
  console.log('  ‚úì Proposition d\'options strat√©giques');
  console.log('');
  console.log('üéâ Syst√®me de validation IA op√©rationnel!');
}

// Ex√©cuter le test
testWorkflow().catch(console.error);
