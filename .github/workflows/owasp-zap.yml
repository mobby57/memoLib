name: "ðŸ” OWASP ZAP Security Scan"

on:
  # Scan manuel ou aprÃ¨s dÃ©ploiement rÃ©ussi
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL to scan'
        required: false
        default: 'https://iapostemanager.pages.dev'
  schedule:
    - cron: '0 4 * * 1'  # Lundi 4h du matin - scan production
  # DÃ©sactivÃ© sur push/PR pour Ã©viter scans localhost
  # push:
  #   branches: [ main, develop ]
  # pull_request:
  #   branches: [ main ]

jobs:
  zap_scan:
    name: OWASP ZAP Production Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      issues: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set Target URL
      id: target
      run: |
        TARGET="${{ github.event.inputs.target_url || 'https://iapostemanager.pages.dev' }}"
        echo "url=$TARGET" >> $GITHUB_OUTPUT
        echo "ðŸŽ¯ Scanning: $TARGET"

    - name: Wait for deployment readiness
      run: |
        echo "â³ Waiting for Cloudflare deployment to be ready..."
        sleep 45
        echo "âœ… Deployment should be ready"

    - name: OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.13.0
      with:
        target: ${{ steps.target.outputs.url }}/api/health
        rules_file_name: '.zap/rules.conf'
        cmd_options: '-I -r zap-report.html -J zap-report.json'
        fail_action: false  # Ne pas bloquer le workflow
        allow_issue_writing: false
      continue-on-error: true

    - name: Upload ZAP Reports (HTML + JSON)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-security-report
        path: |
          zap-report.html
          zap-report.json
        retention-days: 30
        if-no-files-found: warn

    - name: Generate ZAP Summary
      if: always()
      run: |
        echo "# ðŸ” OWASP ZAP Security Scan" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Target:** ${{ steps.target.outputs.url }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** $([ -f zap-report.html ] && echo 'âœ… Scan completed' || echo 'âŒ Scan failed')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Download \`zap-security-report\` artifact" >> $GITHUB_STEP_SUMMARY
        echo "2. Open \`zap-report.html\` in browser" >> $GITHUB_STEP_SUMMARY
        echo "3. Review alerts and determine policy (see README)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Policy Options:**" >> $GITHUB_STEP_SUMMARY
        echo "- **Option A (Strict):** Fix all alerts" >> $GITHUB_STEP_SUMMARY
        echo "- **Option B (Pragmatic):** Configure .zap/rules.conf for accepted risks" >> $GITHUB_STEP_SUMMARY
        echo "- **Option C (Monitor):** Track trends over time" >> $GITHUB_STEP_SUMMARY
