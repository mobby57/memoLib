name: "ðŸ” OWASP ZAP Security Scan"

on:
  push:
    branches: [ main, develop, multitenant-render ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 4 * * 1'  # Lundi 4h du matin
  workflow_dispatch:

jobs:
  zap_scan:
    name: OWASP ZAP Baseline Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      issues: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build
      env:
        DATABASE_URL: "file:./dev.db"
        NEXTAUTH_SECRET: "test-secret-key-for-ci"
        NEXTAUTH_URL: "http://localhost:3000"

    - name: Start application
      run: |
        npm start &
        sleep 30
        for i in {1..10}; do
          if curl -f http://localhost:3000 2>/dev/null; then
            echo "App started"
            exit 0
          fi
          echo "Waiting for app... ($i/10)"
          sleep 3
        done
        echo "App failed to start"
        exit 1
      env:
        DATABASE_URL: "file:./dev.db"
        NEXTAUTH_SECRET: "test-secret-key-for-ci"
        NEXTAUTH_URL: "http://localhost:3000"

    - name: OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.13.0
      with:
        target: 'http://localhost:3000'
        rules_file_name: '.zap/rules.conf'
        cmd_options: '-I -r zap-report.html -J zap-report.json'
        fail_action: true
        allow_issue_writing: false
      continue-on-error: false

    - name: Upload ZAP Reports (HTML + JSON)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-security-report
        path: |
          zap-report.html
          zap-report.json
        retention-days: 30
        if-no-files-found: warn

    - name: Generate ZAP Summary
      if: always()
      run: |
        echo "# ðŸ” OWASP ZAP Security Scan" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Target:** http://localhost:3000" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** $([ -f zap-report.html ] && echo 'âœ… Scan completed' || echo 'âŒ Scan failed')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Download `zap-security-report` artifact" >> $GITHUB_STEP_SUMMARY
        echo "2. Open `zap-report.html` in browser" >> $GITHUB_STEP_SUMMARY
        echo "3. Review alerts and determine policy (see README)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Policy Options:**" >> $GITHUB_STEP_SUMMARY
        echo "- **Option A (Strict):** Fix all alerts" >> $GITHUB_STEP_SUMMARY
        echo "- **Option B (Pragmatic):** Approve known low-risk alerts + `-I` flag" >> $GITHUB_STEP_SUMMARY
        echo "- **Option C (Temporary):** Dev-only bypass with `continue-on-error: true`" >> $GITHUB_STEP_SUMMARY

    - name: Stop application
      if: always()
      run: pkill -f "next start" || true
