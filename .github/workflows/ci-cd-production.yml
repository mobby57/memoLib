# ============================================================================
# ðŸš€ CI/CD PRODUCTION - IA POSTE MANAGER
# ============================================================================
# Version 4.0 - SimplifiÃ© et Robuste
# ============================================================================

name: ðŸš€ Production CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        type: boolean
        default: false
      skip_tests:
        description: 'Skip tests'
        type: boolean
        default: false

env:
  NODE_VERSION: '20'
  ACTIONS_STEP_DEBUG: ${{ inputs.debug == true }}

jobs:
  # ============================================
  # BUILD & TEST (Single Job - More Reliable)
  # ============================================
  build-and-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    outputs:
      build_success: ${{ steps.build.outputs.success }}
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci --legacy-peer-deps
          echo "âœ… Dependencies installed"
          echo ""
          echo "ðŸ“‹ Installed packages (multichannel):"
          npm ls twilio 2>/dev/null || echo "twilio: checking..."
          npm ls openai 2>/dev/null || echo "openai: checking..."

      - name: ðŸ”§ Generate Prisma Client
        run: npx prisma generate

      - name: ðŸ§ª Run Tests
        if: inputs.skip_tests != true
        run: npm test -- --passWithNoTests --ci --maxWorkers=2
        env:
          CI: true
          NODE_ENV: test
        continue-on-error: true

      - name: ðŸ—ï¸ Build Next.js
        id: build
        run: |
          echo "ðŸ—ï¸ Building application..."
          npm run build
          
          if [ -d ".next" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Build successful!"
            ls -la .next/
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ Build failed - .next directory not found"
            exit 1
          fi
        env:
          NEXT_TELEMETRY_DISABLED: '1'
          NODE_ENV: production
          # Placeholders pour le build (les vraies valeurs sont sur Vercel)
          DATABASE_URL: 'postgresql://build:build@localhost:5432/build'
          NEXTAUTH_SECRET: 'build-time-secret-placeholder-32chars!'
          NEXTAUTH_URL: 'http://localhost:3000'

      - name: ðŸ“¤ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build-${{ github.sha }}
          path: .next/
          retention-days: 1
          if-no-files-found: error

  # ============================================
  # DEPLOY TO VERCEL
  # ============================================
  deploy:
    name: ðŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: build-and-test
    if: |
      github.ref == 'refs/heads/main' && 
      github.event_name == 'push' &&
      needs.build-and-test.outputs.build_success == 'true'
    timeout-minutes: 10
    
    environment:
      name: production
      url: https://iapostemanager.vercel.app
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸ”§ Generate Prisma Client
        run: npx prisma generate

      - name: ðŸ“¥ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build-${{ github.sha }}
          path: .next/

      - name: ðŸš€ Deploy to Vercel
        run: |
          echo "ðŸš€ Deploying to Vercel..."
          npm i -g vercel@latest
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: âœ… Health Check
        run: |
          echo "â³ Waiting for deployment to propagate..."
          sleep 15
          
          echo "ðŸ¥ Running health checks..."
          MAIN=$(curl -s -o /dev/null -w "%{http_code}" https://iapostemanager.vercel.app || echo "000")
          API=$(curl -s -o /dev/null -w "%{http_code}" https://iapostemanager.vercel.app/api/health || echo "000")
          AUTH=$(curl -s -o /dev/null -w "%{http_code}" https://iapostemanager.vercel.app/api/auth/providers || echo "000")
          
          echo "========================================"
          echo "ðŸŽ‰ DEPLOYMENT RESULTS"
          echo "========================================"
          echo "Main page:    $MAIN"
          echo "API Health:   $API"
          echo "Auth API:     $AUTH"
          echo "========================================"
          echo "ðŸ“ URL: https://iapostemanager.vercel.app"
          echo "ðŸ”— Commit: ${{ github.sha }}"
          echo "========================================"
          
          if [ "$MAIN" = "200" ]; then
            echo "âœ… Site is live!"
          else
            echo "âš ï¸ Site returned $MAIN (may need more time)"
          fi
        continue-on-error: true

  # ============================================
  # SUMMARY
  # ============================================
  summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy]
    if: always()
    timeout-minutes: 2
    
    steps:
      - name: ðŸ“Š Create Summary
        run: |
          echo "## ðŸš€ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Test | ${{ needs.build-and-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result == 'success' && 'âœ…' || (needs.deploy.result == 'skipped' && 'â­ï¸' || 'âŒ') }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¡ Multi-Channel Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- \`/api/webhooks/channel/email\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`/api/webhooks/channel/whatsapp\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`/api/webhooks/channel/sms\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`/api/webhooks/channel/slack\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`/api/webhooks/channel/teams\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production:** https://iapostemanager.vercel.app" >> $GITHUB_STEP_SUMMARY
