# ============================================================================
# ğŸš€ CI/CD PRODUCTION PIPELINE - IA POSTE MANAGER
# ============================================================================
# Version: 3.0 - Robust & Debug-Ready
# Pipeline multi-jobs avec debug intÃ©grÃ© et sÃ©paration claire
# ============================================================================

name: ğŸš€ Production CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean
      skip_tests:
        description: 'Skip tests (for hotfix)'
        required: false
        default: 'false'
        type: boolean

# Debug environment (activable via workflow_dispatch)
env:
  NODE_VERSION: '20'
  ACTIONS_STEP_DEBUG: ${{ github.event.inputs.debug_enabled == 'true' }}
  ACTIONS_RUNNER_DEBUG: ${{ github.event.inputs.debug_enabled == 'true' }}

jobs:
  # ========================================
  # 1ï¸âƒ£ SETUP & VALIDATION
  # ========================================
  setup:
    name: ğŸ“‹ Setup & Validate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    outputs:
      should_deploy: ${{ steps.check.outputs.deploy }}
      node_version: ${{ env.NODE_VERSION }}
      cache_key: ${{ steps.cache.outputs.key }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ” Debug Info
        if: env.ACTIONS_STEP_DEBUG == 'true'
        run: |
          echo "=== DEBUG MODE ENABLED ==="
          echo "GitHub Event: ${{ github.event_name }}"
          echo "GitHub Ref: ${{ github.ref }}"
          echo "GitHub SHA: ${{ github.sha }}"
          echo "Runner OS: ${{ runner.os }}"
          echo "Node Version: ${{ env.NODE_VERSION }}"
          env | sort
      
      - name: âœ… Validate Environment
        id: check
        run: |
          echo "ğŸ” Checking required files..."
          
          if [ ! -f "package.json" ]; then
            echo "âŒ package.json not found!"
            exit 1
          fi
          echo "âœ… package.json exists"
          
          if [ -f "prisma/schema.prisma" ]; then
            echo "âœ… Prisma schema exists"
          fi
          
          if [ "${{ github.ref }}" == "refs/heads/main" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
            echo "ğŸš€ Deployment will be triggered"
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No deployment (PR or non-main branch)"
          fi
      
      - name: ğŸ”‘ Generate Cache Key
        id: cache
        run: |
          key="deps-${{ hashFiles('**/package-lock.json') }}"
          echo "key=$key" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Cache key: $key"

  # ========================================
  # 2ï¸âƒ£ INSTALL DEPENDENCIES
  # ========================================
  install:
    name: ğŸ“¦ Install Dependencies
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node_version }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --legacy-peer-deps
          echo "âœ… Dependencies installed"
      
      - name: ğŸ”§ Generate Prisma Client
        run: |
          echo "ğŸ”§ Generating Prisma client..."
          npx prisma generate
          echo "âœ… Prisma client generated"
      
      - name: ğŸ’¾ Cache node_modules
        uses: actions/cache/save@v4
        with:
          path: |
            node_modules
            .next/cache
          key: ${{ needs.setup.outputs.cache_key }}

  # ========================================
  # 3ï¸âƒ£ TESTS (parallel with build)
  # ========================================
  tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: [setup, install]
    if: github.event.inputs.skip_tests != 'true'
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node_version }}
      
      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            .next/cache
          key: ${{ needs.setup.outputs.cache_key }}
      
      - name: ğŸ§ª Run Unit Tests
        run: |
          echo "ğŸ§ª Running tests..."
          npm test -- --passWithNoTests --ci --maxWorkers=2
        env:
          CI: true
          NODE_ENV: test

  # ========================================
  # 4ï¸âƒ£ SECURITY SCAN (parallel with build)
  # ========================================
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [setup, install]
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node_version }}
      
      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            .next/cache
          key: ${{ needs.setup.outputs.cache_key }}
      
      - name: ğŸ” NPM Audit
        run: npm audit --audit-level=high || true
        continue-on-error: true

  # ========================================
  # 5ï¸âƒ£ BUILD APPLICATION
  # ========================================
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: [setup, install]
    timeout-minutes: 15
    
    outputs:
      build_success: ${{ steps.build.outputs.success }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node_version }}
      
      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            .next/cache
          key: ${{ needs.setup.outputs.cache_key }}
      
      - name: ğŸ—ï¸ Build Next.js
        id: build
        run: |
          echo "ğŸ—ï¸ Building application..."
          npm run build
          
          if [ -d ".next" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Build successful!"
            du -sh .next/
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ Build failed"
            exit 1
          fi
        env:
          NEXT_TELEMETRY_DISABLED: 1
          NODE_ENV: production
          DATABASE_URL: file:./build.db
          NEXTAUTH_SECRET: build-time-secret-placeholder
          NEXTAUTH_URL: http://localhost:3000
      
      - name: ğŸ“¤ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build-${{ github.sha }}
          path: |
            .next/
            !.next/cache/
          retention-days: 1
          if-no-files-found: error

  # ========================================
  # 6ï¸âƒ£ DEPLOY TO VERCEL (Production)
  # ========================================
  deploy-vercel:
    name: ğŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [setup, build, tests, security]
    if: |
      always() &&
      needs.setup.outputs.should_deploy == 'true' &&
      needs.build.outputs.build_success == 'true' &&
      (needs.tests.result == 'success' || needs.tests.result == 'skipped') &&
      (needs.security.result == 'success' || needs.security.result == 'skipped')
    timeout-minutes: 10
    
    environment:
      name: production
      url: https://iapostemanager.vercel.app
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node_version }}
      
      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            .next/cache
          key: ${{ needs.setup.outputs.cache_key }}
      
      - name: ğŸ“¥ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build-${{ github.sha }}
          path: .next/
      
      - name: ğŸš€ Deploy to Vercel
        run: |
          echo "ğŸš€ Deploying to Vercel..."
          npx vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: âœ… Verify Deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          sleep 10
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://iapostemanager.vercel.app)
          echo "Site status: $STATUS"

  # ========================================
  # 7ï¸âƒ£ HEALTH CHECK
  # ========================================
  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: [deploy-vercel]
    if: needs.deploy-vercel.result == 'success'
    timeout-minutes: 5
    
    steps:
      - name: ğŸ¥ Health Check
        run: |
          echo "ğŸ¥ Running health checks..."
          
          MAIN=$(curl -s -o /dev/null -w "%{http_code}" https://iapostemanager.vercel.app)
          API=$(curl -s -o /dev/null -w "%{http_code}" https://iapostemanager.vercel.app/api/health)
          LOGIN=$(curl -s -o /dev/null -w "%{http_code}" https://iapostemanager.vercel.app/auth/login)
          
          echo "Main: $MAIN | API: $API | Login: $LOGIN"
          
          if [ "$MAIN" = "200" ]; then
            echo "âœ… Site is live!"
          fi
      
      - name: ğŸ“Š Summary
        run: |
          echo "========================================"
          echo "ğŸ‰ DEPLOYMENT COMPLETE"
          echo "ğŸ“ URL: https://iapostemanager.vercel.app"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "========================================"

  # ========================================
  # 8ï¸âƒ£ SUMMARY
  # ========================================
  summary:
    name: ğŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [setup, install, tests, security, build, deploy-vercel, health-check]
    if: always()
    timeout-minutes: 2
    
    steps:
      - name: ğŸ“Š Summary
        run: |
          echo "========================================"
          echo "ğŸ“Š PIPELINE RESULTS"
          echo "========================================"
          echo "Setup:    ${{ needs.setup.result }}"
          echo "Install:  ${{ needs.install.result }}"
          echo "Tests:    ${{ needs.tests.result || 'skipped' }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Build:    ${{ needs.build.result }}"
          echo "Deploy:   ${{ needs.deploy-vercel.result || 'skipped' }}"
          echo "Health:   ${{ needs.health-check.result || 'skipped' }}"
          echo "========================================"
