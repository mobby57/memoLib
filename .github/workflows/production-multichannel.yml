# ============================================
# WORKFLOW CI/CD PRODUCTION - MULTI-CANAL
# Backend s√©curis√© avec Azure Key Vault
# Audit, IA, RGPD - Ready for Law Firms
# ============================================

name: üöÄ Production Deploy - Multi-Channel

on:
  push:
    branches: [main, production]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '20.x'
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

jobs:
  # ============================================
  # √âTAPE 1 : S√âCURIT√â & QUALIT√â
  # ============================================
  security-scan:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîë Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          extra_args: --only-verified
      
      - name: üõ°Ô∏è Dependency vulnerability scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
      
      - name: üìã SAST Analysis
        uses: github/codeql-action/analyze@v3
        with:
          languages: javascript, typescript

  # ============================================
  # √âTAPE 2 : BUILD & TEST
  # ============================================
  build-test:
    name: üèóÔ∏è Build & Test
    runs-on: ubuntu-latest
    needs: security-scan
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: iapostemanager_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì• Install dependencies
        run: npm ci
      
      - name: üîß Generate Prisma client
        run: npx prisma generate
      
      - name: üìä Run database migrations
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/iapostemanager_test
        run: npx prisma migrate deploy
      
      - name: üß™ Run unit tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/iapostemanager_test
          REDIS_URL: redis://localhost:6379
          NEXTAUTH_SECRET: test-secret-for-ci
          NEXTAUTH_URL: http://localhost:3000
        run: npm run test:ci
      
      - name: üèóÔ∏è Build application
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/iapostemanager_test
          NEXTAUTH_SECRET: test-secret-for-ci
          NEXTAUTH_URL: http://localhost:3000
        run: npm run build
      
      - name: üì§ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .next/
            public/
            prisma/
            package.json
            package-lock.json
          retention-days: 1

  # ============================================
  # √âTAPE 3 : TESTS E2E MULTI-CANAL
  # ============================================
  e2e-tests:
    name: üß™ E2E Tests Multi-Channel
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'pull_request'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì• Install dependencies
        run: npm ci
      
      - name: üé≠ Install Playwright
        run: npx playwright install --with-deps
      
      - name: üì• Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: üß™ Run E2E tests
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_TEST }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        run: npx playwright test
      
      - name: üì§ Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # ============================================
  # √âTAPE 4 : D√âPLOIEMENT STAGING
  # ============================================
  deploy-staging:
    name: üöÄ Deploy Staging
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: staging
    
    steps:
      - uses: actions/checkout@v4
      
      - name: üîê Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: üîë Get secrets from Key Vault
        id: keyvault
        uses: azure/get-keyvault-secrets@v1
        with:
          keyvault: ${{ secrets.AZURE_KEYVAULT_NAME }}
          secrets: |
            DATABASE-URL-STAGING,
            NEXTAUTH-SECRET,
            OPENAI-API-KEY,
            TWILIO-ACCOUNT-SID,
            TWILIO-AUTH-TOKEN,
            WHATSAPP-VERIFY-TOKEN,
            WHATSAPP-ACCESS-TOKEN,
            SLACK-SIGNING-SECRET,
            SLACK-BOT-TOKEN,
            REDIS-URL-STAGING
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì• Install Vercel CLI
        run: npm i -g vercel@latest
      
      - name: üöÄ Deploy to Vercel (Staging)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
          vercel build --token=$VERCEL_TOKEN
          vercel deploy --prebuilt --token=$VERCEL_TOKEN
      
      - name: üîÑ Run database migrations (Staging)
        env:
          DATABASE_URL: ${{ steps.keyvault.outputs.DATABASE-URL-STAGING }}
        run: npx prisma migrate deploy

  # ============================================
  # √âTAPE 5 : D√âPLOIEMENT PRODUCTION
  # ============================================
  deploy-production:
    name: üöÄ Deploy Production
    runs-on: ubuntu-latest
    needs: [build-test, deploy-staging]
    if: github.ref == 'refs/heads/production' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: üîê Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: üîë Get ALL secrets from Key Vault
        id: keyvault
        uses: azure/get-keyvault-secrets@v1
        with:
          keyvault: ${{ secrets.AZURE_KEYVAULT_NAME }}
          secrets: |
            DATABASE-URL-PRODUCTION,
            NEXTAUTH-SECRET-PRODUCTION,
            NEXTAUTH-URL,
            OPENAI-API-KEY,
            AZURE-OPENAI-ENDPOINT,
            AZURE-OPENAI-KEY,
            TWILIO-ACCOUNT-SID,
            TWILIO-AUTH-TOKEN,
            TWILIO-WEBHOOK-URL,
            WHATSAPP-VERIFY-TOKEN,
            WHATSAPP-ACCESS-TOKEN,
            WHATSAPP-PHONE-NUMBER-ID,
            SLACK-SIGNING-SECRET,
            SLACK-BOT-TOKEN,
            TEAMS-APP-ID,
            TEAMS-APP-SECRET,
            REDIS-URL-PRODUCTION,
            STRIPE-SECRET-KEY,
            STRIPE-WEBHOOK-SECRET,
            GITHUB-CLIENT-ID,
            GITHUB-CLIENT-SECRET,
            EMAIL-SERVER,
            EMAIL-FROM
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì• Install dependencies
        run: npm ci
      
      - name: üì• Install Vercel CLI
        run: npm i -g vercel@latest
      
      - name: üîÑ Run database migrations (Production)
        env:
          DATABASE_URL: ${{ steps.keyvault.outputs.DATABASE-URL-PRODUCTION }}
        run: npx prisma migrate deploy
      
      - name: üöÄ Deploy to Vercel (Production)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          vercel build --prod --token=$VERCEL_TOKEN
          vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
      
      - name: ‚úÖ Post-deployment health check
        run: |
          echo "Waiting for deployment to propagate..."
          sleep 30
          
          # Health check
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://iapostemanager.vercel.app/api/health)
          if [ "$HEALTH_STATUS" != "200" ]; then
            echo "Health check failed with status $HEALTH_STATUS"
            exit 1
          fi
          echo "‚úÖ Health check passed"
          
          # Auth providers check
          AUTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://iapostemanager.vercel.app/api/auth/providers)
          if [ "$AUTH_STATUS" != "200" ]; then
            echo "Auth providers check failed with status $AUTH_STATUS"
            exit 1
          fi
          echo "‚úÖ Auth providers check passed"
          
          # Webhook endpoints check
          for CHANNEL in email whatsapp sms voice slack teams; do
            WEBHOOK_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://iapostemanager.vercel.app/api/webhooks/channel/$CHANNEL)
            echo "Webhook $CHANNEL: $WEBHOOK_STATUS"
          done
          echo "‚úÖ Webhook endpoints available"
      
      - name: üìä Create deployment annotation
        uses: actions/github-script@v7
        with:
          script: |
            const { data: deployment } = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              auto_merge: false,
              required_contexts: []
            });
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.id,
              state: 'success',
              environment_url: 'https://iapostemanager.vercel.app',
              description: 'Production deployment successful'
            });

  # ============================================
  # √âTAPE 6 : NOTIFICATION & MONITORING
  # ============================================
  notify:
    name: üì¢ Notify
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    
    steps:
      - name: üìß Send deployment notification
        if: needs.deploy-production.result == 'success'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚úÖ Production deployment successful",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üöÄ IA Poste Manager - Production Deployed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nProduction"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n‚úÖ Success"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*URL:*\nhttps://iapostemanager.vercel.app"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ github.sha }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Multi-Channel Features:*\n‚Ä¢ Email ‚úÖ\n‚Ä¢ WhatsApp ‚úÖ\n‚Ä¢ SMS ‚úÖ\n‚Ä¢ Voice ‚úÖ\n‚Ä¢ Slack ‚úÖ\n‚Ä¢ Teams ‚úÖ"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
      
      - name: üö® Send failure notification
        if: needs.deploy-production.result == 'failure'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚ùå Production deployment failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üö® IA Poste Manager - Deployment Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nProduction"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n‚ùå Failed"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Action Required:*\nCheck the <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|workflow logs>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # ============================================
  # √âTAPE 7 : AUDIT LOG
  # ============================================
  audit-log:
    name: üìã Audit Log
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: needs.deploy-production.result == 'success'
    
    steps:
      - name: üìù Create audit entry
        uses: actions/github-script@v7
        with:
          script: |
            const auditEntry = {
              timestamp: new Date().toISOString(),
              action: 'PRODUCTION_DEPLOYMENT',
              actor: {
                type: 'CI_CD',
                name: 'GitHub Actions',
                triggeredBy: '${{ github.actor }}'
              },
              details: {
                sha: '${{ github.sha }}',
                ref: '${{ github.ref }}',
                runId: '${{ github.run_id }}',
                environment: 'production',
                features: [
                  'multi-channel-backend',
                  'ai-processing',
                  'audit-trail',
                  'rgpd-compliance'
                ]
              }
            };
            
            console.log('Audit Entry:', JSON.stringify(auditEntry, null, 2));
            
            // Store in deployment notes
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `## üìã Deployment Audit Log\n\n\`\`\`json\n${JSON.stringify(auditEntry, null, 2)}\n\`\`\``
            });
