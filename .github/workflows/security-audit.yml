name: "üîí Security Audit"

on:
  schedule:
    - cron: '0 0 1 * *'  # 1er de chaque mois √† minuit
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'package.json'
      - 'package-lock.json'

jobs:
  audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit (production)
      id: audit-prod
      run: |
        echo "## üîí Production Dependencies Audit" >> $GITHUB_STEP_SUMMARY
        npm audit --production --json > audit-prod.json || true
        PROD_VULNS=$(jq '.metadata.vulnerabilities | to_entries | map(select(.value > 0)) | length' audit-prod.json)
        echo "prod_vulns=$PROD_VULNS" >> $GITHUB_OUTPUT
        echo "**Vulnerabilities found:** $PROD_VULNS" >> $GITHUB_STEP_SUMMARY

    - name: Run security audit (all)
      id: audit-all
      run: |
        echo "## üîç All Dependencies Audit" >> $GITHUB_STEP_SUMMARY
        npm audit --json > audit-all.json || true
        ALL_VULNS=$(jq '.metadata.vulnerabilities | to_entries | map(select(.value > 0)) | length' audit-all.json)
        echo "all_vulns=$ALL_VULNS" >> $GITHUB_OUTPUT
        echo "**Vulnerabilities found:** $ALL_VULNS" >> $GITHUB_STEP_SUMMARY

    - name: Check production vulnerabilities
      if: steps.audit-prod.outputs.prod_vulns != '0'
      run: |
        echo "‚ö†Ô∏è Production vulnerabilities detected!"
        npm audit --production
        exit 1

    - name: Upload audit reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-reports
        path: |
          audit-prod.json
          audit-all.json
        retention-days: 90

    - name: Create issue if vulnerabilities found
      if: failure() && steps.audit-prod.outputs.prod_vulns != '0'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const audit = JSON.parse(fs.readFileSync('audit-prod.json', 'utf8'));
          
          const body = `## üö® Security Vulnerabilities Detected
          
          **Production dependencies have security vulnerabilities!**
          
          ### Summary
          - Critical: ${audit.metadata.vulnerabilities.critical || 0}
          - High: ${audit.metadata.vulnerabilities.high || 0}
          - Moderate: ${audit.metadata.vulnerabilities.moderate || 0}
          - Low: ${audit.metadata.vulnerabilities.low || 0}
          
          ### Action Required
          Run \`npm audit fix\` to resolve these issues.
          
          **Audit Date:** ${new Date().toISOString()}
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'üö® Security Audit: Production Vulnerabilities Detected',
            body: body,
            labels: ['security', 'dependencies']
          });
