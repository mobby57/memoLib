name: Cleanup GitHub Actions Caches

on:
  pull_request:
    types:
      - closed
  workflow_dispatch:
    inputs:
      delete_all:
        description: 'Delete ALL caches (not just PR caches)'
        required: false
        default: 'false'
        type: boolean

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Cleanup PR caches
        if: github.event_name == 'pull_request'
        run: |
          echo "üßπ Fetching caches for PR #${{ github.event.pull_request.number }}"
          
          cacheKeysForPR=$(gh cache list --ref refs/pull/${{ github.event.pull_request.number }}/merge --limit 100 --json id --jq '.[].id')
          
          if [ -z "$cacheKeysForPR" ]; then
            echo "‚úÖ No caches found for this PR"
            exit 0
          fi
          
          set +e
          echo "üóëÔ∏è Deleting caches..."
          for cacheKey in $cacheKeysForPR; do
            gh cache delete $cacheKey && echo "  ‚úì Deleted: $cacheKey"
          done
          echo "‚úÖ Done"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      - name: Cleanup ALL caches (manual trigger)
        if: github.event_name == 'workflow_dispatch' && inputs.delete_all == 'true'
        run: |
          echo "üßπ Fetching ALL caches..."
          
          cacheKeys=$(gh cache list --limit 100 --json id --jq '.[].id')
          
          if [ -z "$cacheKeys" ]; then
            echo "‚úÖ No caches found"
            exit 0
          fi
          
          set +e
          echo "üóëÔ∏è Deleting all caches..."
          for cacheKey in $cacheKeys; do
            gh cache delete $cacheKey && echo "  ‚úì Deleted: $cacheKey"
          done
          
          # Continue if more than 100 caches
          while true; do
            remaining=$(gh cache list --limit 100 --json id --jq '.[].id')
            if [ -z "$remaining" ]; then
              break
            fi
            for cacheKey in $remaining; do
              gh cache delete $cacheKey && echo "  ‚úì Deleted: $cacheKey"
            done
          done
          
          echo "‚úÖ All caches deleted"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
