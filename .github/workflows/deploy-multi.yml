# ============================================================================
# ðŸŒ Deploy Multi - Choix flexible (Azure, Fly.io, Vercel, Cloudflare)
# ============================================================================
# DÃ©ploie sur la plateforme choisie via variables `DEPLOY_TARGET`
# ============================================================================

name: ðŸŒ Deploy Multi

on:
  workflow_dispatch:
    inputs:
      target:
        required: true
        type: choice
      ref:
        description: 'Git ref to deploy (branch or tag)'
        required: false
        default: 'main'
        type: string
      run_build:
        description: 'Run build before deploy'
        required: false
        default: true
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ inputs.target }}-${{ inputs.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  deployments: write
  id-token: write

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸ”§ Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://x:x@localhost/x' }}

      - name: ðŸ—ï¸ Build Application
        if: inputs.run_build == true
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://x:x@localhost/x' }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'build-secret-32-characters-long!' }}
          NEXTAUTH_URL: 'http://localhost:3000'

      - name: Select Deploy Target
        id: target
        run: echo "target=${{ inputs.target }}" >> $GITHUB_OUTPUT

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Azure App Service
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ” Azure Login
        if: steps.target.outputs.target == 'azure'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸš€ Deploy to Azure App Service
        if: steps.target.outputs.target == 'azure'
        uses: azure/webapps-deploy@v3
        with:
          app-name: memoLib-app
          package: .

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Fly.io
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ”§ Setup Flyctl
        if: steps.target.outputs.target == 'fly'
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: ðŸš€ Deploy to Fly.io
        if: steps.target.outputs.target == 'fly'
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Vercel
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ” Vercel Auth
        if: steps.target.outputs.target == 'vercel'
        run: npx vercel login --token ${{ secrets.VERCEL_TOKEN }}

      - name: ðŸš€ Deploy to Vercel
        if: steps.target.outputs.target == 'vercel'
        run: npx vercel --prod --confirm --token ${{ secrets.VERCEL_TOKEN }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Cloudflare Pages
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸš€ Deploy to Cloudflare Pages
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: memoLib
          directory: ./out
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Deploy Summary
        run: |
          echo "## ðŸŒ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Target: ${{ inputs.target }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ref: ${{ inputs.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ inputs.run_build }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“£ Notify Slack
        if: success() && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Deployment completed: ${{ inputs.target }} (${{ inputs.ref }})"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
