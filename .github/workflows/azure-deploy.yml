# ============================================================================
# Azure App Service - Production Deployment
# ============================================================================
# DÃ©ploie l'application Next.js sur Azure App Service (Linux Node.js 20)
# 
# PrÃ©requis:
#   - Secret AZURE_CREDENTIALS configurÃ© (Service Principal JSON)
#   - App Service "iapostemanager-app" crÃ©Ã© dans le groupe "iapostemanager-rg"
#   - Variables d'environnement configurÃ©es dans App Service:
#     * DATABASE_URL, NEXTAUTH_URL, NEXTAUTH_SECRET, NODE_ENV
# ============================================================================

name: ğŸš€ Azure Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deploy'
        type: boolean
        default: false

env:
  NODE_VERSION: '20'
  AZURE_WEBAPP_NAME: iapostemanager-app
  AZURE_RESOURCE_GROUP: iapostemanager-rg

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Build Job - Compile Next.js standalone
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: ğŸ“¦ Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build Next.js (standalone mode)
        env:
          NODE_ENV: production
          FORCE_STANDALONE: true
          NEXT_PUBLIC_APP_URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net
          # Build-time placeholders (real values in App Service)
          DATABASE_URL: 'postgresql://placeholder:placeholder@localhost:5432/placeholder'
          NEXTAUTH_SECRET: 'placeholder-secret-for-build-only-32chars!'
          NEXTAUTH_URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net
        run: |
          echo "ğŸ—ï¸ Building Next.js in standalone mode for Azure..."
          npm run build
          echo ""
          echo "ğŸ“¦ Checking build output..."
          if [ -d ".next/standalone" ]; then
            echo "âœ… Standalone build successful"
          else
            echo "âŒ Standalone output not found - checking output type in next.config.js"
            exit 1
          fi

      - name: Prepare deployment package
        run: |
          # Copier les assets statiques dans standalone
          cp -r .next/static .next/standalone/.next/
          cp -r public .next/standalone/ 2>/dev/null || true
          
          # CrÃ©er un script de dÃ©marrage qui utilise le PORT d'Azure
          cat > .next/standalone/startup.js << 'STARTUP'
          // Azure App Service startup wrapper
          process.env.PORT = process.env.PORT || process.env.WEBSITES_PORT || '8080';
          process.env.HOSTNAME = '0.0.0.0';
          console.log(`Starting Next.js on port ${process.env.PORT}...`);
          require('./server.js');
          STARTUP
          
          # CrÃ©er un package.json minimal pour Azure
          cat > .next/standalone/package.json << 'EOF'
          {
            "name": "iapostemanager",
            "version": "1.0.0",
            "private": true,
            "scripts": {
              "start": "node startup.js"
            },
            "engines": {
              "node": ">=20"
            }
          }
          EOF
          
          # Afficher la structure pour debug
          echo "ğŸ“ Structure du package:"
          ls -la .next/standalone/
          echo "ğŸ“ Taille totale:"
          du -sh .next/standalone/

      - name: Verify build output exists
        run: |
          echo "ğŸ” Verifying Next.js standalone build..."
          if [ ! -d ".next/standalone" ]; then
            echo "âŒ ERROR: .next/standalone directory not found!"
            echo "The build may have failed or standalone output is not configured."
            exit 1
          fi
          if [ ! -f ".next/standalone/server.js" ]; then
            echo "âŒ ERROR: server.js not found in standalone build!"
            exit 1
          fi
          echo "âœ… Standalone build verified successfully"
          ls -la .next/standalone/

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-app
          path: .next/standalone
          retention-days: 1
          if-no-files-found: error

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Deploy Job - Push to Azure App Service
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: azure-production
      url: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: nextjs-app
          path: ./app

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          # DÃ©sactiver Azure PowerShell session (Ã©vite problÃ¨mes de parsing)
          enable-AzPSSession: false

      - name: Azure sanity check
        run: |
          echo "ğŸ” Testing Azure connection..."
          # DÃ©sactiver les warnings CLI qui peuvent casser le JSON
          export AZURE_CORE_ONLY_SHOW_ERRORS=true
          
          # Test simple de connexion
          if az account show --query "name" -o tsv 2>/dev/null; then
            echo ""
            echo "âœ… Azure CLI authenticated successfully"
            echo "ğŸ“‹ Subscription: $(az account show --query 'name' -o tsv)"
            echo "ğŸ†” ID: $(az account show --query 'id' -o tsv)"
          else
            echo "âŒ Azure authentication failed"
            echo "VÃ©rifiez que AZURE_CREDENTIALS contient un JSON valide"
            exit 1
          fi

      - name: Ensure App Service is running
        run: |
          echo "ğŸ”„ S'assurer que l'App Service est active..."
          az webapp start --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} || true
          sleep 5

      - name: Configure App Service startup
        run: |
          # Configurer la commande de dÃ©marrage
          az webapp config set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --startup-file "npm start"
          
          # S'assurer que les logs sont activÃ©s
          az webapp log config \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --docker-container-logging filesystem

      - name: Deploy via ZIP (bypasses Site Disabled)
        run: |
          # CrÃ©er un ZIP du package
          cd ./app
          zip -r ../app.zip .
          cd ..
          
          # RÃ©activer l'app juste avant le deploy
          az webapp start --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} || true
          
          # DÃ©ployer via ZIP deploy (plus robuste)
          az webapp deploy \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --src-path app.zip \
            --type zip \
            --async true
          
          echo "âœ… DÃ©ploiement ZIP initiÃ©"

      - name: Wait for deployment
        run: sleep 90

      - name: Health check
        run: |
          echo "ğŸ¥ VÃ©rification de santÃ©..."
          for i in {1..5}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net" --max-time 30 || echo "000")
            echo "Tentative $i: HTTP $STATUS"
            if [ "$STATUS" = "200" ] || [ "$STATUS" = "307" ] || [ "$STATUS" = "302" ]; then
              echo "âœ… Application accessible!"
              exit 0
            fi
            sleep 15
          done
          echo "âš ï¸ L'application peut encore Ãªtre en cours de dÃ©marrage"
          # Ne pas faire Ã©chouer le workflow, les cold starts peuvent prendre du temps
          exit 0

      - name: Deployment summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š RÃ‰SUMÃ‰ DU DÃ‰PLOIEMENT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          echo "ğŸ“¦ App Service: ${{ env.AZURE_WEBAPP_NAME }}"
          echo "ğŸ—‚ï¸ Resource Group: ${{ env.AZURE_RESOURCE_GROUP }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
