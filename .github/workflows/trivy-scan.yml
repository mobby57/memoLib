name: "ðŸ›¡ï¸ Trivy Security Scan"

on:
  # âš¡ OPTIMISÃ‰: Hebdomadaire au lieu de quotidien (Ã©conomie ~80%)
  push:
    branches: [ main ]
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'Dockerfile*'
  pull_request:
    branches: [ main ]
    paths:
      - 'package.json'
      - 'package-lock.json'
  schedule:
    - cron: '0 3 * * 1'  # Lundi Ã  3h (au lieu de tous les jours)
  workflow_dispatch:

jobs:
  scan-dependencies:
    name: Scan Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner (Dependencies)
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results-fs.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results-fs.sarif'
        category: 'trivy-dependencies'

    - name: Generate readable report
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        output: 'trivy-report.txt'
        severity: 'CRITICAL,HIGH,MEDIUM'

    - name: Upload report as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: trivy-dependencies-report
        path: trivy-report.txt
        retention-days: 30

  scan-docker:
    name: Scan Docker Image
    runs-on: ubuntu-latest
    if: false  # DÃ©sactivÃ© pour Cloudflare (pas de Docker)
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker image
      run: docker build -t iaposte-manager:${{ github.sha }} .

    - name: Run Trivy vulnerability scanner (Docker)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'iaposte-manager:${{ github.sha }}'
        format: 'sarif'
        output: 'trivy-results-docker.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results-docker.sarif'
        category: 'trivy-docker'

  scan-config:
    name: Scan Configuration Files
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner (Config)
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'config'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results-config.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results-config.sarif'
        category: 'trivy-config'

  scan-secrets:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run Trivy secret scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        scanners: 'secret'
        format: 'sarif'
        output: 'trivy-results-secrets.sarif'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results-secrets.sarif'
        category: 'trivy-secrets'

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [scan-dependencies, scan-config, scan-secrets]
    if: always()

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Generate summary
      run: |
        echo "# ðŸ›¡ï¸ Trivy Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Scans Performed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dependencies scan" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Docker image scan" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Configuration scan" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Secrets scan" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "View detailed results in the Security tab." >> $GITHUB_STEP_SUMMARY
