# ========================================
# ğŸ§ª TEST COVERAGE CONTINUE
# ========================================
# Pipeline dÃ©diÃ© Ã  la couverture de tests
# Objectif: 30% min â†’ 80% idÃ©al
# ========================================

name: ğŸ§ª Test Coverage

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # ExÃ©cution quotidienne Ã  6h UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  MIN_COVERAGE: 10
  TARGET_COVERAGE: 80

jobs:
  # ========================================
  # 1ï¸âƒ£ TESTS UNITAIRES AVEC COUVERTURE
  # ========================================
  unit-coverage:
    name: ğŸ§ª Unit Tests Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    outputs:
      coverage_percentage: ${{ steps.coverage.outputs.percentage }}
      coverage_passed: ${{ steps.coverage.outputs.passed }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps
      
      - name: ğŸ”§ Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: "postgresql://placeholder:placeholder@localhost:5432/placeholder"
      
      - name: ğŸ§ª Run Tests with Coverage
        id: test
        run: |
          npm run test:ci || true
        env:
          CI: true
          DATABASE_URL: "postgresql://placeholder:placeholder@localhost:5432/placeholder"
          NEXTAUTH_SECRET: "test-secret-key-for-ci"
          NEXTAUTH_URL: "http://localhost:3000"
      
      - name: ğŸ“Š Extract Coverage
        id: coverage
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(cat coverage/coverage-summary.json | jq '.total.lines.pct // 0')
            STATEMENTS=$(cat coverage/coverage-summary.json | jq '.total.statements.pct // 0')
            BRANCHES=$(cat coverage/coverage-summary.json | jq '.total.branches.pct // 0')
            FUNCTIONS=$(cat coverage/coverage-summary.json | jq '.total.functions.pct // 0')
            
            # Moyenne pondÃ©rÃ©e
            AVG=$(echo "scale=2; ($LINES + $STATEMENTS + $BRANCHES + $FUNCTIONS) / 4" | bc)
            
            echo "percentage=$AVG" >> $GITHUB_OUTPUT
            echo "lines=$LINES" >> $GITHUB_OUTPUT
            echo "statements=$STATEMENTS" >> $GITHUB_OUTPUT
            echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
            echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
            
            # VÃ©rifier si au-dessus du minimum
            if (( $(echo "$AVG >= ${{ env.MIN_COVERAGE }}" | bc -l) )); then
              echo "passed=true" >> $GITHUB_OUTPUT
              echo "âœ… Coverage $AVG% >= ${{ env.MIN_COVERAGE }}% minimum"
            else
              echo "passed=false" >> $GITHUB_OUTPUT
              echo "âŒ Coverage $AVG% < ${{ env.MIN_COVERAGE }}% minimum"
            fi
          else
            echo "percentage=0" >> $GITHUB_OUTPUT
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No coverage report found"
          fi
      
      - name: ğŸ“¤ Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30
      
      - name: ğŸ“Š Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-iapostemanage
          fail_ci_if_error: false
        continue-on-error: true

  # ========================================
  # 2ï¸âƒ£ TESTS D'INTÃ‰GRATION
  # ========================================
  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: unit-coverage
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: iapostemanage_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps
      
      - name: ğŸ”§ Setup Database
        run: |
          npx prisma generate
          npx prisma db push --force-reset
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/iapostemanage_test"
      
      - name: ğŸ”— Run Integration Tests
        run: npm run test:integration || echo "Integration tests completed"
        continue-on-error: true
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/iapostemanage_test"
          NEXTAUTH_SECRET: "test-secret-key"
          NEXTAUTH_URL: "http://localhost:3000"

  # ========================================
  # 3ï¸âƒ£ RAPPORT DE COUVERTURE
  # ========================================
  coverage-report:
    name: ğŸ“Š Coverage Report
    runs-on: ubuntu-latest
    needs: [unit-coverage, integration-tests]
    if: always()
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: coverage/
        continue-on-error: true
      
      - name: ğŸ“Š Generate Coverage Badge
        run: |
          COVERAGE="${{ needs.unit-coverage.outputs.coverage_percentage }}"
          PASSED="${{ needs.unit-coverage.outputs.coverage_passed }}"
          
          echo "## ğŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| MÃ©trique | Valeur |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Couverture globale** | ${COVERAGE}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **Seuil minimum** | ${{ env.MIN_COVERAGE }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **Objectif** | ${{ env.TARGET_COVERAGE }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **Statut** | $( [ "$PASSED" = "true" ] && echo "âœ… PassÃ©" || echo "âŒ Ã‰chouÃ©") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$PASSED" != "true" ]; then
            echo "### âš ï¸ Action requise" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "La couverture de tests est infÃ©rieure au seuil minimum de ${{ env.MIN_COVERAGE }}%." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Modules prioritaires Ã  tester:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`src/lib/services/\` - Services mÃ©tier critiques" >> $GITHUB_STEP_SUMMARY
            echo "- \`src/app/api/\` - Endpoints API" >> $GITHUB_STEP_SUMMARY
            echo "- \`src/lib/auth/\` - Authentification" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸš¨ Coverage Warning (Non-blocking)
        if: needs.unit-coverage.outputs.coverage_passed != 'true'
        run: |
          echo "âš ï¸ Coverage ${{ needs.unit-coverage.outputs.coverage_percentage }}% is below minimum ${{ env.MIN_COVERAGE }}%"
          echo "ğŸ“ˆ Please add more tests to improve coverage"
          echo "ğŸ¯ Target: ${{ env.TARGET_COVERAGE }}%"
        # Note: Non-blocking - pipeline continues even if coverage is low

  # ========================================
  # 4ï¸âƒ£ TESTS E2E (OPTIONNEL)
  # ========================================
  e2e-tests:
    name: ğŸ­ E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: unit-coverage
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps
      
      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps chromium
      
      - name: ğŸ”§ Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: "postgresql://placeholder:placeholder@localhost:5432/placeholder"
      
      - name: ğŸ­ Run E2E Tests
        run: npm run test:e2e || echo "E2E tests completed"
        continue-on-error: true
        env:
          CI: true
      
      - name: ğŸ“¤ Upload E2E Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7
