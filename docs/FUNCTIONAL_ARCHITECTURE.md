# Schéma Fonctionnel Complet - IA Poste Manager

> **Architecture multi-canal, documents et monitoring**
> Version 2.0 - 26/01/2026

---

## 🎯 VUE D'ENSEMBLE

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            IA POSTE MANAGER - ARCHITECTURE                          │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│    📧 EMAIL        📱 WHATSAPP       📞 SMS/VOICE      💬 SLACK/TEAMS              │
│       │                │                  │                  │                      │
│       └────────────────┴──────────────────┴──────────────────┘                      │
│                                    │                                                │
│                                    ▼                                                │
│                    ┌───────────────────────────────┐                                │
│                    │      WEBHOOK GATEWAY          │                                │
│                    │   /api/webhooks/channel/*     │                                │
│                    └───────────────┬───────────────┘                                │
│                                    │                                                │
│                                    ▼                                                │
│    ┌───────────────────────────────────────────────────────────────┐                │
│    │                    MULTI-CHANNEL SERVICE                      │                │
│    │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────────┐  │                │
│    │  │ Parser  │→ │Normalize│→ │   AI    │→ │ Route/Priority  │  │                │
│    │  └─────────┘  └─────────┘  └─────────┘  └─────────────────┘  │                │
│    └───────────────────────────────┬───────────────────────────────┘                │
│                                    │                                                │
│           ┌────────────────────────┼────────────────────────┐                       │
│           │                        │                        │                       │
│           ▼                        ▼                        ▼                       │
│    ┌─────────────┐         ┌─────────────┐         ┌─────────────┐                  │
│    │   DOSSIERS  │         │  CALENDRIER │         │   DOCUMENTS │                  │
│    │   /cases    │         │   /calendar │         │    /docs    │                  │
│    └─────────────┘         └─────────────┘         └─────────────┘                  │
│           │                        │                        │                       │
│           └────────────────────────┴────────────────────────┘                       │
│                                    │                                                │
│                                    ▼                                                │
│                    ┌───────────────────────────────┐                                │
│                    │         DATABASE              │                                │
│                    │     PostgreSQL (Neon)         │                                │
│                    └───────────────────────────────┘                                │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 📧 FLUX EMAIL

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              FLUX EMAIL ENTRANT                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   Expéditeur                                                                    │
│      │                                                                          │
│      ▼                                                                          │
│   ┌──────────────┐     ┌──────────────┐     ┌──────────────┐                   │
│   │   Gmail /    │ ──→ │   SendGrid   │ ──→ │   Webhook    │                   │
│   │   Outlook    │     │   Inbound    │     │  /email      │                   │
│   └──────────────┘     └──────────────┘     └──────┬───────┘                   │
│                                                     │                           │
│                                                     ▼                           │
│                              ┌──────────────────────────────────┐              │
│                              │         EMAIL PARSER             │              │
│                              │  • Extraction headers            │              │
│                              │  • Parse body (text/html)        │              │
│                              │  • Extraction pièces jointes     │              │
│                              │  • Détection langue              │              │
│                              └──────────────┬───────────────────┘              │
│                                             │                                   │
│                                             ▼                                   │
│                              ┌──────────────────────────────────┐              │
│                              │         AI ANALYSIS              │              │
│                              │  • Classification (URGENT/NORMAL)│              │
│                              │  • Extraction entités            │              │
│                              │  • Suggestion action             │              │
│                              │  • Matching dossier existant     │              │
│                              └──────────────┬───────────────────┘              │
│                                             │                                   │
│                      ┌──────────────────────┼──────────────────────┐           │
│                      │                      │                      │           │
│                      ▼                      ▼                      ▼           │
│              ┌────────────┐         ┌────────────┐         ┌────────────┐      │
│              │  Créer     │         │  Rattacher │         │   Alerter  │      │
│              │  Dossier   │         │  au Dossier│         │   Avocat   │      │
│              └────────────┘         └────────────┘         └────────────┘      │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              FLUX EMAIL SORTANT                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌──────────────┐                                                              │
│   │   Avocat     │                                                              │
│   │   (UI)       │                                                              │
│   └──────┬───────┘                                                              │
│          │                                                                      │
│          ▼                                                                      │
│   ┌──────────────────────────────────────────────┐                             │
│   │           COMPOSE EMAIL                       │                             │
│   │  ┌─────────────────────────────────────────┐ │                             │
│   │  │ 🤖 Suggestions IA:                       │ │                             │
│   │  │   • Template recommandé                  │ │                             │
│   │  │   • Pièces jointes suggérées            │ │                             │
│   │  │   • Destinataires CC suggérés           │ │                             │
│   │  └─────────────────────────────────────────┘ │                             │
│   └──────────────────────────────────────────────┘                             │
│          │                                                                      │
│          ▼                                                                      │
│   ┌──────────────┐     ┌──────────────┐     ┌──────────────┐                   │
│   │   Queue      │ ──→ │   SendGrid   │ ──→ │ Destinataire │                   │
│   │   /send      │     │   API        │     │              │                   │
│   └──────────────┘     └──────────────┘     └──────────────┘                   │
│          │                                                                      │
│          ▼                                                                      │
│   ┌──────────────────────────────────────────────┐                             │
│   │  📊 Tracking: Ouverture, clics, bounces     │                             │
│   └──────────────────────────────────────────────┘                             │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 📱 FLUX WHATSAPP

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            FLUX WHATSAPP                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   Client                          Avocat                                        │
│     │                               │                                           │
│     │    WhatsApp Business API      │                                           │
│     │◄─────────────────────────────►│                                           │
│     │                               │                                           │
│     ▼                               │                                           │
│   ┌─────────────┐                   │                                           │
│   │   Meta      │                   │                                           │
│   │  (Webhook)  │───────────────────┼──────────────────┐                        │
│   └─────────────┘                   │                  │                        │
│                                     │                  ▼                        │
│                                     │   ┌──────────────────────────┐            │
│                                     │   │  /api/webhooks/whatsapp  │            │
│                                     │   └───────────┬──────────────┘            │
│                                     │               │                           │
│                                     │               ▼                           │
│                                     │   ┌──────────────────────────┐            │
│                                     │   │    WHATSAPP ADAPTER      │            │
│                                     │   │  • Parse message         │            │
│                                     │   │  • Télécharger médias    │            │
│                                     │   │  • Identifier client     │            │
│                                     │   └───────────┬──────────────┘            │
│                                     │               │                           │
│                                     │               ▼                           │
│                                     │   ┌──────────────────────────┐            │
│                                     │   │   NORMALIZER             │            │
│   ┌──────────────────────┐         │   │  {                       │            │
│   │  Notification Push   │◄────────┼───│    channel: "WHATSAPP",  │            │
│   │  (App mobile/Web)    │         │   │    content: "...",       │            │
│   └──────────────────────┘         │   │    sender: "CLIENT_ID",  │            │
│                                     │   │    urgency: "HIGH"       │            │
│                                     │   │  }                       │            │
│                                     │   └──────────────────────────┘            │
│                                     │                                           │
│                                     ▼                                           │
│                          ┌────────────────────┐                                 │
│                          │     RÉPONSE        │                                 │
│                          │  (depuis l'app)    │                                 │
│                          └─────────┬──────────┘                                 │
│                                    │                                            │
│                                    ▼                                            │
│                          ┌────────────────────┐                                 │
│                          │   WhatsApp API     │ ──→ Client                      │
│                          │   (Twilio/Meta)    │                                 │
│                          └────────────────────┘                                 │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 📞 FLUX SMS/VOICE (Twilio)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            FLUX SMS                                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ENTRANT                                                                       │
│   ────────                                                                      │
│   Client SMS ──→ Twilio ──→ /api/webhooks/sms ──→ Normalizer ──→ Dossier       │
│                                                                                 │
│   SORTANT                                                                       │
│   ────────                                                                      │
│   App ──→ Queue ──→ Twilio API ──→ Client                                       │
│                                                                                 │
│   Cas d'usage SMS:                                                              │
│   • Rappel RDV (automatique)                                                    │
│   • Notification échéance                                                       │
│   • Confirmation réception document                                             │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                            FLUX VOICE (Appels)                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   Appel entrant                                                                 │
│       │                                                                         │
│       ▼                                                                         │
│   ┌───────────────┐                                                             │
│   │    Twilio     │                                                             │
│   │  Programmable │                                                             │
│   │    Voice      │                                                             │
│   └───────┬───────┘                                                             │
│           │                                                                     │
│           ▼                                                                     │
│   ┌───────────────────────────────────────────────────────────┐                 │
│   │  /api/webhooks/voice                                       │                 │
│   │                                                            │                 │
│   │  ┌─────────────────────────────────────────────────────┐  │                 │
│   │  │  TwiML Response:                                     │  │                 │
│   │  │  <Response>                                          │  │                 │
│   │  │    <Say>Bienvenue, Cabinet X. Tapez 1 pour...</Say>  │  │                 │
│   │  │    <Gather numDigits="1" action="/voice/menu"/>      │  │                 │
│   │  │  </Response>                                         │  │                 │
│   │  └─────────────────────────────────────────────────────┘  │                 │
│   └───────────────────────────────────────────────────────────┘                 │
│           │                                                                     │
│           ├──→ [1] Transférer à l'avocat                                        │
│           ├──→ [2] Laisser un message (transcription IA)                        │
│           └──→ [3] Informations horaires                                        │
│                                                                                 │
│   📝 Transcription automatique → Rattachement au dossier                        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 📄 SYSTÈME DOCUMENTAIRE

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         GESTION DOCUMENTAIRE                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌───────────────────────────────────────────────────────────────────────┐     │
│   │                         SOURCES D'ENTRÉE                              │     │
│   │                                                                       │     │
│   │   📧 Email       📱 WhatsApp      📤 Upload       📝 Génération      │     │
│   │   (PJ)          (Média)          (Manuel)        (Template)          │     │
│   └───────────────────────────────────────────────────────────────────────┘     │
│                                    │                                            │
│                                    ▼                                            │
│   ┌───────────────────────────────────────────────────────────────────────┐     │
│   │                      DOCUMENT PROCESSOR                               │     │
│   │                                                                       │     │
│   │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                │     │
│   │   │   Virus     │ → │    OCR      │ → │  Metadata   │                │     │
│   │   │   Scan      │   │  (si image) │   │  Extract    │                │     │
│   │   └─────────────┘   └─────────────┘   └─────────────┘                │     │
│   │                                                                       │     │
│   └───────────────────────────────────────────────────────────────────────┘     │
│                                    │                                            │
│                                    ▼                                            │
│   ┌───────────────────────────────────────────────────────────────────────┐     │
│   │                         STORAGE LAYER                                 │     │
│   │                                                                       │     │
│   │   ┌─────────────────────────────────────────────────────────────┐    │     │
│   │   │  Azure Blob Storage / S3                                     │    │     │
│   │   │  • Chiffrement AES-256                                       │    │     │
│   │   │  • Versioning activé                                         │    │     │
│   │   │  • Lifecycle policies (archivage 1 an)                       │    │     │
│   │   └─────────────────────────────────────────────────────────────┘    │     │
│   │                                                                       │     │
│   │   ┌─────────────────────────────────────────────────────────────┐    │     │
│   │   │  PostgreSQL (Métadonnées)                                    │    │     │
│   │   │  • ID, nom, type, taille                                     │    │     │
│   │   │  • Dossier rattaché                                          │    │     │
│   │   │  • Date création, modification                               │    │     │
│   │   │  • Hash SHA-256 (intégrité)                                  │    │     │
│   │   └─────────────────────────────────────────────────────────────┘    │     │
│   │                                                                       │     │
│   └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│   ┌───────────────────────────────────────────────────────────────────────┐     │
│   │                      GÉNÉRATION DOCUMENTS                             │     │
│   │                                                                       │     │
│   │   Template Engine (Handlebars)                                        │     │
│   │       │                                                               │     │
│   │       ▼                                                               │     │
│   │   ┌─────────────────────────────────────────────────────────────┐    │     │
│   │   │  Templates disponibles:                                      │    │     │
│   │   │  • Courrier type OQTF                                        │    │     │
│   │   │  • Demande de titre de séjour                                │    │     │
│   │   │  • Conclusions                                               │    │     │
│   │   │  • Factures                                                  │    │     │
│   │   │  • Conventions d'honoraires                                  │    │     │
│   │   └─────────────────────────────────────────────────────────────┘    │     │
│   │       │                                                               │     │
│   │       ▼                                                               │     │
│   │   PDF Generation (Puppeteer / PDFKit)                                 │     │
│   │                                                                       │     │
│   └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 MONITORING & OBSERVABILITÉ

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              MONITORING STACK                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                           APPLICATION                                    │   │
│   │                                                                         │   │
│   │   Next.js ──→ Instrumentation ──→ OpenTelemetry                         │   │
│   │                                                                         │   │
│   └───────────────────────────────────┬─────────────────────────────────────┘   │
│                                       │                                         │
│           ┌───────────────────────────┼───────────────────────────┐             │
│           │                           │                           │             │
│           ▼                           ▼                           ▼             │
│   ┌───────────────┐           ┌───────────────┐           ┌───────────────┐     │
│   │    SENTRY     │           │   VERCEL      │           │    DATADOG    │     │
│   │   (Errors)    │           │   Analytics   │           │   (APM/Logs)  │     │
│   │               │           │               │           │               │     │
│   │ • Exceptions  │           │ • Web Vitals  │           │ • Traces      │     │
│   │ • Stack trace │           │ • Page views  │           │ • Metrics     │     │
│   │ • User context│           │ • Geolocation │           │ • Dashboards  │     │
│   └───────────────┘           └───────────────┘           └───────────────┘     │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                          ALERTING                                        │   │
│   │                                                                         │   │
│   │   ┌─────────────────────────────────────────────────────────────────┐   │   │
│   │   │  Conditions d'alerte:                                            │   │   │
│   │   │                                                                  │   │   │
│   │   │  🔴 CRITIQUE                                                     │   │   │
│   │   │  • Error rate > 5%                                               │   │   │
│   │   │  • API response time > 3s                                        │   │   │
│   │   │  • Database connection failed                                    │   │   │
│   │   │                                                                  │   │   │
│   │   │  🟠 WARNING                                                      │   │   │
│   │   │  • Error rate > 1%                                               │   │   │
│   │   │  • Memory usage > 80%                                            │   │   │
│   │   │  • Failed webhook delivery                                       │   │   │
│   │   │                                                                  │   │   │
│   │   │  🟢 INFO                                                         │   │   │
│   │   │  • Deployment completed                                          │   │   │
│   │   │  • Daily backup success                                          │   │   │
│   │   └─────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                         │   │
│   │   Canaux de notification:                                               │   │
│   │   • Slack #alerts                                                       │   │
│   │   • Email astreinte                                                     │   │
│   │   • SMS (critique uniquement)                                           │   │
│   │                                                                         │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                        AUDIT LOGS                                        │   │
│   │                                                                         │   │
│   │   Chaque action utilisateur est loggée:                                 │   │
│   │                                                                         │   │
│   │   {                                                                     │   │
│   │     "timestamp": "2026-01-26T12:00:00Z",                                │   │
│   │     "userId": "user_123",                                               │   │
│   │     "tenantId": "tenant_456",                                           │   │
│   │     "action": "CASE_VIEW",                                              │   │
│   │     "resource": "case_789",                                             │   │
│   │     "ip": "192.168.x.x" (pseudonymisé),                                 │   │
│   │     "userAgent": "hash_abc123"                                          │   │
│   │   }                                                                     │   │
│   │                                                                         │   │
│   │   Conservation: 1 an (RGPD)                                             │   │
│   │                                                                         │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔐 FLUX D'AUTHENTIFICATION

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         AUTHENTICATION FLOW                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   Utilisateur                                                                   │
│       │                                                                         │
│       │ 1. Login (email/password ou OAuth)                                      │
│       ▼                                                                         │
│   ┌───────────────┐                                                             │
│   │   NextAuth    │                                                             │
│   │   /api/auth   │                                                             │
│   └───────┬───────┘                                                             │
│           │                                                                     │
│           ├──→ [Email/Password] ──→ Verify bcrypt hash ──→ JWT                  │
│           │                                                                     │
│           ├──→ [Google OAuth] ──→ Google API ──→ JWT                            │
│           │                                                                     │
│           └──→ [GitHub OAuth] ──→ GitHub API ──→ JWT                            │
│                                                                                 │
│           │                                                                     │
│           ▼                                                                     │
│   ┌───────────────────────────────────────────────────────────────┐             │
│   │  SESSION (JWT)                                                 │             │
│   │                                                                │             │
│   │  {                                                             │             │
│   │    "userId": "user_123",                                       │             │
│   │    "email": "avocat@cabinet.fr",                               │             │
│   │    "tenantId": "tenant_456",                                   │             │
│   │    "role": "ADMIN",                                            │             │
│   │    "permissions": ["cases:read", "cases:write", "docs:*"],     │             │
│   │    "exp": 1706400000                                           │             │
│   │  }                                                             │             │
│   │                                                                │             │
│   └───────────────────────────────────────────────────────────────┘             │
│           │                                                                     │
│           ▼                                                                     │
│   ┌───────────────────────────────────────────────────────────────┐             │
│   │  MIDDLEWARE (chaque requête)                                   │             │
│   │                                                                │             │
│   │  1. Vérifier JWT signature                                     │             │
│   │  2. Vérifier expiration                                        │             │
│   │  3. Extraire tenantId                                          │             │
│   │  4. Appliquer isolation multi-tenant                           │             │
│   │  5. Vérifier permissions pour la route                         │             │
│   │                                                                │             │
│   └───────────────────────────────────────────────────────────────┘             │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 📁 STRUCTURE API ENDPOINTS

```
/api
├── /auth
│   ├── [...nextauth]     # NextAuth handlers
│   ├── /register         # Inscription
│   └── /forgot-password  # Reset password
│
├── /tenant/[tenantId]
│   ├── /dashboard        # Stats & KPIs
│   ├── /cases            # Dossiers CRUD
│   │   └── /[caseId]
│   │       ├── /documents
│   │       ├── /notes
│   │       ├── /timeline
│   │       └── /emails
│   ├── /calendar         # Événements & RDV
│   ├── /contacts         # Clients & contacts
│   ├── /documents        # Tous les docs
│   └── /settings         # Configuration tenant
│
├── /webhooks
│   └── /channel
│       ├── /email        # SendGrid inbound
│       ├── /whatsapp     # Meta/Twilio
│       ├── /sms          # Twilio
│       ├── /voice        # Twilio Voice
│       ├── /slack        # Slack Events
│       └── /teams        # MS Teams
│
├── /multichannel
│   ├── /messages         # Envoi multi-canal
│   └── /status           # Statuts delivery
│
├── /ai
│   ├── /analyze          # Analyse document/email
│   ├── /suggest          # Suggestions actions
│   └── /generate         # Génération contenu
│
├── /rgpd
│   ├── /export           # Portabilité données
│   └── /delete           # Droit à l'oubli
│
├── /admin
│   ├── /users            # Gestion utilisateurs
│   ├── /tenants          # Gestion tenants
│   └── /audit            # Logs d'audit
│
└── /health               # Health check
```

---

*Document généré le 26/01/2026*
