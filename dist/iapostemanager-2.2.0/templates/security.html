<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√©curit√© - SecureVault</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîí Centre de S√©curit√©</h1>
            <nav>
                <a href="/nav">‚Üê Retour</a>
                <a href="/admin">Administration</a>
            </nav>
        </header>

        <div class="security-overview">
            <div class="security-card">
                <div class="security-icon">üõ°Ô∏è</div>
                <div class="security-info">
                    <h3>Niveau de S√©curit√©</h3>
                    <div class="security-level high">√âlev√©</div>
                </div>
            </div>
            <div class="security-card">
                <div class="security-icon">üîê</div>
                <div class="security-info">
                    <h3>Chiffrement</h3>
                    <div class="security-status">AES-256 Actif</div>
                </div>
            </div>
            <div class="security-card">
                <div class="security-icon">‚ö†Ô∏è</div>
                <div class="security-info">
                    <h3>Alertes</h3>
                    <div class="security-alerts" id="alertCount">0</div>
                </div>
            </div>
        </div>

        <div class="security-tabs">
            <button class="tab-btn active" onclick="showTab('events')">üìã √âv√©nements</button>
            <button class="tab-btn" onclick="showTab('settings')">‚öôÔ∏è Configuration</button>
            <button class="tab-btn" onclick="showTab('audit')">üîç Audit</button>
            <button class="tab-btn" onclick="showTab('keys')">üîë Cl√©s API</button>
        </div>

        <!-- √âv√©nements de S√©curit√© -->
        <div class="tab-content active" id="events-tab">
            <div class="card">
                <div class="section-header">
                    <h2>√âv√©nements de S√©curit√©</h2>
                    <div class="filters">
                        <select id="severityFilter" onchange="filterEvents()">
                            <option value="">Toutes s√©v√©rit√©s</option>
                            <option value="info">Info</option>
                            <option value="warning">Avertissement</option>
                            <option value="error">Erreur</option>
                            <option value="critical">Critique</option>
                        </select>
                        <button onclick="refreshEvents()" class="btn btn-secondary">üîÑ Actualiser</button>
                    </div>
                </div>
                
                <div id="eventsList" class="events-list"></div>
            </div>
        </div>

        <!-- Configuration S√©curit√© -->
        <div class="tab-content" id="settings-tab">
            <div class="card">
                <h2>Param√®tres de S√©curit√©</h2>
                <form id="securitySettingsForm">
                    <div class="settings-grid">
                        <div class="setting-group">
                            <h3>Authentification</h3>
                            <div class="setting-item">
                                <label>Dur√©e de session (minutes):</label>
                                <input type="number" id="sessionDuration" value="60" min="5" max="1440">
                            </div>
                            <div class="setting-item">
                                <label>Tentatives de connexion max:</label>
                                <input type="number" id="maxAttempts" value="5" min="1" max="10">
                            </div>
                            <div class="setting-item">
                                <label>2FA obligatoire:</label>
                                <input type="checkbox" id="require2FA">
                            </div>
                        </div>

                        <div class="setting-group">
                            <h3>Rate Limiting</h3>
                            <div class="setting-item">
                                <label>Requ√™tes par heure:</label>
                                <input type="number" id="rateLimit" value="100" min="10" max="1000">
                            </div>
                            <div class="setting-item">
                                <label>Blocage IP automatique:</label>
                                <input type="checkbox" id="autoBlock" checked>
                            </div>
                            <div class="setting-item">
                                <label>Dur√©e de blocage (minutes):</label>
                                <input type="number" id="blockDuration" value="60" min="5" max="1440">
                            </div>
                        </div>

                        <div class="setting-group">
                            <h3>Chiffrement</h3>
                            <div class="setting-item">
                                <label>Rotation automatique des cl√©s:</label>
                                <input type="checkbox" id="autoRotation" checked>
                            </div>
                            <div class="setting-item">
                                <label>Fr√©quence rotation (jours):</label>
                                <input type="number" id="rotationDays" value="90" min="1" max="365">
                            </div>
                            <div class="setting-item">
                                <button type="button" onclick="rotateKeys()" class="btn btn-warning">üîÑ Rotation Manuelle</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üíæ Sauvegarder</button>
                        <button type="button" onclick="resetSettings()" class="btn btn-secondary">üîÑ R√©initialiser</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Audit -->
        <div class="tab-content" id="audit-tab">
            <div class="card">
                <h2>Trail d'Audit</h2>
                <div class="audit-filters">
                    <input type="date" id="auditDateFrom">
                    <input type="date" id="auditDateTo">
                    <select id="auditAction">
                        <option value="">Toutes actions</option>
                        <option value="login">Connexion</option>
                        <option value="email_sent">Email envoy√©</option>
                        <option value="config_change">Changement config</option>
                        <option value="user_created">Utilisateur cr√©√©</option>
                    </select>
                    <button onclick="loadAuditTrail()" class="btn btn-primary">üîç Rechercher</button>
                </div>
                
                <div id="auditTrail" class="audit-trail"></div>
            </div>

            <div class="card">
                <h2>Rapports de S√©curit√©</h2>
                <div class="report-actions">
                    <button onclick="generateReport('daily')" class="btn btn-info">üìä Rapport Quotidien</button>
                    <button onclick="generateReport('weekly')" class="btn btn-info">üìä Rapport Hebdomadaire</button>
                    <button onclick="generateReport('monthly')" class="btn btn-info">üìä Rapport Mensuel</button>
                    <button onclick="exportAudit()" class="btn btn-secondary">üì§ Exporter Audit</button>
                </div>
            </div>
        </div>

        <!-- Gestion Cl√©s API -->
        <div class="tab-content" id="keys-tab">
            <div class="card">
                <div class="section-header">
                    <h2>Cl√©s API</h2>
                    <button onclick="showCreateKey()" class="btn btn-primary">‚ûï Nouvelle Cl√©</button>
                </div>
                
                <div id="apiKeysList" class="api-keys-list"></div>
            </div>

            <!-- Formulaire cr√©ation cl√© -->
            <div class="card hidden" id="createKeyForm">
                <h3>Nouvelle Cl√© API</h3>
                <form id="keyForm">
                    <div class="form-group">
                        <label>Nom:</label>
                        <input type="text" id="keyName" placeholder="Ex: Integration CRM" required>
                    </div>
                    <div class="form-group">
                        <label>Permissions:</label>
                        <div class="permissions-grid">
                            <label><input type="checkbox" value="read"> Lecture</label>
                            <label><input type="checkbox" value="write"> √âcriture</label>
                            <label><input type="checkbox" value="admin"> Administration</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Limite de taux (req/h):</label>
                        <input type="number" id="keyRateLimit" value="100" min="1" max="1000">
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="cancelCreateKey()">Annuler</button>
                        <button type="submit">Cr√©er</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'events';

        window.onload = function() {
            loadSecurityEvents();
            loadApiKeys();
            updateSecurityOverview();
        };

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;
        }

        async function loadSecurityEvents() {
            // Simulation d'√©v√©nements
            const events = [
                {
                    timestamp: new Date().toISOString(),
                    type: 'login_success',
                    user: 'admin',
                    ip: '127.0.0.1',
                    severity: 'info',
                    details: 'Connexion r√©ussie'
                },
                {
                    timestamp: new Date(Date.now() - 3600000).toISOString(),
                    type: 'failed_login',
                    user: 'unknown',
                    ip: '192.168.1.100',
                    severity: 'warning',
                    details: 'Tentative de connexion √©chou√©e'
                },
                {
                    timestamp: new Date(Date.now() - 7200000).toISOString(),
                    type: 'config_change',
                    user: 'admin',
                    ip: '127.0.0.1',
                    severity: 'info',
                    details: 'Modification param√®tres s√©curit√©'
                }
            ];
            
            displayEvents(events);
        }

        function displayEvents(events) {
            const container = document.getElementById('eventsList');
            
            container.innerHTML = events.map(event => `
                <div class="event-item ${event.severity}">
                    <div class="event-header">
                        <span class="event-type">${event.type}</span>
                        <span class="event-time">${new Date(event.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="event-details">
                        <span>Utilisateur: ${event.user}</span>
                        <span>IP: ${event.ip}</span>
                        <span class="severity-badge ${event.severity}">${event.severity}</span>
                    </div>
                    <div class="event-description">${event.details}</div>
                </div>
            `).join('');
        }

        function updateSecurityOverview() {
            document.getElementById('alertCount').textContent = '2';
        }

        function refreshEvents() {
            loadSecurityEvents();
        }

        function filterEvents() {
            // Impl√©mentation du filtrage
            loadSecurityEvents();
        }

        function rotateKeys() {
            if (confirm('Effectuer une rotation manuelle des cl√©s de chiffrement ?')) {
                alert('Rotation des cl√©s effectu√©e avec succ√®s');
            }
        }

        function generateReport(type) {
            alert(`G√©n√©ration du rapport ${type} en cours...`);
        }

        function exportAudit() {
            alert('Export du trail d\'audit en cours...');
        }

        function loadApiKeys() {
            // Simulation de cl√©s API
            const keys = [
                {
                    id: 1,
                    name: 'Integration CRM',
                    key: 'sk-*********************abc123',
                    permissions: ['read', 'write'],
                    rate_limit: 100,
                    last_used: '2024-01-15 10:30:00',
                    is_active: true
                }
            ];
            
            displayApiKeys(keys);
        }

        function displayApiKeys(keys) {
            const container = document.getElementById('apiKeysList');
            
            if (keys.length === 0) {
                container.innerHTML = '<p class="no-data">Aucune cl√© API</p>';
                return;
            }
            
            container.innerHTML = keys.map(key => `
                <div class="api-key-item">
                    <div class="key-header">
                        <h4>${key.name}</h4>
                        <span class="key-status ${key.is_active ? 'active' : 'inactive'}">
                            ${key.is_active ? 'Actif' : 'Inactif'}
                        </span>
                    </div>
                    <div class="key-details">
                        <code>${key.key}</code>
                        <span>Permissions: ${key.permissions.join(', ')}</span>
                        <span>Limite: ${key.rate_limit} req/h</span>
                        <span>Derni√®re utilisation: ${key.last_used}</span>
                    </div>
                    <div class="key-actions">
                        <button onclick="toggleKey(${key.id})" class="btn-small">
                            ${key.is_active ? 'D√©sactiver' : 'Activer'}
                        </button>
                        <button onclick="regenerateKey(${key.id})" class="btn-small">R√©g√©n√©rer</button>
                        <button onclick="deleteKey(${key.id})" class="btn-small btn-danger">Supprimer</button>
                    </div>
                </div>
            `).join('');
        }

        function showCreateKey() {
            document.getElementById('createKeyForm').classList.remove('hidden');
        }

        function cancelCreateKey() {
            document.getElementById('createKeyForm').classList.add('hidden');
        }
    </script>

    <style>
        .security-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .security-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .security-icon {
            font-size: 2em;
        }
        .security-level.high {
            color: #28a745;
            font-weight: bold;
        }
        .security-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
        }
        .tab-btn.active {
            background: #007bff;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .event-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
        }
        .event-item.warning {
            border-left-color: #ffc107;
        }
        .event-item.error {
            border-left-color: #dc3545;
        }
        .event-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .event-details {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #666;
        }
        .severity-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
        }
        .severity-badge.info { background: #d1ecf1; }
        .severity-badge.warning { background: #fff3cd; }
        .severity-badge.error { background: #f8d7da; }
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        .setting-group h3 {
            margin-bottom: 15px;
            color: #007bff;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .api-key-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .key-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .key-status.active {
            color: #28a745;
        }
        .key-status.inactive {
            color: #dc3545;
        }
        .key-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .key-details code {
            background: #f8f9fa;
            padding: 5px;
            border-radius: 4px;
        }
        .key-actions {
            display: flex;
            gap: 10px;
        }
        .permissions-grid {
            display: flex;
            gap: 15px;
        }
    </style>
</body>
</html>