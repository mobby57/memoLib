<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envoi en Lot - IAPosteManager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-6">üì¨ Envoi d'Emails en Lot</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Configuration -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold mb-4">Configuration</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Sujet</label>
                    <input type="text" id="batchSubject" class="w-full p-3 border rounded-lg" placeholder="Sujet de l'email">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Corps de l'email</label>
                    <textarea id="batchBody" class="w-full p-3 border rounded-lg" rows="6" placeholder="Corps de l'email..."></textarea>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Liste des destinataires</label>
                    <textarea id="recipientsList" class="w-full p-3 border rounded-lg" rows="8" placeholder="Un email par ligne:&#10;email1@example.com&#10;email2@example.com&#10;..."></textarea>
                    <div class="text-sm text-gray-600 mt-1">Un email par ligne</div>
                </div>
                
                <button onclick="sendBatch()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 w-full">
                    üì§ Envoyer en Lot
                </button>
            </div>
            
            <!-- R√©sultats -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold mb-4">R√©sultats</h2>
                
                <div id="batchStats" class="grid grid-cols-3 gap-4 mb-6 hidden">
                    <div class="text-center p-3 bg-blue-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="totalCount">0</div>
                        <div class="text-sm text-gray-600">Total</div>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="successCount">0</div>
                        <div class="text-sm text-gray-600">Succ√®s</div>
                    </div>
                    <div class="text-center p-3 bg-red-50 rounded-lg">
                        <div class="text-2xl font-bold text-red-600" id="failedCount">0</div>
                        <div class="text-sm text-gray-600">√âchecs</div>
                    </div>
                </div>
                
                <div id="batchResults" class="space-y-2 max-h-96 overflow-y-auto">
                    <div class="text-gray-400 text-center py-8">
                        Les r√©sultats appara√Ætront ici apr√®s l'envoi
                    </div>
                </div>
                
                <div class="mt-4 flex gap-2">
                    <button onclick="exportResults()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" disabled id="exportBtn">
                        üìä Exporter
                    </button>
                    <button onclick="clearResults()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" disabled id="clearBtn">
                        üóëÔ∏è Effacer
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Conseils -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-6">
            <h3 class="font-bold mb-2">üí° Conseils</h3>
            <ul class="text-sm space-y-1">
                <li>‚Ä¢ Maximum 100 emails par lot</li>
                <li>‚Ä¢ V√©rifiez vos adresses email avant l'envoi</li>
                <li>‚Ä¢ Utilisez des variables comme {nom} dans le corps</li>
                <li>‚Ä¢ Respectez les r√®gles anti-spam</li>
            </ul>
        </div>
    </div>

    <script>
        let batchResults = [];
        
        async function sendBatch() {
            const subject = document.getElementById('batchSubject').value;
            const body = document.getElementById('batchBody').value;
            const recipientsText = document.getElementById('recipientsList').value;
            
            if (!subject || !body || !recipientsText) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            // Parser les emails
            const emails = recipientsText.split('\n')
                .map(email => email.trim())
                .filter(email => email && email.includes('@'))
                .map(email => ({
                    to: email,
                    subject: subject,
                    body: body
                }));
            
            if (emails.length === 0) {
                alert('Aucune adresse email valide trouv√©e');
                return;
            }
            
            if (emails.length > 100) {
                alert('Maximum 100 emails par lot');
                return;
            }
            
            // Afficher les stats
            document.getElementById('totalCount').textContent = emails.length;
            document.getElementById('successCount').textContent = '0';
            document.getElementById('failedCount').textContent = '0';
            document.getElementById('batchStats').classList.remove('hidden');
            
            // Vider les r√©sultats pr√©c√©dents
            const resultsDiv = document.getElementById('batchResults');
            resultsDiv.innerHTML = '<div class="text-center py-4">Envoi en cours...</div>';
            
            try {
                const response = await fetch('/api/email/send-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emails })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    batchResults = data.results;
                    displayResults(data);
                    
                    // Activer les boutons
                    document.getElementById('exportBtn').disabled = false;
                    document.getElementById('clearBtn').disabled = false;
                } else {
                    alert('Erreur: ' + data.error);
                }
            } catch (error) {
                alert('Erreur de connexion');
                resultsDiv.innerHTML = '<div class="text-red-500 text-center py-4">Erreur de connexion</div>';
            }
        }
        
        function displayResults(data) {
            document.getElementById('successCount').textContent = data.success_count;
            document.getElementById('failedCount').textContent = data.failed_count;
            
            const resultsDiv = document.getElementById('batchResults');
            resultsDiv.innerHTML = '';
            
            data.results.forEach((result, index) => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border ${result.success ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`;
                
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="font-medium">${result.to}</div>
                        <div class="text-sm ${result.success ? 'text-green-600' : 'text-red-600'}">
                            ${result.success ? '‚úÖ Envoy√©' : '‚ùå √âchec'}
                        </div>
                    </div>
                    ${!result.success ? `<div class="text-sm text-red-600 mt-1">${result.error}</div>` : ''}
                `;
                
                resultsDiv.appendChild(div);
            });
        }
        
        function exportResults() {
            if (batchResults.length === 0) return;
            
            const csv = 'Email,Status,Error\n' + 
                batchResults.map(r => `${r.to},${r.success ? 'Success' : 'Failed'},"${r.error || ''}"`).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `batch_results_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function clearResults() {
            batchResults = [];
            document.getElementById('batchResults').innerHTML = '<div class="text-gray-400 text-center py-8">Les r√©sultats appara√Ætront ici apr√®s l\'envoi</div>';
            document.getElementById('batchStats').classList.add('hidden');
            document.getElementById('exportBtn').disabled = true;
            document.getElementById('clearBtn').disabled = true;
        }
    </script>
</body>
</html>