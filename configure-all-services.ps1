# =============================================================================\n# Configuration Automatique des Services Externes MemoLib\n# =============================================================================\n# Script PowerShell pour configurer toutes les cl√©s d'API manquantes\n# =============================================================================\n\nWrite-Host \"üöÄ Configuration des Services Externes MemoLib\" -ForegroundColor Cyan\nWrite-Host \"============================================\" -ForegroundColor Cyan\n\n# V√©rifier si on est dans le bon r√©pertoire\nif (-not (Test-Path \"MemoLib.Api.csproj\")) {\n    Write-Host \"‚ùå Erreur: Ex√©cutez ce script depuis le r√©pertoire MemoLib.Api\" -ForegroundColor Red\n    exit 1\n}\n\n# =============================================================================\n# PHASE 1: SERVICES ESSENTIELS (GRATUITS)\n# =============================================================================\n\nWrite-Host \"\\nüìß PHASE 1: Services Essentiels (Gratuits)\" -ForegroundColor Green\nWrite-Host \"==========================================\" -ForegroundColor Green\n\n# Gmail App Password\nWrite-Host \"\\n1. Gmail App Password\" -ForegroundColor Yellow\nWrite-Host \"   Guide: https://myaccount.google.com/apppasswords\"\n$gmailPassword = Read-Host \"   Entrez votre mot de passe d'application Gmail (ou ENTER pour ignorer)\"\nif ($gmailPassword) {\n    dotnet user-secrets set \"EmailMonitor:Password\" $gmailPassword\n    Write-Host \"   ‚úÖ Gmail configur√©\" -ForegroundColor Green\n} else {\n    Write-Host \"   ‚è≠Ô∏è Gmail ignor√©\" -ForegroundColor Yellow\n}\n\n# Legifrance PISTE\nWrite-Host \"\\n2. Legifrance PISTE API\" -ForegroundColor Yellow\nWrite-Host \"   Inscription: https://piste.gouv.fr/\"\n$legifranceClientId = Read-Host \"   Client ID Sandbox (ou ENTER pour ignorer)\"\nif ($legifranceClientId) {\n    $legifranceClientSecret = Read-Host \"   Client Secret Sandbox\"\n    dotnet user-secrets set \"Legifrance:Sandbox:ClientId\" $legifranceClientId\n    dotnet user-secrets set \"Legifrance:Sandbox:ClientSecret\" $legifranceClientSecret\n    Write-Host \"   ‚úÖ Legifrance Sandbox configur√©\" -ForegroundColor Green\n    \n    $prodChoice = Read-Host \"   Configurer aussi la production? (y/N)\"\n    if ($prodChoice -eq \"y\" -or $prodChoice -eq \"Y\") {\n        $legifranceProdClientId = Read-Host \"   Client ID Production\"\n        $legifranceProdClientSecret = Read-Host \"   Client Secret Production\"\n        dotnet user-secrets set \"Legifrance:Production:ClientId\" $legifranceProdClientId\n        dotnet user-secrets set \"Legifrance:Production:ClientSecret\" $legifranceProdClientSecret\n        Write-Host \"   ‚úÖ Legifrance Production configur√©\" -ForegroundColor Green\n    }\n} else {\n    Write-Host \"   ‚è≠Ô∏è Legifrance ignor√©\" -ForegroundColor Yellow\n}\n\n# JWT Secrets\nWrite-Host \"\\n3. JWT & NextAuth Secrets\" -ForegroundColor Yellow\n$generateSecrets = Read-Host \"   G√©n√©rer de nouveaux secrets JWT? (Y/n)\"\nif ($generateSecrets -ne \"n\" -and $generateSecrets -ne \"N\") {\n    # G√©n√©rer un secret JWT s√©curis√©\n    $jwtSecret = [System.Convert]::ToBase64String([System.Security.Cryptography.RandomNumberGenerator]::GetBytes(64))\n    $nextAuthSecret = [System.Convert]::ToBase64String([System.Security.Cryptography.RandomNumberGenerator]::GetBytes(32))\n    \n    dotnet user-secrets set \"JwtSettings:SecretKey\" $jwtSecret\n    dotnet user-secrets set \"NextAuth:Secret\" $nextAuthSecret\n    \n    Write-Host \"   ‚úÖ Secrets JWT g√©n√©r√©s et configur√©s\" -ForegroundColor Green\n} else {\n    Write-Host \"   ‚è≠Ô∏è Secrets JWT ignor√©s\" -ForegroundColor Yellow\n}\n\n# Telegram Bot\nWrite-Host \"\\n4. Telegram Bot\" -ForegroundColor Yellow\nWrite-Host \"   Cr√©ation: Contactez @BotFather sur Telegram\"\n$telegramToken = Read-Host \"   Token du bot (ou ENTER pour ignorer)\"\nif ($telegramToken) {\n    dotnet user-secrets set \"Telegram:BotToken\" $telegramToken\n    Write-Host \"   ‚úÖ Telegram configur√©\" -ForegroundColor Green\n} else {\n    Write-Host \"   ‚è≠Ô∏è Telegram ignor√©\" -ForegroundColor Yellow\n}\n\n# =============================================================================\n# PHASE 2: SERVICES IA ET MESSAGERIE (PAYANTS)\n# =============================================================================\n\nWrite-Host \"\\nü§ñ PHASE 2: IA et Messagerie (Payants)\" -ForegroundColor Blue\nWrite-Host \"====================================\" -ForegroundColor Blue\n\n$configurePhase2 = Read-Host \"\\nConfigurer les services payants? (y/N)\"\nif ($configurePhase2 -eq \"y\" -or $configurePhase2 -eq \"Y\") {\n    \n    # OpenAI\n    Write-Host \"\\n1. OpenAI API (~20‚Ç¨/mois)\" -ForegroundColor Yellow\n    Write-Host \"   Inscription: https://platform.openai.com/\"\n    $openaiKey = Read-Host \"   Cl√© API OpenAI (sk-...) (ou ENTER pour ignorer)\"\n    if ($openaiKey) {\n        # Configuration pour AI Service\n        $aiServiceEnvPath = \"ai-service\\.env\"\n        if (-not (Test-Path $aiServiceEnvPath)) {\n            Copy-Item \"ai-service\\.env.example\" $aiServiceEnvPath\n        }\n        \n        # Remplacer la cl√© dans le fichier .env\n        $envContent = Get-Content $aiServiceEnvPath\n        $envContent = $envContent -replace \"OPENAI_API_KEY=.*\", \"OPENAI_API_KEY=$openaiKey\"\n        $envContent | Set-Content $aiServiceEnvPath\n        \n        Write-Host \"   ‚úÖ OpenAI configur√© dans ai-service/.env\" -ForegroundColor Green\n    } else {\n        Write-Host \"   ‚è≠Ô∏è OpenAI ignor√©\" -ForegroundColor Yellow\n    }\n    \n    # Twilio (SMS + WhatsApp)\n    Write-Host \"\\n2. Twilio SMS/WhatsApp (~10‚Ç¨/mois)\" -ForegroundColor Yellow\n    Write-Host \"   Inscription: https://www.twilio.com/\"\n    $twilioAccountSid = Read-Host \"   Account SID (ou ENTER pour ignorer)\"\n    if ($twilioAccountSid) {\n        $twilioAuthToken = Read-Host \"   Auth Token\"\n        $twilioPhoneNumber = Read-Host \"   Num√©ro de t√©l√©phone (+33...)\"\n        \n        dotnet user-secrets set \"Twilio:AccountSid\" $twilioAccountSid\n        dotnet user-secrets set \"Twilio:AuthToken\" $twilioAuthToken\n        dotnet user-secrets set \"Twilio:PhoneNumber\" $twilioPhoneNumber\n        \n        $whatsappNumber = Read-Host \"   Num√©ro WhatsApp (optionnel, ENTER pour ignorer)\"\n        if ($whatsappNumber) {\n            dotnet user-secrets set \"Twilio:WhatsAppNumber\" $whatsappNumber\n        }\n        \n        Write-Host \"   ‚úÖ Twilio configur√©\" -ForegroundColor Green\n    } else {\n        Write-Host \"   ‚è≠Ô∏è Twilio ignor√©\" -ForegroundColor Yellow\n    }\n    \n    # Vonage (alternative SMS)\n    Write-Host \"\\n3. Vonage SMS (alternative √† Twilio)\" -ForegroundColor Yellow\n    $vonageChoice = Read-Host \"   Configurer Vonage au lieu de Twilio? (y/N)\"\n    if ($vonageChoice -eq \"y\" -or $vonageChoice -eq \"Y\") {\n        $vonageApiKey = Read-Host \"   API Key Vonage\"\n        $vonageApiSecret = Read-Host \"   API Secret Vonage\"\n        $vonageFrom = Read-Host \"   Nom/Num√©ro exp√©diteur\"\n        \n        dotnet user-secrets set \"Vonage:ApiKey\" $vonageApiKey\n        dotnet user-secrets set \"Vonage:ApiSecret\" $vonageApiSecret\n        dotnet user-secrets set \"Vonage:From\" $vonageFrom\n        \n        # Changer le provider\n        dotnet user-secrets set \"Messaging:SmsProvider\" \"vonage\"\n        \n        Write-Host \"   ‚úÖ Vonage configur√©\" -ForegroundColor Green\n    }\n}\n\n# =============================================================================\n# PHASE 3: INFRASTRUCTURE PRODUCTION (CLOUD)\n# =============================================================================\n\nWrite-Host \"\\n‚òÅÔ∏è PHASE 3: Infrastructure Production\" -ForegroundColor Magenta\nWrite-Host \"==================================\" -ForegroundColor Magenta\n\n$configurePhase3 = Read-Host \"\\nConfigurer l'infrastructure cloud? (y/N)\"\nif ($configurePhase3 -eq \"y\" -or $configurePhase3 -eq \"Y\") {\n    \n    # PostgreSQL\n    Write-Host \"\\n1. Base de donn√©es PostgreSQL\" -ForegroundColor Yellow\n    Write-Host \"   Options: Supabase (gratuit), Azure (~50‚Ç¨/mois), AWS RDS (~40‚Ç¨/mois)\"\n    $postgresUrl = Read-Host \"   URL de connexion PostgreSQL (ou ENTER pour garder SQLite)\"\n    if ($postgresUrl) {\n        dotnet user-secrets set \"ConnectionStrings:Default\" $postgresUrl\n        Write-Host \"   ‚úÖ PostgreSQL configur√©\" -ForegroundColor Green\n        Write-Host \"   ‚ö†Ô∏è N'oubliez pas de migrer: dotnet ef database update\" -ForegroundColor Yellow\n    }\n    \n    # Redis\n    Write-Host \"\\n2. Cache Redis\" -ForegroundColor Yellow\n    Write-Host \"   Options: Redis Cloud (gratuit 30MB), Azure Cache (~20‚Ç¨/mois)\"\n    $redisUrl = Read-Host \"   URL Redis (ou ENTER pour ignorer)\"\n    if ($redisUrl) {\n        dotnet user-secrets set \"Redis:ConnectionString\" $redisUrl\n        Write-Host \"   ‚úÖ Redis configur√©\" -ForegroundColor Green\n    }\n    \n    # Sentry (Monitoring)\n    Write-Host \"\\n3. Sentry Monitoring\" -ForegroundColor Yellow\n    Write-Host \"   Inscription: https://sentry.io/ (gratuit jusqu'√† 10k erreurs/mois)\"\n    $sentryDsn = Read-Host \"   Sentry DSN (ou ENTER pour ignorer)\"\n    if ($sentryDsn) {\n        # Ajouter au fichier .env du AI Service\n        $aiServiceEnvPath = \"ai-service\\.env\"\n        if (Test-Path $aiServiceEnvPath) {\n            Add-Content $aiServiceEnvPath \"SENTRY_DSN=$sentryDsn\"\n        }\n        dotnet user-secrets set \"Sentry:Dsn\" $sentryDsn\n        Write-Host \"   ‚úÖ Sentry configur√©\" -ForegroundColor Green\n    }\n}\n\n# =============================================================================\n# R√âSUM√â ET V√âRIFICATION\n# =============================================================================\n\nWrite-Host \"\\nüìã R√âSUM√â DE LA CONFIGURATION\" -ForegroundColor Cyan\nWrite-Host \"============================\" -ForegroundColor Cyan\n\n# Lister les secrets configur√©s\nWrite-Host \"\\nüîë Secrets configur√©s:\"\ntry {\n    $secrets = dotnet user-secrets list 2>$null\n    if ($secrets) {\n        $secrets | ForEach-Object {\n            if ($_ -match \"^([^=]+) = (.*)$\") {\n                $key = $matches[1]\n                $value = $matches[2]\n                # Masquer les valeurs sensibles\n                if ($value.Length -gt 10) {\n                    $maskedValue = $value.Substring(0, 4) + \"***\" + $value.Substring($value.Length - 4)\n                } else {\n                    $maskedValue = \"***\"\n                }\n                Write-Host \"   ‚úÖ $key = $maskedValue\" -ForegroundColor Green\n            }\n        }\n    } else {\n        Write-Host \"   ‚ÑπÔ∏è Aucun secret configur√©\" -ForegroundColor Yellow\n    }\n} catch {\n    Write-Host \"   ‚ö†Ô∏è Impossible de lister les secrets\" -ForegroundColor Yellow\n}\n\n# V√©rifier le fichier AI Service\nWrite-Host \"\\nü§ñ AI Service (.env):\"\n$aiServiceEnvPath = \"ai-service\\.env\"\nif (Test-Path $aiServiceEnvPath) {\n    Write-Host \"   ‚úÖ Fichier ai-service/.env existe\" -ForegroundColor Green\n    $envContent = Get-Content $aiServiceEnvPath\n    $envContent | ForEach-Object {\n        if ($_ -match \"^([^=]+)=(.*)$\" -and -not $_.StartsWith(\"#\")) {\n            $key = $matches[1]\n            $value = $matches[2]\n            if ($value -and $value -ne \"\" -and -not $value.Contains(\"your-\") -and -not $value.Contains(\"sk-your\")) {\n                Write-Host \"   ‚úÖ $key configur√©\" -ForegroundColor Green\n            } else {\n                Write-Host \"   ‚ùå $key manquant\" -ForegroundColor Red\n            }\n        }\n    }\n} else {\n    Write-Host \"   ‚ùå Fichier ai-service/.env manquant\" -ForegroundColor Red\n    Write-Host \"   üí° Copiez ai-service/.env.example vers ai-service/.env\" -ForegroundColor Yellow\n}\n\n# =============================================================================\n# PROCHAINES √âTAPES\n# =============================================================================\n\nWrite-Host \"\\nüéØ PROCHAINES √âTAPES\" -ForegroundColor Cyan\nWrite-Host \"==================\" -ForegroundColor Cyan\n\nWrite-Host \"\\n1. Tester l'application:\"\nWrite-Host \"   dotnet run\" -ForegroundColor Yellow\n\nWrite-Host \"\\n2. V√©rifier les services:\"\nWrite-Host \"   - Email: Envoyez un test depuis l'interface\" -ForegroundColor Yellow\nWrite-Host \"   - Legifrance: Testez une recherche juridique\" -ForegroundColor Yellow\nWrite-Host \"   - IA: Testez l'analyse s√©mantique\" -ForegroundColor Yellow\n\nWrite-Host \"\\n3. Documentation compl√®te:\"\nWrite-Host \"   - CLES_ENV_EXTERNES_MANQUANTES.md\" -ForegroundColor Yellow\nWrite-Host \"   - README.md (section Configuration)\" -ForegroundColor Yellow\n\nWrite-Host \"\\n4. Monitoring:\"\nWrite-Host \"   - Consultez les logs pour v√©rifier les connexions\" -ForegroundColor Yellow\nWrite-Host \"   - Surveillez les quotas des APIs\" -ForegroundColor Yellow\n\nWrite-Host \"\\n‚úÖ Configuration termin√©e!\" -ForegroundColor Green\nWrite-Host \"\\nüí° Conseil: Commencez par tester les services gratuits (Gmail, Legifrance, Telegram)\" -ForegroundColor Cyan\nWrite-Host \"   puis ajoutez les services payants selon vos besoins.\" -ForegroundColor Cyan\n\nWrite-Host \"\\nüìû Support: Consultez CLES_ENV_EXTERNES_MANQUANTES.md pour plus de d√©tails\" -ForegroundColor Blue\n