<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self';">
    <title>MemoLib - D√©monstration Client</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h2 { color: #667eea; margin-bottom: 15px; }
        .btn { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; }
        .btn:hover { background: #5568d3; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        .input-group input, .input-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .result { background: #f8f9fa; border-left: 4px solid #667eea; padding: 15px; margin-top: 15px; border-radius: 5px; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .stat-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-box .number { font-size: 2.5em; font-weight: bold; }
        .stat-box .label { font-size: 0.9em; opacity: 0.9; margin-top: 5px; }
        .event-list { max-height: 400px; overflow-y: auto; }
        .event-item { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 5px; border-left: 3px solid #667eea; }
        .event-item .date { color: #666; font-size: 0.9em; }
        .event-item .content { margin-top: 5px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #e9ecef; border: none; border-radius: 5px; cursor: pointer; }
        .tab.active { background: #667eea; color: white; }
        .hidden { display: none; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .quickbar { background: white; border-radius: 10px; padding: 14px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #888; display: inline-block; }
        .status-dot.ok { background: #1f8f3a; }
        .status-dot.err { background: #c62828; }
        .search-options { display: flex; gap: 14px; margin-top: 8px; flex-wrap: wrap; }
        .search-options label { display: inline-flex; align-items: center; gap: 6px; color: #555; font-size: 13px; }
        .search-badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef2ff; color: #3b4cca; font-size: 12px; margin-left: 8px; }
        .search-ids { font-size: 12px; color: #666; margin-top: 6px; word-break: break-all; }
        .case-item { cursor: pointer; transition: background 0.2s; }
        .case-item:hover { background: #f0f0f0; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 10px; max-width: 800px; max-height: 80vh; overflow-y: auto; }
        .modal-close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .modal-close:hover { color: #000; }
        .meta-chip { display:inline-block; padding:3px 8px; border-radius:999px; background:#eef2ff; color:#3744a0; font-size:12px; margin:4px 6px 0 0; }
        .annex-list { margin-top:8px; padding-left:18px; color:#444; }
        .guide-box { background:#eef7ff; border-left:4px solid #4a6ee0; padding:10px; border-radius:6px; margin:10px 0 14px 0; font-size:13px; color:#244; }
        .api-banner { margin: 10px 0 14px 0; padding: 10px 12px; border-radius: 6px; border-left: 4px solid #999; background: #f3f4f6; color: #333; font-size: 13px; }
        .api-banner.ok { border-left-color: #1f8f3a; background: #e8f7ed; color: #14532d; }
        .api-banner.err { border-left-color: #c62828; background: #fdecec; color: #7f1d1d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ MemoLib</h1>
            <p>Votre assistant simple pour suivre vos emails, clients et dossiers</p>
        </div>

        <div class="guide-box">
            <strong>Comment d√©marrer (2 minutes)</strong><br>
            1) Allez dans <strong>üîê Authentification</strong> et connectez-vous.<br>
            2) Ouvrez <strong>üìß Ingestion Email</strong> puis cliquez sur <strong>Scanner tous les emails maintenant</strong>.<br>
            3) Consultez <strong>üìÅ Gestion Dossiers</strong> et <strong>üîç Recherche</strong> pour retrouver vos messages.<br>
            4) Utilisez <strong>‚ö†Ô∏è Alertes</strong> pour traiter les points √† v√©rifier.
        </div>

        <div class="quickbar">
            <button class="btn" id="installBtn">Installer sur PC/Mac</button>
            <button class="btn" id="stopBtn">Arr√™ter l'application</button>
            <button class="btn" onclick="openAnomalyCenter()">Centre anomalies</button>
            <button class="btn" onclick="showAdvancedDashboard()" style="background:#28a745;">üìä Dashboard Avanc√©</button>
            <button class="btn" onclick="initDemoData()" style="background:#28a745;">Initialiser base d√©mo</button>
            <span id="statusDot" class="status-dot"></span>
            <strong>√âtat service:</strong>
            <span id="serviceStatusText">V√©rification...</span>
            <strong>Anomalies ouvertes:</strong>
            <span id="anomalyCountText">-</span>
            <strong id="currentUserDisplay" style="color:#667eea; margin-left:15px;"></strong>
            <span id="accessModeText"></span>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('auth')">üîê Authentification</button>
            <button class="tab" onclick="showTab('ingest')">üìß Ingestion Email</button>
            <button id="alertsTabButton" class="tab" onclick="showTab('alerts')">‚ö†Ô∏è Alertes</button>
            <button class="tab" onclick="showTab('search')">üîç Recherche Intelligente</button>
            <button class="tab" onclick="showTab('client')">üë§ Clients</button>
            <button class="tab" onclick="showTab('client-detail')">üßë‚Äçüíº Client d√©taill√©</button>
            <button class="tab" onclick="showTab('cases')">üìÅ Gestion Dossiers</button>
            <button class="tab" onclick="showTab('stats')">üìä Analytics</button>
            <button class="tab" onclick="showTab('export')">üì§ Export</button>
            <button class="tab" onclick="showTab('audit')">üßæ Audit</button>
            <button class="tab" onclick="showTab('team')">‚öñÔ∏è √âquipe</button>
        </div>

        <!-- Auth Tab -->
        <div id="auth-tab" class="tab-content">
            <div class="card">
                <h2>Inscription</h2>
                <p style="color:#666; margin-bottom:15px;">üìù Cr√©ez votre compte en 30 secondes. Une fois cr√©√©, vous pourrez scanner vos emails et retrouver facilement vos dossiers.</p>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="reg-email" placeholder="avocat@cabinet.fr" autocomplete="off">
                </div>
                <div class="input-group">
                    <label>Mot de passe (min 8 caract√®res, majuscules, minuscules, chiffres)</label>
                    <input type="password" id="reg-password" placeholder="SecurePass123!" autocomplete="new-password">
                </div>
                <div class="input-group">
                    <label>Nom</label>
                    <input type="text" id="reg-name" placeholder="Jean Dupont" autocomplete="off">
                </div>
                <button class="btn" onclick="register()">S'inscrire</button>
                <div id="reg-result"></div>
            </div>

            <div class="card">
                <h2>Connexion</h2>
                <p style="color:#666; margin-bottom:15px;">üîë Connectez-vous pour acc√©der √† vos donn√©es. Si vous √™tes nouveau, utilisez l'inscription juste au-dessus.</p>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="login-email" placeholder="avocat@cabinet.fr" autocomplete="off">
                </div>
                <div class="input-group">
                    <label>Mot de passe</label>
                    <input type="password" id="login-password" placeholder="SecurePass123!" autocomplete="current-password">
                </div>
                <button class="btn" onclick="login()">Se connecter</button>
                <div id="login-result"></div>
            </div>
        </div>

        <!-- Ingest Tab -->
        <div id="ingest-tab" class="tab-content hidden">
            <div class="card">
                <h2>Scan manuel emails</h2>
                <p style="color:#666; margin-bottom:15px;">üîÑ Ce bouton lit votre bo√Æte mail et importe vos emails dans MemoLib. Vous verrez ensuite un r√©sum√© clair de ce qui a √©t√© trouv√©.</p>
                <button class="btn" onclick="manualEmailScan()" style="background:#ff9800;">Scanner tous les emails maintenant</button>
                <button class="btn" onclick="checkDatabaseStats()" style="background:#2196F3;">V√©rifier la base de donn√©es</button>
                <div id="scan-result"></div>
            </div>
            <div class="card">
                <h2>Ing√©rer un email de test</h2>
                <p style="color:#666; margin-bottom:15px;">üß™ <strong>Mode test</strong> : Simulez la r√©ception d'un email sans avoir √† l'envoyer r√©ellement. Pratique pour tester le syst√®me avant de connecter votre vraie bo√Æte mail.</p>
                <div class="guide-box">
                    <strong>üí° Comment √ßa marche ?</strong><br>
                    1. Remplissez les champs ci-dessous (comme si c'√©tait un email re√ßu)<br>
                    2. Cliquez sur "Ing√©rer"<br>
                    3. MemoLib va cr√©er automatiquement un dossier et un client<br>
                    <br>
                    <strong>Exemple d'usage :</strong> Vous voulez voir comment le syst√®me traite un email d'un client nomm√© "Sophie Martin" ? Mettez son email dans "De", √©crivez un sujet et un message, puis cliquez sur Ing√©rer. Le syst√®me va cr√©er le dossier automatiquement !
                </div>
                <div class="input-group">
                    <label>De</label>
                    <input type="email" id="email-from" placeholder="client@example.com">
                </div>
                <div class="input-group">
                    <label>Sujet</label>
                    <input type="text" id="email-subject" placeholder="Demande d'information">
                </div>
                <div class="input-group">
                    <label>Corps du message</label>
                    <textarea id="email-body" rows="5" placeholder="Contenu de l'email..."></textarea>
                </div>
                <div class="input-group">
                    <label>ID externe (optionnel)</label>
                    <input type="text" id="email-external" placeholder="DOSSIER-2024-001">
                </div>
                <button class="btn" onclick="ingestEmail()">Ing√©rer</button>
                <div id="ingest-result"></div>
            </div>
        </div>

        <!-- Search Tab -->
        <div id="search-tab" class="tab-content hidden">
            <div class="card">
                <h2>Recherche d'emails</h2>
                <p style="color:#666; margin-bottom:15px;">üîç Tapez simplement un mot, une phrase, un nom ou un sujet pour retrouver rapidement les emails concern√©s.</p>
                <div class="input-group">
                    <label>Recherche textuelle</label>
                    <input type="text" id="search-text" placeholder="Mots-cl√©s...">
                    <div class="search-options">
                        <label><input type="checkbox" id="search-group-duplicates" checked> Regrouper les doublons</label>
                        <label><input type="checkbox" id="search-show-ids"> Afficher les IDs techniques</label>
                        <label><input type="checkbox" id="search-show-full-content" checked> Afficher le contenu complet</label>
                    </div>
                </div>
                <button class="btn" onclick="searchEvents()">Rechercher</button>
                <button class="btn" onclick="loadAllReceivedEmails()" style="background:#1f8f3a;">Voir tous les emails re√ßus</button>
                <button class="btn" onclick="generateEmbeddings()">Pr√©parer la recherche intelligente</button>
                <button class="btn" onclick="embeddingSearch()">Recherche par similarit√©</button>
                <button class="btn" onclick="semanticSearch()">Recherche par sens (IA)</button>
                <div class="guide-box">Astuce: commencez par <strong>Voir tous les emails re√ßus</strong>, puis utilisez la recherche par similarit√©/sens pour retrouver des messages proches m√™me sans mots exacts.</div>
                <div id="search-result"></div>
            </div>
        </div>

        <!-- Client Tab -->
        <div id="client-tab" class="tab-content hidden">
            <div class="card">
                <h2>Clients</h2>
                <p style="color:#666; margin-bottom:12px;">üë§ Cr√©ez et consultez vos fiches clients. MemoLib regroupe automatiquement les doublons pour garder une base propre.</p>
                <div class="input-group">
                    <label>Nom</label>
                    <input type="text" id="client-name" placeholder="Mme Martin">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="client-email" placeholder="client@example.com">
                </div>
                <div class="input-group">
                    <label>T√©l√©phone (optionnel)</label>
                    <input type="text" id="client-phone" placeholder="+33 6 00 00 00 00">
                </div>
                <div class="input-group">
                    <label>Adresse (optionnel)</label>
                    <input type="text" id="client-address" placeholder="12 rue Exemple, Paris">
                </div>
                <button class="btn" onclick="createClient()">Cr√©er client</button>
                <button class="btn" onclick="listClients()">Lister clients</button>
                <button class="btn" onclick="generateDiversifiedClientBase()">G√©n√©rer base diversifi√©e</button>
                <button class="btn" onclick="generateTwentyClientsBase()">G√©n√©rer base 20 clients</button>
                <div id="client-result"></div>
            </div>
        </div>

        <div id="client-detail-tab" class="tab-content hidden">
            <div class="card">
                <h2>Client d√©taill√©</h2>
                <p style="color:#666; margin-bottom:12px;">Vue compl√®te du client: coordonn√©es, dossiers li√©s, derniers √©changes et points √† surveiller.</p>

                <div id="client-detail-empty" class="result">S√©lectionnez un client depuis l‚Äôonglet Clients (clic sur une ligne).</div>

                <div id="client-detail-panel" style="display:none;">
                    <div class="input-group">
                        <label>ID</label>
                        <input type="text" id="detail-client-id" readonly>
                    </div>
                    <div class="input-group">
                        <label>Nom</label>
                        <input type="text" id="detail-client-name">
                    </div>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="detail-client-email">
                    </div>
                    <div class="input-group">
                        <label>T√©l√©phone</label>
                        <input type="text" id="detail-client-phone">
                    </div>
                    <div class="input-group">
                        <label>Adresse</label>
                        <input type="text" id="detail-client-address">
                    </div>
                    <button class="btn" onclick="saveClientDetail()">Enregistrer modifications</button>
                    <button class="btn" onclick="applyClientRule('normalize')">Appliquer r√®gle: normaliser</button>
                    <button class="btn" onclick="applyClientRule('vip')">Appliquer r√®gle: VIP</button>
                    <button class="btn" onclick="showClientDetailRaw()">Voir d√©tail JSON</button>

                    <div id="client-detail-summary"></div>
                    <div id="client-detail-cases"></div>
                    <div id="client-detail-events"></div>
                    <div id="client-detail-result"></div>
                </div>
            </div>
        </div>

        <!-- Cases Tab -->
        <div id="cases-tab" class="tab-content hidden">
            <div class="card">
                <h2>Vue d'ensemble intelligente</h2>
                <p style="color:#666; margin-bottom:15px;">üìä Exploitation compl√®te de votre base: dossiers avec exp√©diteurs, clients avec coordonn√©es, emails r√©cents, statistiques.</p>
                <button class="btn" onclick="loadSmartOverview()" style="background:#28a745;">üöÄ Charger vue intelligente</button>
                <div id="smart-overview-result"></div>
            </div>
            <div class="card">
                <h2>Mes dossiers</h2>
                <p style="color:#666; margin-bottom:15px;">üìÅ Consultez tous vos dossiers cr√©√©s automatiquement lors de l'ingestion d'emails. Cliquez sur un dossier pour voir sa timeline compl√®te avec tous les √©v√©nements associ√©s.</p>
                <div class="search-options" style="margin-bottom:10px;">
                    <label><input type="checkbox" id="cases-group-by-subject" checked> Regrouper par sujet</label>
                </div>
                <button class="btn" onclick="listCases()">Afficher mes dossiers</button>
                <button class="btn" onclick="loadTimelineForFirstCase()">Timeline du 1er dossier</button>
                <button class="btn" style="background:#c62828;" onclick="mergeLegacyCases()">Fusion intelligente (anciens dossiers)</button>
                <div id="cases-result"></div>
            </div>
        </div>

        <!-- Stats Tab -->
        <div id="stats-tab" class="tab-content hidden">
            <div class="card">
                <h2>Statistiques</h2>
                <p style="color:#666; margin-bottom:15px;">üìä Visualisez les statistiques de votre activit√©: nombre total d'emails, jours actifs, r√©partition par type d'√©v√©nement, et s√©v√©rit√© moyenne des incidents.</p>
                <button class="btn" onclick="loadStats()">Charger les statistiques</button>
                <div id="stats-result"></div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="export-tab" class="tab-content hidden">
            <div class="card">
                <h2>Export de donn√©es</h2>
                <p style="color: #666; margin-bottom: 15px;">üì§ Exportez tous vos √©v√©nements au format JSON pour archivage, analyse externe, ou migration. Le fichier contient le texte complet de chaque email.</p>
                <button class="btn" onclick="exportEventsText()">Exporter texte √©v√©nements</button>
                <div id="export-result"></div>
            </div>
        </div>

        <!-- Audit Tab -->
        <div id="audit-tab" class="tab-content hidden">
            <div class="card">
                <h2>Journal d'audit</h2>
                <p style="color:#666; margin-bottom:15px;">üßæ Centre de contr√¥le des anomalies: consultez toutes les anomalies ouvertes (doublons, champs manquants), prenez des actions (ignorer, r√©soudre, supprimer), et visualisez l'historique complet de vos actions. Toutes les actions sont trac√©es.</p>
                <div id="auditApiBanner" class="api-banner">‚è≥ V√©rification de l'API...</div>
                <button class="btn" onclick="loadAnomalyCenter()">Charger centre anomalies</button>
                <button class="btn" onclick="loadAudit()">Charger l'audit</button>
                <div id="anomaly-center-result"></div>
                <div id="audit-result"></div>
            </div>
        </div>

        <!-- Alerts Tab -->
        <div id="alerts-tab" class="tab-content hidden">
            <div class="card">
                <h2>‚ö†Ô∏è Emails n√©cessitant attention</h2>
                <p style="color: #666; margin-bottom: 15px;">‚ö†Ô∏è Aucun email n'est rejet√© par le syst√®me. Les emails avec anomalies (exp√©diteur manquant, sujet vide, doublons) sont signal√©s ici pour que vous d√©cidiez de l'action √† prendre: conserver, corriger, ou supprimer.</p>
                <button class="btn" onclick="loadAlerts()">Afficher les alertes</button>
                <div id="alerts-result"></div>
            </div>
        </div>
    </div>

    <!-- Team Tab -->
    <div id="team-tab" class="tab-content hidden">
        <div class="card">
            <h2>‚öñÔ∏è Gestion d'√âquipe</h2>
            <p>G√©rez les membres de votre cabinet et leurs permissions</p>
            
            <!-- Inviter un membre -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3>‚ûï Inviter un Membre</h3>
                <form id="teamInviteForm">
                    <div class="input-group">
                        <label>Email:</label>
                        <input type="email" id="teamInviteEmail" required>
                    </div>
                    <div class="input-group">
                        <label>R√¥le:</label>
                        <select id="teamInviteRole">
                            <option value="PARTNER">Associ√©</option>
                            <option value="LAWYER">Avocat</option>
                            <option value="PARALEGAL">Juriste</option>
                            <option value="SECRETARY">Secr√©taire</option>
                            <option value="INTERN">Stagiaire</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">Envoyer Invitation</button>
                </form>
                <div id="teamInviteResult"></div>
            </div>
            
            <!-- Membres actuels -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3>üë• Membres de l'√âquipe</h3>
                <div id="teamMembersList">Chargement...</div>
            </div>
            
            <!-- Invitations en attente -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3>‚è≥ Invitations en Attente</h3>
                <div id="teamPendingList">Chargement...</div>
            </div>
        </div>
    </div>

    <script src="questionnaires.js"></script>
    <script src="advanced-features.js"></script>
    <script src="auto-demo.js"></script>
    <script src="team-module.js"></script>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <script>
        const API_URL = (() => {
            const origin = window.location.origin;
            if (origin && /localhost:3000$/i.test(origin)) return 'http://localhost:5078';
            if (origin && origin.startsWith('http')) return origin;
            return 'http://localhost:5078';
        })();
        const UI_MODE = (new URLSearchParams(window.location.search).get('mode') || 'complete').toLowerCase();
        const IS_RESTRICTED = UI_MODE === 'restricted';
        let token = null;
        let installPromptEvent = null;
        let lastCaseId = null;
        let lastEventId = null;
        let selectedClientId = null;
        let selectedClientRaw = null;
        let realtimeDashboard = null;
        let templateManager = null;

        function persistSession(email, jwtToken) {
            if (!jwtToken) return;
            token = jwtToken;
            localStorage.setItem('authToken', jwtToken);
            localStorage.setItem('memolibAuthToken', jwtToken);
            sessionStorage.setItem('authToken', jwtToken);
            if (email) {
                localStorage.setItem('memolibUserEmail', email);
            }
        }

        function restoreSession() {
            const storedToken = localStorage.getItem('authToken')
                || localStorage.getItem('memolibAuthToken')
                || sessionStorage.getItem('authToken');
            const storedEmail = localStorage.getItem('memolibUserEmail');

            if (storedToken) {
                token = storedToken;
            }

            if (storedEmail) {
                updateCurrentUserDisplay(storedEmail);
            }
        }
                function applyAccessMode() {
                    const accessModeText = document.getElementById('accessModeText');
                    if (accessModeText) {
                        accessModeText.textContent = IS_RESTRICTED
                            ? 'Mode acc√®s: restreint (Alertes masqu√©es)'
                            : 'Mode acc√®s: complet';
                    }

                    if (!IS_RESTRICTED) return;

                    const alertsTabButton = document.getElementById('alertsTabButton');
                    // showTab g√®re directement le chargement de l'onglet √©quipe (module team-module.js).
            const text = await response.text();
            if (!text || !text.trim()) return null;

            try {
                return JSON.parse(text);
            } catch {
                return text;
            }
        }

        function extractMetaFromBody(bodyText) {
            const body = (bodyText || '').toString();
            const getMatch = (label) => {
                const regex = new RegExp(`${label}\\s*:\\s*([^\\n\\r]+)`, 'i');
                const match = body.match(regex);
                return match ? match[1].trim() : null;
            };

            const clientId = getMatch('ClientId');
            const clientDbId = getMatch('ClientDbId');
            const annexesRaw = getMatch('Annexes');
            const annexes = annexesRaw ? annexesRaw.split(';').map(x => x.trim()).filter(Boolean) : [];

            const cleanedBody = body
                .replace(/ClientId\s*:[^\n\r]+/gi, '')
                .replace(/ClientDbId\s*:[^\n\r]+/gi, '')
                .replace(/Annexes\s*:[^\n\r]+/gi, '')
                .replace(/\n{2,}/g, '\n')
                .trim();

            return { clientId, clientDbId, annexes, cleanedBody };
        }

        function parseRawPayloadSafe(rawPayload) {
            if (!rawPayload) return {};
            try {
                return typeof rawPayload === 'string' ? JSON.parse(rawPayload) : rawPayload;
            } catch {
                return {};
            }
        }

        function buildReadableEventDigest(payload, occurredAt, options = {}) {
            const includeFullBody = options.includeFullBody === true;
            const from = payload?.from || payload?.From || 'Exp√©diteur non identifi√©';
            const subject = payload?.subject || payload?.Subject || 'Sujet non renseign√©';
            const body = payload?.body || payload?.Body || '';
            const meta = extractMetaFromBody(body);
            const cleaned = (meta.cleanedBody || body || '').trim();
            const shortWhat = includeFullBody ? cleaned : (cleaned.length > 220 ? `${cleaned.substring(0, 220)}...` : cleaned);

            const what = shortWhat || 'Contenu non disponible';
            const when = new Date(occurredAt).toLocaleString('fr-FR');

            let actionStatus = 'Action informative';
            let actionDetail = 'V√©rifier le contenu et rattacher au bon dossier si n√©cessaire.';
            if (meta.annexes.length > 0) {
                actionStatus = 'Action normale';
                actionDetail = 'V√©rifier les annexes et les joindre au dossier.';
            }
            if (meta.clientId) {
                actionStatus = 'Action prioritaire';
                actionDetail = `Ouvrir le dossier client ${meta.clientId} pour traitement.`;
            }

            return {
                who: from,
                when,
                what,
                actionStatus,
                actionDetail,
                meta
            };
        }

        function jumpToClientSearch(clientId) {
            if (!clientId) return;
            const input = document.getElementById('search-text');
            if (input) input.value = clientId;
            showTab('search');
        }

        async function createCaseFromEvent(eventId, encodedTitle) {
            if (!token) {
                alert('Connectez-vous d\'abord');
                return;
            }

            const fallbackTitle = 'Dossier depuis email';
            const suggestedTitle = encodedTitle ? decodeURIComponent(encodedTitle) : fallbackTitle;
            const title = (suggestedTitle || fallbackTitle).trim().substring(0, 180) || fallbackTitle;

            try {
                const createRes = await fetch(`${API_URL}/api/cases`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ title })
                });
                const createdCasePayload = await readResponseDataSafe(createRes);

                if (!createRes.ok) {
                    alert('Impossible de cr√©er le dossier');
                    return;
                }

                const createdCaseId =
                    typeof createdCasePayload === 'string'
                        ? createdCasePayload
                        : createdCasePayload?.id || createdCasePayload?.caseId || createdCasePayload;

                if (!createdCaseId) {
                    alert('Dossier cr√©√© mais identifiant non retourn√© par l‚ÄôAPI');
                    return;
                }

                const attachRes = await fetch(`${API_URL}/api/cases/${createdCaseId}/events/${eventId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!attachRes.ok) {
                    const text = await attachRes.text();
                    alert(`Dossier cr√©√© (${createdCaseId}) mais liaison √©v√©nement en erreur: ${text}`);
                    return;
                }

                showResult('cases-result', `‚úÖ Dossier cr√©√© et √©v√©nement rattach√©: ${createdCaseId}`);
                showTab('cases');
                await listCases();
            } catch (err) {
                alert(`Erreur cr√©ation dossier: ${err.message}`);
            }
        }

        function renderRichEmailBlock(payload, occurredAt, eventId = null, options = {}) {
            const subject = payload?.subject || payload?.Subject || 'N/A';
            const digest = buildReadableEventDigest(payload, occurredAt, options);
            const meta = digest.meta;
            const safeCaseId = payload?.caseId || payload?.CaseId || lastCaseId || 'unknown';

            let html = `<div class="guide-box"><strong>Qui:</strong> ${digest.who}<br><strong>Quand:</strong> ${digest.when}<br><strong>Quoi:</strong> ${digest.what}<br><strong>Statut action:</strong> ${digest.actionStatus}<br><strong>Action conseill√©e:</strong> ${digest.actionDetail}<br><strong>D√©cision finale:</strong> Utilisateur</div>`;
            html += `<div><strong>Sujet:</strong> ${subject}</div>`;

            if (meta.clientId) {
                html += `<span class="meta-chip">ClientId: ${meta.clientId}</span>`;
                html += `<button class="btn" style="padding:6px 10px; font-size:12px;" onclick="jumpToClientSearch('${meta.clientId}')">Rechercher ce client</button>`;
            }
            if (eventId) {
                    html += `<button class="btn" style="padding:6px 10px; font-size:12px;" onclick="createCaseFromEvent('${eventId}', '${encodeURIComponent(subject)}')">Cr√©er dossier depuis cet email</button>`;
                    html += `<button class="btn" style="padding:6px 10px; font-size:12px;" onclick="showEventQuestionnaires('${eventId}', '${safeCaseId}')">üìã Questionnaires</button>`;
                    html += `<button class="btn" style="padding:6px 10px; font-size:12px;" onclick="showTemplateModal('${eventId}', '${meta.cleanedBody}', '${subject}')">üìù R√©ponse IA</button>`;
            }
            if (meta.clientDbId) html += `<span class="meta-chip">ClientDbId: ${meta.clientDbId}</span>`;

            if (meta.annexes.length > 0) {
                html += `<div><strong style="display:block; margin-top:8px;">Annexes (${meta.annexes.length})</strong>`;
                html += `<ul class="annex-list">${meta.annexes.map(a => `<li>${a}</li>`).join('')}</ul></div>`;
            }

            return html;
        }

        async function register() {
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const name = document.getElementById('reg-name').value;

            try {
                const res = await apiFetchWithFallback('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, name, role: 'AVOCAT', plan: 'CABINET' })
                });
                const data = await res.json();
                if (res.ok) {
                    showResult('reg-result', `‚úÖ Compte cr√©√© avec succ√®s! ID: ${data.id}`);
                    document.getElementById('login-email').value = email;
                    document.getElementById('login-password').value = password;
                } else {
                    showResult('reg-result', `‚ùå Erreur: ${data.message}`, false);
                }
            } catch (err) {
                showResult('reg-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const res = await apiFetchWithFallback('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (res.ok) {
                    persistSession(email, data.token);
                    updateCurrentUserDisplay(email);
                    showResult('login-result', `‚úÖ Connect√© avec succ√®s! Token re√ßu.`);
                    await refreshAnomalyBadge();
                    
                    // Initialiser les fonctionnalit√©s avanc√©es
                    realtimeDashboard = new RealtimeDashboard(API_URL, token);
                    templateManager = new TemplateManager(API_URL, token);
                } else {
                    const message = (data?.message || '').toString().toLowerCase();
                    const canAutoCreate = message.includes('identifiants invalides');

                    if (canAutoCreate) {
                        const shouldCreate = confirm("Identifiants invalides. Voulez-vous cr√©er automatiquement un compte avec cet email puis vous connecter ?");
                        if (shouldCreate) {
                            const defaultName = email.split('@')[0] || 'Utilisateur';
                            const regRes = await apiFetchWithFallback('/api/auth/register', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ email, password, name: defaultName, role: 'AVOCAT', plan: 'CABINET' })
                            });

                            const regData = await readResponseDataSafe(regRes);

                            if (regRes.ok || regRes.status === 409) {
                                const retry = await apiFetchWithFallback('/api/auth/login', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ email, password })
                                });
                                const retryData = await readResponseDataSafe(retry);

                                if (retry.ok) {
                                    persistSession(email, retryData.token);
                                    updateCurrentUserDisplay(email);
                                    showResult('login-result', `‚úÖ Connect√© avec succ√®s!`);
                                    await refreshAnomalyBadge();
                                    return;
                                }

                                showResult('login-result', `‚ùå Compte trouv√©/cr√©√©, mais connexion impossible: ${retryData?.message || 'erreur'}`, false);
                                return;
                            }

                            showResult('login-result', `‚ùå Cr√©ation de compte impossible: ${regData?.message || 'erreur'}`, false);
                            return;
                        }
                    }

                    showResult('login-result', `‚ùå Erreur: ${data.message}`, false);
                }
            } catch (err) {
                showResult('login-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        async function refreshAnomalyBadge() {
            const el = document.getElementById('anomalyCountText');
            if (!el) return;
            if (!token) {
                el.textContent = '-';
                return;
            }

            try {
                const res = await apiFetchWithFallback('/api/alerts/center?limit=5', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    el.textContent = data?.summary?.totalOpenAnomalies ?? 0;
                } else {
                    el.textContent = '!';
                }
            } catch {
                el.textContent = '!';
            }
        }

        function openAnomalyCenter() {
            showTab('audit');
            loadAnomalyCenter();
        }

        async function loadAnomalyCenter() {
            if (!token) return showResult('anomaly-center-result', '‚ùå Connectez-vous d\'abord', false);

            try {
                const res = await apiFetchWithFallback('/api/alerts/center?limit=50', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (!res.ok) {
                    return showResult('anomaly-center-result', '‚ùå Erreur chargement centre anomalies', false);
                }

                const summary = data.summary || {};
                const flags = data.groupedFlags || [];
                const items = data.items || [];
                const logs = data.logs || [];

                let html = '<div class="result" style="border-left-color: orange; background: #fff3cd;">';
                html += `‚ö†Ô∏è <strong>Centre anomalies centralis√©</strong><br>`;
                html += `<span style="font-size:24px; font-weight:bold; color:#d97706;">${summary.totalOpenAnomalies || 0}</span> anomalies ouvertes<br>`;
                html += `<div style="margin-top:8px; display:flex; gap:20px; flex-wrap:wrap;">`;
                html += `<span>üìß Events: <strong>${summary.totalEventAnomalies || 0}</strong></span>`;
                html += `<span>üîî Notifications: <strong>${summary.totalNotificationAnomalies || 0}</strong></span>`;
                html += `<span>üìã Logs r√©cents: <strong>${summary.totalRecentLogs || 0}</strong></span>`;
                html += `</div>`;
                html += `<div style="margin-top:8px; font-size:13px;"><strong>D√©cision finale:</strong> Utilisateur (les actions propos√©es sont des aides).</div>`;
                html += '</div>';

                if (flags.length > 0) {
                    html += '<div class="result" style="margin-top:8px;">';
                    html += `<strong>üìà Top anomalies:</strong><br>`;
                    flags.forEach(f => {
                        html += `<span class="meta-chip" style="margin:4px;">${f.flag} <strong>(${f.count})</strong></span>`;
                        html += `<button class="btn" style="margin:4px; background:#c62828;" onclick="bulkDeleteByFlag('${f.flag}', ${f.count})">Suppression intelligente (${f.count})</button>`;
                    });
                    html += '</div>';
                }

                html += '<div class="event-list">';
                if (items.length === 0) {
                    html += '<div class="result success">‚úÖ Aucune anomalie √† traiter</div>';
                }
                items.forEach(i => {
                    const isEvent = i.kind === 'EVENT';
                    const isNotif = i.kind === 'NOTIFICATION';
                    html += `<div class="event-item ${isEvent ? 'case-item' : ''}" style="border-left-color:${isEvent ? 'orange' : '#667eea'}; ${isEvent ? 'cursor:pointer;' : ''}" ${isEvent ? `onclick="showEventDetail('${i.id}')"` : ''}>
                        <div class="date">${new Date(i.createdAt || i.occurredAt).toLocaleString('fr-FR')} - ${i.kind}</div>
                        <div><strong>${i.title || 'Anomalie'}</strong>${i.externalId ? ` (${i.externalId})` : ''}</div>
                        <div class="content">${(i.details || '').toString().substring(0, 240)}</div>`;

                    if (isEvent) {
                        html += `<button class="btn" style="margin-top:8px;" onclick="event.stopPropagation(); showEventDetail('${i.id}')">Voir tous les d√©tails</button>`;
                        html += `<button class="btn" style="margin-top:8px; background:#c62828;" onclick="event.stopPropagation(); deleteEventFromAlert('${i.id}')">Action directe: Supprimer l'√©v√©nement</button>`;
                    }

                    if (isNotif) {
                        html += `<button class="btn" style="margin-top:8px;" onclick="dismissNotificationFromCenter('${i.id}')">Ignorer (log)</button>`;
                        html += `<button class="btn" style="margin-top:8px; background:#2e7d32;" onclick="resolveNotificationFromCenter('${i.id}')">Cl√¥turer manuellement (log)</button>`;
                    }

                    html += '</div>';
                });
                html += '</div>';

                html += `<div class="result" style="margin-top:10px;">Point d'entr√©e logs: ${logs.length} log(s) disponible(s) dans l'audit.</div>`;

                document.getElementById('anomaly-center-result').innerHTML = html;
                await refreshAnomalyBadge();
            } catch (err) {
                showResult('anomaly-center-result', `‚ùå Erreur de connexion API: ${err.message}`, false);
            }
        }

        async function bulkDeleteByFlag(flag, suggestedCount) {
            if (!token) return;

            const toDelete = Number(suggestedCount || 0);
            const confirmed = confirm(`Supprimer en lot les √©v√©nements avec anomalie "${flag}" ?\nVolume estim√©: ${toDelete}.\nCette action est irr√©versible.`);
            if (!confirmed) return;

            try {
                const res = await fetch(`${API_URL}/api/events/bulk-delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ validationFlag: flag, maxToDelete: Math.max(toDelete, 1) })
                });

                const data = await readResponseDataSafe(res);
                if (res.ok) {
                    showResult('anomaly-center-result', `‚úÖ Suppression intelligente: ${data.deletedCount || 0} √©v√©nement(s) supprim√©(s) pour ${data.validationFlag || flag}`);
                    await loadAnomalyCenter();
                    await loadAlerts();
                    await refreshAnomalyBadge();
                } else {
                    showResult('anomaly-center-result', `‚ùå √âchec suppression intelligente: ${data?.message || 'erreur'}`, false);
                }
            } catch (err) {
                showResult('anomaly-center-result', `‚ùå Erreur suppression intelligente: ${err.message}`, false);
            }
        }

        async function dismissNotificationFromCenter(notificationId) {
            if (!token) return;
            try {
                const res = await fetch(`${API_URL}/api/notifications/${notificationId}/dismiss`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ reason: 'Trait√© depuis le centre anomalies' })
                });
                if (res.ok) {
                    showResult('anomaly-center-result', '‚úÖ Notification ignor√©e et logu√©e.');
                    await loadAnomalyCenter();
                    await loadAlerts();
                    await refreshAnomalyBadge();
                } else {
                    alert('Impossible d\'ignorer la notification');
                }
            } catch (err) {
                alert(`Erreur: ${err.message}`);
            }
        }

        async function resolveNotificationFromCenter(notificationId) {
            if (!token) return;
            const resolution = prompt('Action de cl√¥ture √† enregistrer:', 'Cl√¥ture manuelle valid√©e depuis le centre anomalies');
            if (!resolution) return;

            try {
                const res = await fetch(`${API_URL}/api/notifications/${notificationId}/resolve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ resolution, action: 'CENTRE_ANOMALIES' })
                });
                if (res.ok) {
                    showResult('anomaly-center-result', '‚úÖ Notification cl√¥tur√©e manuellement et logu√©e.');
                    await loadAnomalyCenter();
                    await loadAlerts();
                    await refreshAnomalyBadge();
                } else {
                    alert('Impossible de r√©soudre la notification');
                }
            } catch (err) {
                alert(`Erreur: ${err.message}`);
            }
        }

        async function checkDatabaseStats() {
            try {
                const res = await fetch(`${API_URL}/api/debug/stats`);
                const data = await res.json();
                if (res.ok) {
                    let html = `<div class="result success">üìä Base de donn√©es</div>`;
                    html += `<div class="result" style="margin-top:10px;">`;
                    html += `üë§ Utilisateurs: <strong>${data.users}</strong><br>`;
                    html += `üìÅ Dossiers: <strong>${data.cases}</strong><br>`;
                    html += `üìß √âv√©nements: <strong>${data.events}</strong><br>`;
                    html += `üì• Sources: <strong>${data.sources}</strong>`;
                    html += `</div>`;
                    if (data.recentCases && data.recentCases.length > 0) {
                        html += `<div class="event-list" style="margin-top:10px; max-height:400px;">`;
                        data.recentCases.forEach(c => {
                            html += `<div class="event-item case-item" onclick="showCaseDetails('${c.id}')" style="cursor:pointer;">`;
                            html += `<strong>${c.title}</strong>`;
                            html += `<div class="date">${new Date(c.createdAt).toLocaleString('fr-FR')}</div>`;
                            html += `</div>`;
                        });
                        html += `</div>`;
                    }
                    document.getElementById('scan-result').innerHTML = html;
                } else {
                    showResult('scan-result', `‚ùå Erreur`, false);
                }
            } catch (err) {
                showResult('scan-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        function escapeScanHtml(text) {
            const value = text == null ? '' : String(text);
            const div = document.createElement('div');
            div.textContent = value;
            return div.innerHTML;
        }

        function getSortedFilteredScanRows(rows) {
            const statusFilter = document.getElementById('scan-status-filter')?.value || 'all';
            const sortOrder = document.getElementById('scan-sort-order')?.value || 'dateDesc';

            let filtered = Array.isArray(rows) ? [...rows] : [];

            if (statusFilter !== 'all') {
                filtered = filtered.filter(r => (r?.status || '').toLowerCase() === statusFilter);
            }

            filtered.sort((a, b) => {
                const da = new Date(a?.occurredAt || 0).getTime();
                const db = new Date(b?.occurredAt || 0).getTime();

                if (sortOrder === 'dateAsc') return da - db;
                if (sortOrder === 'status') {
                    const sa = (a?.status || '').toLowerCase();
                    const sb = (b?.status || '').toLowerCase();
                    return sa.localeCompare(sb) || (db - da);
                }

                return db - da;
            });

            return filtered;
        }

        function refreshStructuredScanResultView() {
            if (!window.__lastStructuredScanData) return;
            const container = document.getElementById('scan-result');
            if (!container) return;
            container.innerHTML = renderStructuredScanResult(window.__lastStructuredScanData);
        }

        function renderStructuredScanResult(data) {
            const rows = Array.isArray(data?.linesPreview) ? data.linesPreview : [];
            const sortedRows = getSortedFilteredScanRows(rows);
            const statusFilter = document.getElementById('scan-status-filter')?.value || 'all';
            const sortOrder = document.getElementById('scan-sort-order')?.value || 'dateDesc';
            const cards = sortedRows.map((row, index) => {
                const status = row?.status || 'unknown';
                const date = row?.occurredAt ? new Date(row.occurredAt).toLocaleString('fr-FR') : '-';
                const from = escapeScanHtml(row?.from || '-');
                const to = escapeScanHtml(row?.to || '-');
                const subject = escapeScanHtml(row?.subject || '(sans sujet)');
                const bodyPreview = escapeScanHtml(row?.bodyPreview || '');
                const attachmentNames = Array.isArray(row?.attachmentNames) && row.attachmentNames.length > 0
                    ? row.attachmentNames.map(a => escapeScanHtml(a)).join(', ')
                    : 'Aucune';
                const encodedFrom = encodeURIComponent(row?.from || '');
                const encodedTo = encodeURIComponent(row?.to || '');
                const encodedSubject = encodeURIComponent(row?.subject || '');
                const encodedBody = encodeURIComponent(row?.bodyPreview || '');
                const encodedMessageId = encodeURIComponent(row?.messageId || '');

                return `
                    <div class="result" style="margin-top:10px; text-align:left;">
                        <strong>#${index + 1} ‚Ä¢ ${status.toUpperCase()}</strong><br>
                        <strong>Date:</strong> ${date}<br>
                        <strong>De:</strong> ${from}<br>
                        <strong>√Ä:</strong> ${to}<br>
                        <strong>Sujet:</strong> ${subject}<br>
                        <strong>Pi√®ces jointes:</strong> ${attachmentNames}<br>
                        <strong>Contenu:</strong><br>
                        <div style="white-space:pre-wrap; background:#fff; border:1px solid #ddd; padding:8px; border-radius:4px; margin-top:6px;">${bodyPreview || '(vide)'}</div>
                        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                            <button class="btn" style="padding:6px 10px; font-size:12px;" onclick="openReplyComposerFromScan('${encodedFrom}','${encodedTo}','${encodedSubject}','${encodedBody}','${encodedMessageId}')">R√©pondre √† cet email</button>
                        </div>
                    </div>
                `;
            }).join('');

            const summary = `
                <div class="result success" style="text-align:left;">
                    <strong>‚úÖ ${escapeScanHtml(data?.message || 'Scan termin√©')}</strong><br>
                    Total: <strong>${data?.totalEmails ?? 0}</strong> |
                    Ing√©r√©s: <strong>${data?.ingested ?? 0}</strong> |
                    Doublons: <strong>${data?.duplicates ?? 0}</strong><br>
                    Aper√ßu affich√©: <strong>${sortedRows.length}</strong>${data?.hasMorePreview ? ` / ${data?.totalEmails ?? 0} (augmentez la limite si besoin)` : ''}
                </div>
            `;

            const controls = `
                <div class="result" style="margin-top:10px; text-align:left;">
                    <strong>Organisation structur√©e</strong><br>
                    <label style="margin-right:10px;">Filtre statut:
                        <select id="scan-status-filter" onchange="refreshStructuredScanResultView()">
                            <option value="all" ${statusFilter === 'all' ? 'selected' : ''}>Tous</option>
                            <option value="ingested" ${statusFilter === 'ingested' ? 'selected' : ''}>Ing√©r√©s</option>
                            <option value="duplicate" ${statusFilter === 'duplicate' ? 'selected' : ''}>Doublons</option>
                        </select>
                    </label>
                    <label>Tri:
                        <select id="scan-sort-order" onchange="refreshStructuredScanResultView()">
                            <option value="dateDesc" ${sortOrder === 'dateDesc' ? 'selected' : ''}>Date (plus r√©cent)</option>
                            <option value="dateAsc" ${sortOrder === 'dateAsc' ? 'selected' : ''}>Date (plus ancien)</option>
                            <option value="status" ${sortOrder === 'status' ? 'selected' : ''}>Statut puis date</option>
                        </select>
                    </label>
                    <div style="margin-top:8px; color:#555;">Lignes affich√©es: <strong>${sortedRows.length}</strong></div>
                </div>
            `;

            return summary + controls + (cards || '<div class="result">Aucun email √† afficher dans cet aper√ßu.</div>');
        }

        function getCurrentUserEmail() {
            return (localStorage.getItem('memolibUserEmail') || '').trim().toLowerCase();
        }

        function chooseReplyRecipient(from, to) {
            const me = getCurrentUserEmail();
            const fromValue = (from || '').trim();
            const toValue = (to || '').trim();

            if (fromValue && fromValue.toLowerCase() !== me) return fromValue;
            if (toValue) return toValue.split(/[;,]/)[0].trim();
            return fromValue || toValue;
        }

        function closeScanReplyModal() {
            const modal = document.getElementById('scanReplyModal');
            if (modal) modal.remove();
        }

        function openReplyComposerFromScan(fromEnc, toEnc, subjectEnc, bodyEnc, messageIdEnc) {
            const from = decodeURIComponent(fromEnc || '');
            const to = decodeURIComponent(toEnc || '');
            const subject = decodeURIComponent(subjectEnc || '');
            const bodyPreview = decodeURIComponent(bodyEnc || '');
            const messageId = decodeURIComponent(messageIdEnc || '');
            const recipient = chooseReplyRecipient(from, to);

            const modalHtml = `
                <div class="modal" id="scanReplyModal" style="display:block;" onclick="if(event.target.id==='scanReplyModal') closeScanReplyModal()">
                    <div class="modal-content">
                        <span class="modal-close" onclick="closeScanReplyModal()">&times;</span>
                        <h2 style="color:#667eea; margin-bottom:12px;">R√©ponse √† envoyer</h2>
                        <div class="guide-box"><strong>Email source:</strong> ${escapeScanHtml(subject || '(sans sujet)')}<br><strong>De:</strong> ${escapeScanHtml(from || '-')} | <strong>√Ä:</strong> ${escapeScanHtml(to || '-')}<br><strong>R√©f√©rence:</strong> ${escapeScanHtml(messageId || '-')}</div>

                        <div class="input-group">
                            <label>Destinataire</label>
                            <input type="email" id="scan-reply-to" value="${escapeScanHtml(recipient)}" />
                        </div>
                        <div class="input-group">
                            <label>Sujet</label>
                            <input type="text" id="scan-reply-subject" value="${escapeScanHtml(subject ? `Re: ${subject}` : 'Re: Votre message')}" />
                        </div>
                        <div class="input-group">
                            <label>Message</label>
                            <textarea id="scan-reply-body" rows="10">Bonjour,\n\nMerci pour votre message.\n\nJe reviens vers vous rapidement avec la suite.\n\nCordialement,</textarea>
                        </div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <button class="btn" onclick="suggestScanReplyFromAi()">Proposer un brouillon</button>
                            <button class="btn" style="background:#1f8f3a;" onclick="sendScanReply()">Envoyer la r√©ponse</button>
                            <button class="btn" style="background:#888;" onclick="closeScanReplyModal()">Fermer</button>
                        </div>
                        <div id="scan-reply-status"></div>
                        <div class="result" style="margin-top:10px;"><strong>R√©sum√© du mail re√ßu:</strong><br>${escapeScanHtml(bodyPreview || '(aucun aper√ßu)')}</div>
                    </div>
                </div>
            `;

            const existing = document.getElementById('scanReplyModal');
            if (existing) existing.remove();
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        async function suggestScanReplyFromAi() {
            if (!token) return;

            const subject = document.getElementById('scan-reply-subject')?.value || '';
            const currentBody = document.getElementById('scan-reply-body')?.value || '';
            const status = document.getElementById('scan-reply-status');
            if (status) status.innerHTML = `<div class="result">‚è≥ G√©n√©ration du brouillon...</div>`;

            try {
                const res = await apiFetchWithFallback('/api/templates/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ clientContext: currentBody, subject, caseType: 'general' })
                });

                const data = await readResponseDataSafe(res);
                if (!res.ok) {
                    if (status) status.innerHTML = `<div class="result error">‚ùå Brouillon indisponible.</div>`;
                    return;
                }

                const generated = data?.generatedResponse || '';
                const bodyField = document.getElementById('scan-reply-body');
                if (bodyField && generated) {
                    bodyField.value = generated;
                }
                if (status) status.innerHTML = `<div class="result success">‚úÖ Brouillon propos√©. Vous pouvez modifier avant envoi.</div>`;
            } catch (err) {
                if (status) status.innerHTML = `<div class="result error">‚ùå Erreur brouillon: ${err.message}</div>`;
            }
        }

        async function sendScanReply() {
            if (!token) return;

            const to = document.getElementById('scan-reply-to')?.value?.trim() || '';
            const subject = document.getElementById('scan-reply-subject')?.value?.trim() || '';
            const body = document.getElementById('scan-reply-body')?.value?.trim() || '';
            const status = document.getElementById('scan-reply-status');

            if (!to || !subject || !body) {
                if (status) status.innerHTML = `<div class="result error">‚ùå Destinataire, sujet et message sont obligatoires.</div>`;
                return;
            }

            if (status) status.innerHTML = `<div class="result">‚è≥ Envoi en cours...</div>`;

            try {
                const res = await apiFetchWithFallback('/api/SecureEmail/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ to, subject, body })
                });

                const data = await readResponseDataSafe(res);
                if (!res.ok) {
                    const msg = data?.message || 'Envoi impossible';
                    if (status) status.innerHTML = `<div class="result error">‚ùå ${msg}</div>`;
                    return;
                }

                if (status) status.innerHTML = `<div class="result success">‚úÖ R√©ponse envoy√©e √† ${escapeScanHtml(to)}.</div>`;
            } catch (err) {
                if (status) status.innerHTML = `<div class="result error">‚ùå Erreur envoi: ${err.message}</div>`;
            }
        }

        function extractBodyFromRawPayload(rawPayload) {
            if (!rawPayload) return '';
            try {
                const parsed = JSON.parse(rawPayload);
                return (parsed.body || parsed.bodyText || parsed.bodyHtml || '').toString();
            } catch {
                return '';
            }
        }

        async function enrichScanRowsWithBodies(rows) {
            if (!Array.isArray(rows) || rows.length === 0) return rows;
            if (rows.some(r => r?.bodyPreview)) return rows;

            const res = await apiFetchWithFallback('/api/search/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ text: '' })
            });

            if (!res.ok) return rows;

            const events = await res.json();
            const map = new Map();
            (Array.isArray(events) ? events : []).forEach(ev => {
                if (ev?.externalId) {
                    map.set(ev.externalId, extractBodyFromRawPayload(ev.rawPayload));
                }
            });

            return rows.map(row => {
                if (row?.bodyPreview) return row;
                const fallbackBody = map.get(row?.messageId) || '';
                const bodyPreview = fallbackBody.length > 600 ? `${fallbackBody.slice(0, 600)}...` : fallbackBody;
                return { ...row, bodyPreview };
            });
        }

        async function manualEmailScan() {
            if (!token) return showResult('scan-result', '‚ùå Connectez-vous d\'abord', false);

            showResult('scan-result', '‚è≥ Scan en cours... Cela peut prendre quelques minutes.');

            try {
                const res = await apiFetchWithFallback('/api/email-scan/manual?previewLimit=500', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    data.linesPreview = await enrichScanRowsWithBodies(Array.isArray(data?.linesPreview) ? data.linesPreview : []);
                    window.__lastStructuredScanData = data;
                    document.getElementById('scan-result').innerHTML = renderStructuredScanResult(data);
                } else {
                    const raw = (data?.message || '').toString();
                    const text = raw.toLowerCase();
                    if (res.status === 401 || text.includes('invalid credentials') || text.includes('authentification') || text.includes('authentication')) {
                        let msg = `‚ùå Connexion √† la bo√Æte email impossible.<br>`;
                        msg += `V√©rifiez l'adresse email IMAP et le mot de passe d'application dans la configuration.<br>`;
                        msg += `Astuce Gmail: activez la validation en 2 √©tapes puis cr√©ez un mot de passe d'application.`;
                        return showResult('scan-result', msg, false);
                    }

                    let errorHtml = `‚ùå Erreur: ${data?.message || '√âchec du scan manuel.'}`;
                    if (data?.hint) {
                        errorHtml += `<br>üí° ${data.hint}`;
                    }
                    if (data?.details) {
                        errorHtml += `<br><small>D√©tail technique: ${data.details}</small>`;
                    }

                    showResult('scan-result', errorHtml, false);
                }
            } catch (err) {
                showResult('scan-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        async function ingestEmail() {
            if (!token) return showResult('ingest-result', '‚ùå Connectez-vous d\'abord', false);

            const from = document.getElementById('email-from').value;
            const subject = document.getElementById('email-subject').value;
            const body = document.getElementById('email-body').value;
            const externalId = document.getElementById('email-external').value || `EMAIL-${Date.now()}`;

            try {
                const res = await fetch(`${API_URL}/api/ingest/email`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ from, subject, body, externalId, occurredAt: new Date().toISOString() })
                });
                const data = await res.json();
                if (res.ok) {
                    const eventId = data.eventId || data.existingEventId || 'N/A';
                    
                    if (data.isDuplicate) {
                        let msg = `<div style="background: #fff3cd; border-left: 4px solid orange; padding: 15px; border-radius: 5px;">`;
                        msg += `‚ö†Ô∏è <strong>Doublon d√©tect√©</strong><br>`;
                        msg += `Event ID: ${eventId}<br>`;
                        msg += `Dossier: ${data.caseId || 'N/A'}<br>`;
                        msg += `Raison: ${data.duplicateReason}<br>`;
                        if (data.notificationCreated && data.notificationId) {
                            msg += `<br><button class="btn" onclick="acquitterDoublon('${data.notificationId}')">Acquitter ce doublon</button>`;
                        } else {
                            msg += `<br><em style="color: #666;">Notification non cr√©√©e</em>`;
                        }
                        msg += `</div>`;
                        document.getElementById('ingest-result').innerHTML = msg;
                    } else {
                        let msg = `‚úÖ Email ing√©r√©! Event ID: ${eventId}<br>Dossier: ${data.caseId || 'N/A'}${data.caseCreated ? ' (nouveau)' : ''}`;
                        if (data.requiresAttention) {
                            msg += `<br><span style="color: orange;">‚ö†Ô∏è Attention requise: ${data.validationFlags.join(', ')}</span>`;
                        }
                        showResult('ingest-result', msg);
                    }
                    
                    lastEventId = eventId !== 'N/A' ? eventId : null;
                    lastCaseId = data.caseId;
                } else {
                    showResult('ingest-result', `‚ùå Erreur: ${data.message}`, false);
                }
            } catch (err) {
                showResult('ingest-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        function renderSearchEventsList(events, titleLabel, options = {}) {
            const showIds = document.getElementById('search-show-ids')?.checked === true;
            const includeFullBody = options.includeFullBody === true;

            let html = `<div class="result success">‚úÖ ${events.length} email(s) ${titleLabel}</div>`;
            if (includeFullBody) {
                html += '<div class="guide-box"><strong>Affichage complet activ√©</strong>: chaque email ci-dessous contient tout le texte r√©cup√©r√© (pas seulement un extrait).</div>';
            }

            html += '<div class="event-list">';
            events.forEach((e, index) => {
                const payload = parseRawPayloadSafe(e.rawPayload);
                html += `<div class="event-item case-item" onclick="showEventDetail('${e.id}')">`;
                html += `<div class="date">#${index + 1} ‚Ä¢ ${new Date(e.occurredAt).toLocaleString('fr-FR')}</div>`;
                if (showIds) {
                    html += `<div class="search-ids">EventId: ${e.id}${e.externalId ? ` | ExternalId: ${e.externalId}` : ''}</div>`;
                }
                html += renderRichEmailBlock(payload, e.occurredAt, e.id, { includeFullBody });
                html += '</div>';
            });
            html += '</div>';
            document.getElementById('search-result').innerHTML = html;
        }

        async function searchEvents() {
            if (!token) return showResult('search-result', '‚ùå Connectez-vous d\'abord', false);

            const text = document.getElementById('search-text').value;
            const includeFullBody = document.getElementById('search-show-full-content')?.checked !== false;

            try {
                const res = await fetch(`${API_URL}/api/search/events`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ text, limit: 500 })
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    return showResult('search-result', `‚ùå Erreur ${res.status}: ${errorText}`, false);
                }

                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await res.text();
                    return showResult('search-result', `‚ùå R√©ponse invalide (non-JSON): ${text.substring(0, 200)}`, false);
                }

                const data = await res.json();
                if (!Array.isArray(data)) {
                    return showResult('search-result', '‚ùå Format de r√©ponse invalide', false);
                }

                renderSearchEventsList(data, 'trouv√©(s)', { includeFullBody });
            } catch (err) {
                showResult('search-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        async function loadAllReceivedEmails() {
            if (!token) return showResult('search-result', '‚ùå Connectez-vous d\'abord', false);

            const includeFullBody = document.getElementById('search-show-full-content')?.checked !== false;
            showResult('search-result', '‚è≥ Chargement de tous les emails re√ßus...');

            try {
                const res = await fetch(`${API_URL}/api/search/events`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ text: '', returnAll: true })
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    return showResult('search-result', `‚ùå Erreur ${res.status}: ${errorText}`, false);
                }

                const data = await res.json();
                if (!Array.isArray(data)) {
                    return showResult('search-result', '‚ùå Format de r√©ponse invalide', false);
                }

                renderSearchEventsList(data, 're√ßu(s) (chargement complet)', { includeFullBody });
            } catch (err) {
                showResult('search-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        function normalizeSearchText(value) {
            return (value || '').toString().trim().toLowerCase().replace(/\s+/g, ' ');
        }

        function toPercent(similarity) {
            const val = Number(similarity || 0);
            return `${(val * 100).toFixed(1)}%`;
        }

        function groupSimilarityResults(rows) {
            const groups = new Map();

            rows.forEach(row => {
                const content = (row.textForEmbedding || row.text || '').toString();
                const key = normalizeSearchText(content);

                if (!groups.has(key)) {
                    groups.set(key, {
                        content,
                        bestSimilarity: Number(row.similarity || 0),
                        ids: row.id ? [row.id] : [],
                        count: 1
                    });
                } else {
                    const g = groups.get(key);
                    g.count += 1;
                    if (Number(row.similarity || 0) > g.bestSimilarity) {
                        g.bestSimilarity = Number(row.similarity || 0);
                    }
                    if (row.id) g.ids.push(row.id);
                }
            });

            return Array.from(groups.values()).sort((a, b) => b.bestSimilarity - a.bestSimilarity);
        }

        function summarizeSemanticContent(content) {
            const lines = (content || '')
                .split(/\r?\n/)
                .map(x => x.trim())
                .filter(Boolean);

            return {
                from: lines[0] || 'N/A',
                subject: lines[1] || 'Sujet non disponible',
                excerpt: (lines[2] || lines[0] || '').substring(0, 180)
            };
        }

        function renderSimilarityResults(rows, modeLabel) {
            const shouldGroup = document.getElementById('search-group-duplicates')?.checked !== false;
            const showIds = document.getElementById('search-show-ids')?.checked !== false;

            if (!Array.isArray(rows)) {
                showResult('search-result', '‚ùå R√©ponse invalide', false);
                return;
            }

            if (!shouldGroup) {
                let html = `<div class="result success">‚úÖ ${rows.length} email(s) proche(s) trouv√©(s) (${modeLabel})</div>`;
                html += `<div class="guide-box">Lecture simple: chaque ligne = 1 email proche de votre recherche. Cliquez sur <strong>Ouvrir email</strong> pour voir le d√©tail complet.</div>`;
                html += '<div class="event-list">';
                rows.forEach(e => {
                    const s = summarizeSemanticContent(e.textForEmbedding || e.text || '');
                    html += `<div class="event-item">
                        <div class="date">Pertinence: ${toPercent(e.similarity)}</div>
                        <div><strong>Sujet:</strong> ${s.subject}</div>
                        <div><strong>De:</strong> ${s.from}</div>
                        <div class="content">${s.excerpt}${s.excerpt.length >= 180 ? '...' : ''}</div>
                        ${e.id ? `<button class="btn" style="padding:6px 10px; font-size:12px;" onclick="showEventDetail('${e.id}')">Ouvrir email</button>` : ''}
                    </div>`;
                });
                html += '</div>';
                document.getElementById('search-result').innerHTML = html;
                return;
            }

            const grouped = groupSimilarityResults(rows);
            const duplicateCount = rows.length - grouped.length;

            let html = `<div class="result success">‚úÖ ${rows.length} email(s) proche(s) (${modeLabel})`;
            html += `<span class="search-badge">${grouped.length} sujet(s) unique(s)</span>`;
            if (duplicateCount > 0) {
                html += `<span class="search-badge">${duplicateCount} email(s) similaires regroup√©(s)</span>`;
            }
            html += '</div>';
            html += `<div class="guide-box">Interpr√©tation: vous avez <strong>${grouped.length} sujet(s)</strong>. Chaque carte ci-dessous repr√©sente un sujet; le badge indique le nombre d'emails similaires.</div>`;
            html += '<div class="event-list">';

            grouped.forEach(g => {
                const s = summarizeSemanticContent(g.content || '');
                const firstId = (g.ids && g.ids.length > 0) ? g.ids[0] : null;
                html += `<div class="event-item">
                    <div class="date">Pertinence max: ${toPercent(g.bestSimilarity)} ${g.count > 1 ? `<span class="search-badge">${g.count} emails similaires</span>` : ''}</div>
                    <div><strong>Sujet:</strong> ${s.subject}</div>
                    <div><strong>De:</strong> ${s.from}</div>
                    <div class="content">${s.excerpt}${s.excerpt.length >= 180 ? '...' : ''}</div>
                    ${firstId ? `<button class="btn" style="padding:6px 10px; font-size:12px;" onclick="showEventDetail('${firstId}')">Ouvrir un email de ce sujet</button>` : ''}`;
                if (showIds && g.ids.length > 0) {
                    html += `<div class="search-ids">IDs techniques: ${g.ids.join(', ')}</div>`;
                }
                html += `</div>`;
            });

            html += '</div>';
            document.getElementById('search-result').innerHTML = html;
        }

        async function semanticSearch() {
            if (!token) return showResult('search-result', '‚ùå Connectez-vous d\'abord', false);

            const query = document.getElementById('search-text').value;

            try {
                const res = await fetch(`${API_URL}/api/semantic/search`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ query })
                });
                const data = await res.json();
                if (res.ok) {
                    renderSimilarityResults(data, 'recherche IA');
                } else {
                    showResult('search-result', `‚ùå Erreur: ${data.message}`, false);
                }
            } catch (err) {
                showResult('search-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        async function generateEmbeddings() {
            if (!token) return showResult('search-result', '‚ùå Connectez-vous d\'abord', false);

            try {
                const res = await fetch(`${API_URL}/api/embeddings/generate-all`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    showResult('search-result', `‚úÖ Embeddings g√©n√©r√©s: ${data.generatedCount} / ${data.totalEvents}`);
                } else {
                    showResult('search-result', `‚ùå Erreur`, false);
                }
            } catch (err) {
                showResult('search-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        async function embeddingSearch() {
            if (!token) return showResult('search-result', '‚ùå Connectez-vous d\'abord', false);

            const query = document.getElementById('search-text').value;

            try {
                const res = await fetch(`${API_URL}/api/embeddings/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ query, limit: 10 })
                });
                const data = await res.json();
                if (res.ok) {
                    renderSimilarityResults(data, 'embeddings');
                } else {
                    showResult('search-result', `‚ùå Erreur`, false);
                }
            } catch (err) {
                showResult('search-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        async function createClient() {
            if (!token) return showResult('client-result', '‚ùå Connectez-vous d\'abord', false);

            const name = document.getElementById('client-name').value;
            const email = document.getElementById('client-email').value;
            const phoneNumber = document.getElementById('client-phone').value || null;
            const address = document.getElementById('client-address').value || null;

            try {
                const res = await fetch(`${API_URL}/api/client`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name, email, phoneNumber, address })
                });
                const data = await res.json();
                if (res.ok) {
                    showResult('client-result', `‚úÖ Client cr√©√©: ${data.name} (${data.id})`);
                } else if (res.status === 409) {
                    showResult('client-result', `‚ùå Client d√©j√† existant avec cet email: ${email}<br>ID existant: ${data.existingClientId || 'N/A'}`, false);
                } else {
                    showResult('client-result', `‚ùå Erreur ${res.status}: ${data.message || data.title || 'Impossible de cr√©er le client'}`, false);
                }
            } catch (err) {
                showResult('client-result', `‚ùå Erreur r√©seau: ${err.message}`, false);
            }
        }

        async function listClients() {
            if (!token) return showResult('client-result', '‚ùå Connectez-vous d\'abord', false);

            try {
                const res = await fetch(`${API_URL}/api/client`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    let html = `<div class="result success">‚úÖ ${data.length} client(s)</div>`;
                    html += '<div class="event-list">';
                    data.forEach(c => {
                        html += `<div class="event-item" style="cursor:pointer;" onclick="openClientDetail('${c.id}')">
                            <strong>${c.name}</strong>
                            <div class="date">${c.email}</div>
                            <div class="content">${c.phoneNumber || ''} ${c.address || ''}</div>
                            <div class="date" style="margin-top:4px; color:#667eea;">Cliquer pour modifier / appliquer des r√®gles / voir d√©tail</div>
                        </div>`;
                    });
                    html += '</div>';
                    document.getElementById('client-result').innerHTML = html;
                } else {
                    showResult('client-result', `‚ùå Erreur ${res.status}: ${data.message || 'Impossible de charger les clients'}`, false);
                }
            } catch (err) {
                showResult('client-result', `‚ùå Erreur r√©seau: ${err.message}`, false);
            }
        }

        async function openClientDetail(clientId) {
            if (!token) return showResult('client-result', '‚ùå Connectez-vous d\'abord', false);

            try {
                const res = await fetch(`${API_URL}/api/client/${clientId}/detail`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (!res.ok) {
                    return showResult('client-result', '‚ùå D√©tail client introuvable', false);
                }

                const client = data.client || {};
                const summary = data.summary || {};
                const relatedCases = data.relatedCases || [];
                const recentEvents = data.recentEvents || [];

                selectedClientId = client.id;
                selectedClientRaw = data;

                document.getElementById('detail-client-id').value = client.id || '';
                document.getElementById('detail-client-name').value = client.name || '';
                document.getElementById('detail-client-email').value = client.email || '';
                document.getElementById('detail-client-phone').value = client.phoneNumber || '';
                document.getElementById('detail-client-address').value = client.address || '';

                const empty = document.getElementById('client-detail-empty');
                const panel = document.getElementById('client-detail-panel');
                if (empty) empty.style.display = 'none';
                if (panel) panel.style.display = 'block';

                const summaryHtml = `<div class="result" style="margin-top:12px;">
                    <strong>Vue synth√®se</strong><br>
                    Dossiers li√©s: ${summary.relatedCasesCount || 0} | 
                    √âv√©nements r√©cents: ${summary.recentEventsCount || 0} | 
                    Anomalies ouvertes: ${summary.openAnomaliesCount || 0} | 
                    Annexes: ${summary.totalAnnexesCount || 0}<br>
                    Dernier contact: ${summary.lastContactAt ? new Date(summary.lastContactAt).toLocaleString('fr-FR') : 'N/A'}
                </div>`;
                document.getElementById('client-detail-summary').innerHTML = summaryHtml;

                let casesHtml = `<div class="result" style="margin-top:10px;"><strong>Dossiers li√©s (${relatedCases.length})</strong></div>`;
                casesHtml += '<div class="event-list">';
                relatedCases.forEach(c => {
                    casesHtml += `<div class="event-item case-item" onclick="showCaseDetails('${c.id}')">
                        <strong>${c.title}</strong>
                        <div class="date">Cr√©√© le ${new Date(c.createdAt).toLocaleString('fr-FR')}</div>
                    </div>`;
                });
                casesHtml += '</div>';
                document.getElementById('client-detail-cases').innerHTML = casesHtml;

                let eventsHtml = `<div class="result" style="margin-top:10px;"><strong>√âv√©nements r√©cents (${recentEvents.length})</strong></div>`;
                eventsHtml += '<div class="event-list">';
                recentEvents.forEach(e => {
                    const payload = parseRawPayloadSafe(e.rawPayload);
                    eventsHtml += `<div class="event-item">`;
                    eventsHtml += renderRichEmailBlock(payload, e.occurredAt, e.id);
                    if (e.requiresAttention) {
                        eventsHtml += `<div style="color:orange; margin-top:6px;">‚ö†Ô∏è ${e.validationFlags || 'Anomalie d√©tect√©e'}</div>`;
                    }
                    eventsHtml += `</div>`;
                });
                eventsHtml += '</div>';
                document.getElementById('client-detail-events').innerHTML = eventsHtml;

                showTab('client-detail');
                showResult('client-detail-result', `‚úÖ D√©tail charg√© pour ${client.name || 'client'}`);
            } catch (err) {
                showResult('client-result', `‚ùå Erreur d√©tail client: ${err.message}`, false);
            }
        }

        function applyClientRule(ruleName) {
            if (!selectedClientId) {
                showResult('client-detail-result', '‚ùå S√©lectionnez d\'abord un client dans la liste', false);
                return;
            }

            const nameEl = document.getElementById('detail-client-name');
            const emailEl = document.getElementById('detail-client-email');
            const phoneEl = document.getElementById('detail-client-phone');
            const addressEl = document.getElementById('detail-client-address');

            if (ruleName === 'normalize') {
                nameEl.value = (nameEl.value || '').trim().replace(/\s+/g, ' ');
                emailEl.value = (emailEl.value || '').trim().toLowerCase();
                phoneEl.value = (phoneEl.value || '').replace(/\s+/g, ' ').trim();
                addressEl.value = (addressEl.value || '').trim().replace(/\s+/g, ' ');
                showResult('client-detail-result', '‚úÖ R√®gle appliqu√©e: normalisation des donn√©es');
                return;
            }

            if (ruleName === 'vip') {
                const currentName = (nameEl.value || '').trim();
                if (!currentName.toUpperCase().startsWith('[VIP]')) {
                    nameEl.value = `[VIP] ${currentName}`.trim();
                }
                showResult('client-detail-result', '‚úÖ R√®gle appliqu√©e: marquage VIP');
            }
        }

        async function saveClientDetail() {
            if (!token) return showResult('client-detail-result', '‚ùå Connectez-vous d\'abord', false);
            if (!selectedClientId) return showResult('client-detail-result', '‚ùå Aucun client s√©lectionn√©', false);

            const payload = {
                name: document.getElementById('detail-client-name').value,
                email: document.getElementById('detail-client-email').value,
                phoneNumber: document.getElementById('detail-client-phone').value,
                address: document.getElementById('detail-client-address').value
            };

            try {
                const res = await fetch(`${API_URL}/api/client/${selectedClientId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (!res.ok) {
                    return showResult('client-detail-result', `‚ùå √âchec enregistrement: ${data.message || 'erreur'}`, false);
                }

                selectedClientRaw = data;
                showResult('client-detail-result', `‚úÖ Client mis √† jour: ${data.name}`);
                await listClients();
            } catch (err) {
                showResult('client-detail-result', `‚ùå Erreur enregistrement: ${err.message}`, false);
            }
        }

        function showClientDetailRaw() {
            if (!selectedClientRaw) {
                showResult('client-detail-result', '‚ùå Aucun d√©tail charg√©', false);
                return;
            }

            const pretty = `<pre>${JSON.stringify(selectedClientRaw, null, 2)}</pre>`;
            document.getElementById('client-detail-result').innerHTML = `<div class="result">${pretty}</div>`;
        }

        async function generateDiversifiedClientBase() {
            if (!token) return showResult('client-result', '‚ùå Connectez-vous d\'abord', false);

            const clientRef = DEFAULT_DEMO.clientRef;
            const clientEmail = document.getElementById('client-email').value || DEFAULT_DEMO.clientEmail;
            const clientName = document.getElementById('client-name').value || DEFAULT_DEMO.clientName;
            const phoneNumber = document.getElementById('client-phone').value || DEFAULT_DEMO.clientPhone;
            const address = document.getElementById('client-address').value || DEFAULT_DEMO.clientAddress;

            showResult('client-result', '‚è≥ G√©n√©ration en cours...');

            try {
                let clientId = null;

                const listRes = await fetch(`${API_URL}/api/client`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (listRes.ok) {
                    const clients = await listRes.json();
                    const existing = (clients || []).find(c =>
                        (c.email || '').toLowerCase() === clientEmail.toLowerCase());
                    if (existing) clientId = existing.id;
                }

                if (!clientId) {
                    const createRes = await fetch(`${API_URL}/api/client`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ name: clientName, email: clientEmail, phoneNumber, address })
                    });

                    if (createRes.ok) {
                        const created = await createRes.json();
                        clientId = created.id;
                    }
                }

                const topics = [
                    {
                        suffix: 'FAMILLE-001',
                        subject: 'Droit de la famille - Garde altern√©e',
                        body: 'Conflit sur la garde altern√©e et calendrier scolaire.',
                        annexes: 'annexe_jugement_2019.pdf; annexe_planning_garde.xlsx'
                    },
                    {
                        suffix: 'TRAVAIL-001',
                        subject: 'Droit du travail - Licenciement contest√©',
                        body: 'Contestation du motif √©conomique et calcul des indemnit√©s.',
                        annexes: 'annexe_contrat_travail.pdf; annexe_bulletins_salaire.zip'
                    },
                    {
                        suffix: 'IMMOBILIER-001',
                        subject: 'Litige immobilier - Malfa√ßons',
                        body: 'R√©ception de travaux avec r√©serves et expertise contradictoire.',
                        annexes: 'annexe_photos_chantier.zip; annexe_rapport_expert.pdf'
                    },
                    {
                        suffix: 'PENAL-001',
                        subject: 'P√©nal - Convocation audition libre',
                        body: 'Pr√©paration de la strat√©gie de d√©fense avant audition.',
                        annexes: 'annexe_convocation.pdf; annexe_pieces_procedure.pdf'
                    }
                ];

                let stored = 0;
                let duplicates = 0;
                const details = [];

                for (const topic of topics) {
                    const externalId = `${clientRef}-${topic.suffix}`;
                    const emailPayload = {
                        from: clientEmail,
                        subject: topic.subject,
                        body: `${topic.body}\n\nClientId: ${clientRef}\nClientDbId: ${clientId || 'N/A'}\nAnnexes: ${topic.annexes}`,
                        externalId,
                        occurredAt: new Date().toISOString()
                    };

                    const ingestRes = await fetch(`${API_URL}/api/ingest/email`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(emailPayload)
                    });

                    const ingestData = await ingestRes.json();
                    if (ingestRes.ok && ingestData.isDuplicate !== true) {
                        stored += 1;
                    } else if (ingestRes.ok && ingestData.isDuplicate === true) {
                        duplicates += 1;
                    }

                    details.push(`${externalId}: ${ingestData.isDuplicate ? 'doublon' : 'ing√©r√©'}`);
                }

                document.getElementById('search-text').value = clientRef;
                showResult(
                    'client-result',
                    `‚úÖ Base diversifi√©e pr√™te pour ${clientName} (${clientRef})<br>` +
                    `ClientDbId: ${clientId || 'N/A'}<br>` +
                    `Sujets cr√©√©s: ${stored} | Doublons: ${duplicates}<br>` +
                    `D√©tail: ${details.join(' | ')}`
                );
            } catch (err) {
                showResult('client-result', `‚ùå Erreur g√©n√©ration base: ${err.message}`, false);
            }
        }

        async function generateTwentyClientsBase() {
            if (!token) return showResult('client-result', '‚ùå Connectez-vous d\'abord', false);

            showResult('client-result', '‚è≥ G√©n√©ration de 20 clients et sujets en cours...');

            try {
                const firstNames = ['Marie', 'Jean', 'Sofia', 'Lucas', 'Nora', 'Karim', 'Emma', 'Hugo', 'Lina', 'Paul'];
                const lastNames = ['Martin', 'Bernard', 'Petit', 'Moreau', 'Roux', 'Faure', 'Garcia', 'Andre', 'Mercier', 'Dupuis'];

                const topics = [
                    {
                        suffix: 'FAMILLE',
                        subject: 'Droit de la famille - Pension',
                        body: 'Demande de r√©vision de pension alimentaire.',
                        annexes: 'annexe_jugement.pdf; annexe_revenus_2025.xlsx'
                    },
                    {
                        suffix: 'TRAVAIL',
                        subject: 'Droit du travail - Rupture contrat',
                        body: 'Analyse d\'une rupture conventionnelle contest√©e.',
                        annexes: 'annexe_contrat.pdf; annexe_avenant.pdf'
                    },
                    {
                        suffix: 'IMMOBILIER',
                        subject: 'Immobilier - Vice cach√©',
                        body: 'Constat de vice cach√© apr√®s acquisition d\'un bien.',
                        annexes: 'annexe_acte_vente.pdf; annexe_expertise.pdf'
                    },
                    {
                        suffix: 'PENAL',
                        subject: 'P√©nal - Assistance audition',
                        body: 'Pr√©paration d\'assistance pour audition libre.',
                        annexes: 'annexe_convocation.pdf; annexe_pieces_defense.zip'
                    }
                ];

                const listRes = await apiFetchWithFallback('/api/client', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const existingClients = listRes.ok ? await listRes.json() : [];
                const existingByEmail = new Map((existingClients || []).map(c => [(c.email || '').toLowerCase(), c]));

                const batchRef = Date.now();
                let createdClients = 0;
                let reusedClients = 0;
                let storedEvents = 0;
                let duplicateEvents = 0;

                for (let i = 1; i <= 20; i++) {
                    const first = firstNames[(i - 1) % firstNames.length];
                    const last = lastNames[(i - 1) % lastNames.length];
                    const clientRef = `CLI-${String(i).padStart(3, '0')}`;
                    const email = `client.${String(i).padStart(3, '0')}@memolib.local`;
                    const name = `${first} ${last}`;
                    const phoneNumber = `+33 6 ${String(10 + i).padStart(2, '0')} ${String(20 + i).padStart(2, '0')} ${String(30 + i).padStart(2, '0')} ${String(40 + i).padStart(2, '0')}`;
                    const address = `${i} rue Demo, Paris`;

                    let client = existingByEmail.get(email.toLowerCase());
                    if (!client) {
                        const createRes = await apiFetchWithFallback('/api/client', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ name, email, phoneNumber, address })
                        });

                        if (createRes.ok) {
                            client = await createRes.json();
                            existingByEmail.set(email.toLowerCase(), client);
                            createdClients += 1;
                        }
                    } else {
                        reusedClients += 1;
                    }

                    for (const topic of topics) {
                        const externalId = `${clientRef}-${topic.suffix}-${batchRef}`;
                        const payload = {
                            from: email,
                            subject: topic.subject,
                            body: `${topic.body}\n\nClientId: ${clientRef}\nClientDbId: ${client?.id || 'N/A'}\nAnnexes: ${topic.annexes}`,
                            externalId,
                            occurredAt: new Date().toISOString()
                        };

                        const ingestRes = await apiFetchWithFallback('/api/ingest/email', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(payload)
                        });

                        const ingestData = await ingestRes.json();
                        if (ingestRes.ok && ingestData.isDuplicate !== true) storedEvents += 1;
                        if (ingestRes.ok && ingestData.isDuplicate === true) duplicateEvents += 1;
                    }
                }

                document.getElementById('search-text').value = 'CLI-';
                showResult(
                    'client-result',
                    `‚úÖ Base 20 clients pr√™te<br>` +
                    `Clients cr√©√©s: ${createdClients} | R√©utilis√©s: ${reusedClients}<br>` +
                    `Sujets ing√©r√©s: ${storedEvents} | Doublons: ${duplicateEvents}<br>` +
                    `Conseil: recherche "CLI-" dans Recherche intelligente.`
                );
            } catch (err) {
                showResult('client-result', `‚ùå Erreur g√©n√©ration 20 clients: ${err.message}. V√©rifiez que l'API tourne (${API_URL}/health).`, false);
            }
        }

        async function initDemoData() {
            if (!token) {
                alert('Veuillez vous connecter d\'abord');
                return;
            }

            if (!confirm('Cr√©er une base de d√©monstration avec 5 clients et leurs dossiers ?')) {
                return;
            }

            try {
                const clients = [
                    { name: 'Sophie Martin', email: 'sophie.martin@example.com', phone: '+33 6 12 34 56 78', address: '12 rue de la Paix, Paris' },
                    { name: 'Pierre Dubois', email: 'pierre.dubois@example.com', phone: '+33 6 23 45 67 89', address: '45 avenue Victor Hugo, Lyon' },
                    { name: 'Marie Lefebvre', email: 'marie.lefebvre@example.com', phone: '+33 6 34 56 78 90', address: '8 boulevard Haussmann, Marseille' },
                    { name: 'Jean Moreau', email: 'jean.moreau@example.com', phone: '+33 6 45 67 89 01', address: '23 rue Nationale, Lille' },
                    { name: 'Claire Bernard', email: 'claire.bernard@example.com', phone: '+33 6 56 78 90 12', address: '67 cours Lafayette, Toulouse' }
                ];

                const topics = [
                    { subject: 'Droit de la famille - Divorce', body: 'Demande de conseil pour proc√©dure de divorce √† l\'amiable.' },
                    { subject: 'Droit du travail - Licenciement', body: 'Contestation d\'un licenciement √©conomique.' },
                    { subject: 'Immobilier - Litige', body: 'Conflit avec le propri√©taire concernant les charges.' }
                ];

                let created = 0;
                for (const client of clients) {
                    const createRes = await fetch(`${API_URL}/api/client`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            name: client.name,
                            email: client.email,
                            phoneNumber: client.phone,
                            address: client.address
                        })
                    });

                    if (createRes.ok || createRes.status === 409) {
                        for (const topic of topics) {
                            await fetch(`${API_URL}/api/ingest/email`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    from: client.email,
                                    subject: topic.subject,
                                    body: topic.body,
                                    externalId: `${client.email}-${topic.subject}-${Date.now()}`,
                                    occurredAt: new Date().toISOString()
                                })
                            });
                        }
                        created++;
                    }
                }

                alert(`‚úÖ Base d√©mo cr√©√©e: ${created} clients avec leurs dossiers`);
                showTab('client');
                await listClients();
            } catch (err) {
                alert(`‚ùå Erreur: ${err.message}`);
            }
        }

        async function loadSmartOverview() {
            if (!token) return showResult('smart-overview-result', '‚ùå Connectez-vous d\'abord', false);

            showResult('smart-overview-result', '‚è≥ Chargement de toutes les donn√©es...');

            try {
                const res = await fetch(`${API_URL}/api/dashboard/overview`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (!res.ok) {
                    return showResult('smart-overview-result', `‚ùå Erreur: ${data.message}`, false);
                }

                let html = '<div class="stats">';
                html += `<div class="stat-box"><div class="number">${data.stats.totalCases}</div><div class="label">Dossiers</div></div>`;
                html += `<div class="stat-box"><div class="number">${data.stats.totalClients}</div><div class="label">Clients</div></div>`;
                html += `<div class="stat-box"><div class="number">${data.stats.totalEvents}</div><div class="label">Emails</div></div>`;
                html += `<div class="stat-box" style="background:#ff9800;"><div class="number">${data.stats.eventsWithAnomalies}</div><div class="label">Anomalies</div></div>`;
                html += '</div>';

                html += `<div class="result" style="margin-top:15px;"><strong>üìÅ Dossiers avec exp√©diteurs (${data.cases.length})</strong></div>`;
                html += '<div class="event-list" style="max-height:300px;">';
                data.cases.forEach(c => {
                    html += `<div class="event-item case-item" onclick="showCaseDetails('${c.id}')">`;
                    html += `<strong>${c.title}</strong>`;
                    html += `<div class="date">üìß De: ${c.from} | üïí ${c.occurredAt ? new Date(c.occurredAt).toLocaleString('fr-FR') : 'N/A'}</div>`;
                    html += `<div class="date">Client: ${c.clientId || 'non renseign√©'} | ${c.eventCount} email(s) | Cr√©√©: ${new Date(c.createdAt).toLocaleString('fr-FR')}</div>`;
                    html += '</div>';
                });
                html += '</div>';

                html += `<div class="result" style="margin-top:15px;"><strong>üë• Clients avec coordonn√©es (${data.clients.length})</strong></div>`;
                html += '<div class="event-list" style="max-height:300px;">';
                data.clients.forEach(cl => {
                    html += `<div class="event-item" onclick="openClientDetail('${cl.id}')" style="cursor:pointer;">`;
                    html += `<strong>${cl.name}</strong>`;
                    html += `<div class="date">üìß ${cl.email} | üìû ${cl.phoneNumber || 'N/A'}</div>`;
                    html += `<div class="content">üè† ${cl.address || 'Adresse non renseign√©e'}</div>`;
                    html += `<div class="date">${cl.casesCount} dossier(s) | Cr√©√©: ${new Date(cl.createdAt).toLocaleString('fr-FR')}</div>`;
                    html += '</div>';
                });
                html += '</div>';

                html += `<div class="result" style="margin-top:15px;"><strong>üì® Emails r√©cents (${data.recentEvents.length})</strong></div>`;
                html += '<div class="event-list" style="max-height:300px;">';
                data.recentEvents.forEach(e => {
                    html += `<div class="event-item" onclick="showEventDetail('${e.id}')" style="cursor:pointer;">`;
                    html += `<strong>${e.subject}</strong>`;
                    html += `<div class="date">üìß De: ${e.from} | üïí ${new Date(e.occurredAt).toLocaleString('fr-FR')}</div>`;
                    if (e.requiresAttention) {
                        html += `<div style="color:orange; margin-top:4px;">‚ö†Ô∏è ${e.validationFlags || 'Anomalie'}</div>`;
                    }
                    html += '</div>';
                });
                html += '</div>';

                document.getElementById('smart-overview-result').innerHTML = html;
            } catch (err) {
                showResult('smart-overview-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        async function listCases() {
            if (!token) return showResult('cases-result', '‚ùå Connectez-vous d\'abord', false);
            setLoadingState('cases-result', '‚è≥ Chargement des dossiers...');

            try {
                const [casesRes, anomaliesRes] = await Promise.all([
                    apiFetchWithFallback('/api/cases', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    apiFetchWithFallback('/api/alerts/center?limit=5', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                const data = await readResponseDataSafe(casesRes);
                const anomaliesData = anomaliesRes.ok ? await readResponseDataSafe(anomaliesRes) : null;
                const openAnomalies = anomaliesData?.summary?.totalOpenAnomalies ?? 'N/A';

                if (casesRes.ok) {
                    const shouldGroup = document.getElementById('cases-group-by-subject')?.checked !== false;
                    const distinctClientIds = new Set((data || []).map(c => c.clientId).filter(Boolean));
                    const clientsCount = distinctClientIds.size;
                    const totalCases = (data || []).length;

                    if (!shouldGroup) {
                        const sortedCases = (data || []).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        let html = `<div class="result success">‚úÖ ${sortedCases.length} dossier(s)</div>`;
                        html += `<div class="guide-box"><strong>Lecture simple:</strong> vous avez <strong>${totalCases}</strong> dossier(s) actif(s), r√©parti(s) sur <strong>${clientsCount}</strong> client(s). Anomalies ouvertes: <strong>${openAnomalies}</strong>.</div>`;
                        html += '<div class="event-list">';
                        sortedCases.forEach(c => {
                            html += `<div class="event-item case-item" onclick="showCaseDetails('${c.id}')">
                                <strong>${c.title || 'Sans titre'}</strong>
                                <div class="date">Client: ${c.clientId || 'non renseign√©'}</div>
                                <div class="date">Cr√©√© le ${new Date(c.createdAt).toLocaleString('fr-FR')}</div>
                            </div>`;
                        });
                        html += '</div>';
                        document.getElementById('cases-result').innerHTML = html;
                        return;
                    }

                    const groups = new Map();
                    (data || []).forEach(c => {
                        const title = (c.title || 'Sans titre').trim();
                        const clientKey = c.clientId || 'SANS_CLIENT';
                        const key = `${title.toLowerCase()}|${clientKey}`;
                        if (!groups.has(key)) {
                            groups.set(key, {
                                title,
                                clientId: c.clientId || null,
                                latestId: c.id,
                                latestCreatedAt: c.createdAt,
                                count: 1
                            });
                        } else {
                            const g = groups.get(key);
                            g.count += 1;
                            if (new Date(c.createdAt) > new Date(g.latestCreatedAt)) {
                                g.latestCreatedAt = c.createdAt;
                                g.latestId = c.id;
                            }
                        }
                    });

                    const groupedCases = Array.from(groups.values())
                        .sort((a, b) => new Date(b.latestCreatedAt) - new Date(a.latestCreatedAt));

                    let html = `<div class="result success">‚úÖ ${data.length} dossier(s) | ${groupedCases.length} groupe(s) client+sujet</div>`;
                    html += `<div class="guide-box"><strong>Lecture simple:</strong> <strong>${totalCases}</strong> dossier(s), <strong>${clientsCount}</strong> client(s), <strong>${groupedCases.length}</strong> groupe(s) utiles √† traiter. Anomalies ouvertes: <strong>${openAnomalies}</strong>.</div>`;
                    html += `<div class="guide-box">Affichage regroup√© par <strong>client + sujet</strong> pour √©viter de m√©langer des clients diff√©rents ayant le m√™me sujet. D√©cochez "Regrouper par sujet" pour voir tous les dossiers individuellement.</div>`;
                    html += '<div class="event-list">';
                    groupedCases.forEach(c => {
                        html += `<div class="event-item case-item" onclick="showCaseDetails('${c.latestId}')">
                            <strong>${c.title}</strong> ${c.count > 1 ? `<span class="search-badge">${c.count} dossiers</span>` : ''}
                            <div class="date">Client: ${c.clientId || 'non renseign√©'}</div>
                            <div class="date">Dernier dossier cr√©√© le ${new Date(c.latestCreatedAt).toLocaleString('fr-FR')}</div>
                        </div>`;
                    });
                    html += '</div>';
                    document.getElementById('cases-result').innerHTML = html;
                } else {
                    showResult('cases-result', `‚ùå Erreur`, false);
                }
            } catch (err) {
                showResult('cases-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        async function mergeLegacyCases() {
            if (!token) return showResult('cases-result', '‚ùå Connectez-vous d\'abord', false);

            const confirmed = confirm('Fusionner les anciens dossiers en doublon (client + sujet) ? Cette action consolide les timelines et supprime les doublons.');
            if (!confirmed) return;

            try {
                const res = await apiFetchWithFallback('/api/cases/merge-duplicates', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await readResponseDataSafe(res);

                if (!res.ok) {
                    return showResult('cases-result', `‚ùå Fusion impossible: ${data?.message || 'erreur'}`, false);
                }

                showResult('cases-result',
                    `‚úÖ ${data.message || 'Fusion termin√©e'}<br>` +
                    `Groupes fusionn√©s: ${data.mergedGroups || 0} | ` +
                    `Dossiers supprim√©s: ${data.removedCases || 0} | ` +
                    `√âv√©nements consolid√©s: ${data.movedEvents || 0}`
                );

                await listCases();
            } catch (err) {
                showResult('cases-result', `‚ùå Erreur fusion: ${err.message}`, false);
            }
        }

        async function showCaseDetails(caseId) {
            if (!token) return;

            try {
                const [caseRes, timelineRes] = await Promise.all([
                    fetch(`${API_URL}/api/cases/${caseId}`, { headers: { 'Authorization': `Bearer ${token}` }}),
                    fetch(`${API_URL}/api/cases/${caseId}/timeline`, { headers: { 'Authorization': `Bearer ${token}` }})
                ]);

                const caseData = await readResponseDataSafe(caseRes);
                const timeline = await readResponseDataSafe(timelineRes);

                if (!caseRes.ok || !caseData) {
                    alert('Impossible de charger le dossier');
                    return;
                }

                const title = caseData.title || caseData.Title || 'Dossier';
                const id = caseData.id || caseData.Id || caseId;
                const createdAt = caseData.createdAt || caseData.CreatedAt || new Date().toISOString();
                const updatedAt = caseData.updatedAt || caseData.UpdatedAt || createdAt;
                const clientId = caseData.clientId || caseData.ClientId || null;

                let html = `<div class="modal" id="caseModal" onclick="if(event.target.id==='caseModal')closeModal()">
                    <div class="modal-content">
                        <span class="modal-close" onclick="closeModal()">&times;</span>
                        <h2 style="color: #667eea; margin-bottom: 20px;">${title}</h2>
                        <div class="guide-box"><strong>Exploitation maximale</strong> : rep√©rez le <strong>ClientId</strong>, cliquez <strong>Rechercher ce client</strong>, puis utilisez <strong>Recherche embeddings/IA</strong> pour regrouper et prioriser les actions.</div>
                        <div style="margin-bottom: 15px;"><strong>ID:</strong> ${id}</div>
                        <div style="margin-bottom: 15px;"><strong>Cr√©√© le:</strong> ${new Date(createdAt).toLocaleString('fr-FR')}</div>
                        <div style="margin-bottom: 15px;"><strong>Mis √† jour le:</strong> ${new Date(updatedAt).toLocaleString('fr-FR')}</div>
                        ${clientId ? `<div style="margin-bottom: 15px;"><strong>Client ID:</strong> ${clientId}</div>` : ''}
                        <h3 style="color: #667eea; margin-top: 25px; margin-bottom: 15px;">Timeline (${Array.isArray(timeline) ? timeline.length : 0} √©v√©nement(s))</h3>
                        <div class="event-list" style="max-height: 400px;">`;

                if (Array.isArray(timeline)) {
                    timeline.forEach(e => {
                        const payload = parseRawPayloadSafe(e.rawPayload);
                        html += `<div class="event-item">${renderRichEmailBlock(payload, e.occurredAt, e.id)}</div>`;
                    });
                }

                html += `</div></div></div>`;

                const existing = document.getElementById('caseModal');
                if (existing) existing.remove();

                document.body.insertAdjacentHTML('beforeend', html);
                document.getElementById('caseModal').style.display = 'block';
            } catch (err) {
                alert(`Erreur: ${err.message}`);
            }
        }

        function showTemplateModal(eventId, clientContext, subject) {
            if (!templateManager) {
                alert('Connectez-vous d\'abord');
                return;
            }
            templateManager.showTemplateModal(eventId, clientContext, subject);
        }

        function closeModal() {
            const modal = document.getElementById('caseModal');
            if (modal) modal.style.display = 'none';
        }

        function closeEventModal() {
            const modal = document.getElementById('eventModal');
            if (modal) modal.style.display = 'none';
        }

        async function showEventDetail(eventId) {
            if (!token) return alert('Connectez-vous d\'abord');

            try {
                const res = await fetch(`${API_URL}/api/events/${eventId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) {
                    alert('Impossible de charger l\'√©v√©nement');
                    return;
                }
                
                const event = await res.json();
                const payload = parseRawPayloadSafe(event.rawPayload);
                const digest = buildReadableEventDigest(payload, event.occurredAt, { includeFullBody: true });
                
                let html = `<div class="modal" id="eventModal" onclick="if(event.target.id==='eventModal')closeEventModal()">
                    <div class="modal-content">
                        <span class="modal-close" onclick="closeEventModal()">&times;</span>
                        <h2 style="color: #667eea; margin-bottom: 20px;">D√©tail de l'√©v√©nement</h2>
                        <div style="margin-bottom: 15px;"><strong>ID:</strong> ${event.id}</div>
                        <div style="margin-bottom: 15px;"><strong>Date:</strong> ${digest.when}</div>
                        <div style="margin-bottom: 15px;"><strong>De:</strong> ${digest.who}</div>
                        <div style="margin-bottom: 15px;"><strong>Sujet:</strong> ${payload.subject || 'N/A'}</div>
                        <div style="margin-bottom: 15px;"><strong>Contenu:</strong></div>
                        <div style="white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto;">${digest.what}</div>`;
                
                if (event.validationFlags) {
                    html += `<div style="margin-top: 15px; color: orange;"><strong>‚ö†Ô∏è Anomalies:</strong> ${event.validationFlags}</div>`;
                }
                
                html += `</div></div>`;
                
                const existing = document.getElementById('eventModal');
                if (existing) existing.remove();
                
                document.body.insertAdjacentHTML('beforeend', html);
                document.getElementById('eventModal').style.display = 'block';
            } catch (err) {
                alert(`Erreur: ${err.message}`);
            }
        }

        async function loadStats() {
            if (!token) return showResult('stats-result', '‚ùå Connectez-vous d\'abord', false);
            setLoadingState('stats-result', '‚è≥ Chargement des indicateurs...');

            try {
                const [perDayRes, byTypeRes, avgSevRes] = await Promise.all([
                    apiFetchWithFallback('/api/stats/events-per-day', { headers: { 'Authorization': `Bearer ${token}` }}),
                    apiFetchWithFallback('/api/stats/events-by-type', { headers: { 'Authorization': `Bearer ${token}` }}),
                    apiFetchWithFallback('/api/stats/average-severity', { headers: { 'Authorization': `Bearer ${token}` }})
                ]);

                if (!perDayRes.ok || !byTypeRes.ok || !avgSevRes.ok) {
                    return showResult('stats-result', '‚ùå Impossible de charger les statistiques', false);
                }

                const perDay = await readResponseDataSafe(perDayRes);
                const byType = await readResponseDataSafe(byTypeRes);
                const avgSev = await readResponseDataSafe(avgSevRes);

                const totalEmails = (perDay || []).reduce((a,b) => a + b.count, 0);
                const activeDays = (perDay || []).length;
                const eventTypes = (byType || []).length;
                const avgSeverity = avgSev?.averageSeverity?.toFixed(1) || 'N/A';

                let html = '<div class="stats">';
                html += `<div class="stat-box"><div class="number">${totalEmails}</div><div class="label">Emails re√ßus</div></div>`;
                html += `<div class="stat-box"><div class="number">${activeDays}</div><div class="label">Jour(s) d'activit√©</div></div>`;
                html += `<div class="stat-box"><div class="number">${eventTypes}</div><div class="label">Type(s) d√©tect√©(s)</div></div>`;
                html += `<div class="stat-box"><div class="number">${avgSeverity}</div><div class="label">Niveau moyen d'alerte</div></div>`;
                html += '</div>';

                const sortedTypes = [...(byType || [])].sort((a, b) => (b.count || 0) - (a.count || 0));
                const byTypeList = sortedTypes.map(x => `${x.type}: ${x.count}`).join(', ') || 'Aucune donn√©e';
                const dominantType = sortedTypes[0];

                html += `<div class="guide-box"><strong>Lecture simple</strong>: vous avez re√ßu <strong>${totalEmails} email(s)</strong> sur <strong>${activeDays} jour(s)</strong>. Le niveau moyen d'alerte est <strong>${avgSeverity}</strong>.</div>`;
                html += `<div class="result" style="margin-top: 12px;"><strong>R√©partition par type:</strong> ${byTypeList}</div>`;

                if (dominantType) {
                    const percent = totalEmails > 0 ? ((dominantType.count / totalEmails) * 100).toFixed(1) : '0.0';
                    html += `<div class="result" style="margin-top: 8px;"><strong>Point cl√©:</strong> le type principal est <strong>${dominantType.type}</strong> avec <strong>${dominantType.count}</strong> email(s), soit <strong>${percent}%</strong> du total.</div>`;
                }
                
                document.getElementById('stats-result').innerHTML = html;
            } catch (err) {
                showResult('stats-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        async function loadTimelineForFirstCase() {
            if (!token) return showResult('cases-result', '‚ùå Connectez-vous d\'abord', false);

            try {
                const casesRes = await fetch(`${API_URL}/api/cases`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const casesData = await casesRes.json();
                if (!casesRes.ok || !Array.isArray(casesData) || casesData.length === 0) {
                    return showResult('cases-result', '‚ùå Aucun dossier pour timeline', false);
                }

                const caseId = lastCaseId || casesData[0].id;
                const timelineRes = await fetch(`${API_URL}/api/cases/${caseId}/timeline`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const timelineData = await timelineRes.json();

                if (!timelineRes.ok) {
                    return showResult('cases-result', '‚ùå Erreur timeline', false);
                }

                let html = `<div class="result success">‚úÖ Timeline dossier ${caseId}: ${timelineData.length} √©v√©nement(s)</div>`;
                html += '<div class="event-list">';
                timelineData.forEach(e => {
                    html += `<div class="event-item">
                        <div class="date">${new Date(e.occurredAt).toLocaleString('fr-FR')}</div>
                        <div class="content">${(e.rawPayload || '').substring(0, 200)}...</div>
                    </div>`;
                });
                html += '</div>';
                document.getElementById('cases-result').innerHTML = html;
            } catch (err) {
                showResult('cases-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        async function exportEventsText() {
            if (!token) return showResult('export-result', '‚ùå Connectez-vous d\'abord', false);
            
            try {
                const res = await fetch(`${API_URL}/api/export/events-text`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `events_text_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    showResult('export-result', `‚úÖ Export r√©ussi (${data.length} √©v√©nement(s))`);
                } else {
                    showResult('export-result', `‚ùå Erreur d'export`, false);
                }
            } catch (err) {
                showResult('export-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        async function loadAlerts() {
            if (!token) return showResult('alerts-result', '‚ùå Connectez-vous d\'abord', false);
            setLoadingState('alerts-result', '‚è≥ Chargement des alertes et notifications...');

            try {
                const [attentionRes, notificationsRes] = await Promise.all([
                    apiFetchWithFallback('/api/alerts/requires-attention', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    apiFetchWithFallback('/api/notifications?unreadOnly=true', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                const attentionData = await readResponseDataSafe(attentionRes);
                const unreadNotifications = await readResponseDataSafe(notificationsRes);

                if (!attentionRes.ok) {
                    return showResult('alerts-result', '‚ùå Erreur chargement alertes', false);
                }

                const notifications = Array.isArray(unreadNotifications) ? unreadNotifications : [];
                const data = attentionData || { count: 0, events: [] };

                if ((data.count || 0) === 0 && notifications.length === 0) {
                    return showResult('alerts-result', '‚úÖ Aucun email en anomalie et aucune notification en attente.');
                }

                let html = '';

                if ((data.count || 0) > 0) {
                    html += `<div class="result" style="border-left-color: orange; background: #fff3cd;">‚ö†Ô∏è ${data.count} email(s) n√©cessitent votre attention<br><strong>D√©cision finale:</strong> Utilisateur (les actions propos√©es sont des aides)<br>`;
                    html += `<button class="btn" style="margin-top:8px; background:#c62828;" onclick="bulkDeleteAllAttentionEvents(${data.count})">Supprimer tout d'un coup (${data.count})</button>`;
                    html += `<button class="btn" style="margin-top:8px; background:#8d6e63;" onclick="bulkDeleteAttentionExcept(${data.count})">Tout supprimer sauf un type...</button>`;
                    html += `</div>`;

                    html += '<div class="event-list">';
                    data.events.forEach(e => {
                        const payload = parseRawPayloadSafe(e.rawPayload);
                        const flags = e.validationFlags ? e.validationFlags.split(',') : [];
                        const from = payload.from || payload.From || 'Manquant';
                        const subject = payload.subject || payload.Subject || 'Manquant';
                        const body = payload.body || payload.Body || '';
                        const readableFlags = renderReadableAnomalyFlags(flags);

                        html += `<div class="event-item case-item" style="border-left-color: orange; cursor:pointer;" onclick="showEventDetail('${e.id}')">
                            <div class="date">${new Date(e.occurredAt).toLocaleString('fr-FR')}</div>
                            <div><strong>De:</strong> <span style="color:${from === 'Manquant' ? 'red' : 'inherit'};">${escapeScanHtml(from)}</span></div>
                            <div><strong>Sujet:</strong> <span style="color:${subject === 'Manquant' ? 'red' : 'inherit'};">${escapeScanHtml(subject)}</span></div>
                            <div class="content" style="margin-top:8px;">${escapeScanHtml(body.substring(0, 150))}${body.length > 150 ? '...' : ''}</div>
                            <div style="color: orange; margin-top: 8px;">‚ö†Ô∏è Anomalies: ${readableFlags}</div>
                            <button class="btn" style="margin-top: 8px;" onclick="event.stopPropagation(); showEventDetail('${e.id}')">Voir tous les d√©tails</button>
                            <button class="btn" style="margin-top: 8px; background:#c62828;" onclick="event.stopPropagation(); deleteEventFromAlert('${e.id}')">Supprimer cet √©v√©nement</button>
                        </div>`;
                    });
                    html += '</div>';
                }

                html += `<div class="result" style="margin-top:10px; border-left-color:#667eea; background:#eef3ff;">üîî Notifications √† traiter: <strong>${notifications.length}</strong>`;
                if (notifications.length > 0) {
                    html += `<div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">`;
                    html += `<button class="btn" onclick="toggleAllAlertNotifications(true)">Tout cocher</button>`;
                    html += `<button class="btn" onclick="toggleAllAlertNotifications(false)">Tout d√©cocher</button>`;
                    html += `<button class="btn" style="background:#2e7d32;" onclick="closeSelectedNotificationsManually()">Cl√¥turer la s√©lection (log)</button>`;
                    html += `</div>`;
                }
                html += `</div>`;

                if (notifications.length > 0) {
                    html += '<div class="event-list">';
                    notifications.forEach(n => {
                        html += `<div class="event-item" style="border-left-color:#667eea;">
                            <label style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                                <input type="checkbox" class="alert-notification-checkbox" value="${escapeScanHtml(n.id)}" />
                                <span>S√©lectionner pour cl√¥ture group√©e</span>
                            </label>
                            <div class="date">${new Date(n.createdAt).toLocaleString('fr-FR')} - ${escapeScanHtml(n.type || 'INFO')}</div>
                            <div><strong>${escapeScanHtml(n.title || 'Notification')}</strong></div>
                            <div class="content">${escapeScanHtml(n.message || '')}</div>
                            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="btn" onclick="markNotificationAsRead('${n.id}')">Marquer lue</button>
                                <button class="btn" style="background:#2e7d32;" onclick="closeNotificationManually('${n.id}')">Cl√¥turer manuellement (log)</button>
                                <button class="btn" style="background:#8d6e63;" onclick="dismissNotificationFromAlerts('${n.id}')">Ignorer (log)</button>
                            </div>
                        </div>`;
                    });
                    html += '</div>';
                }

                document.getElementById('alerts-result').innerHTML = html;
            } catch (err) {
                showResult('alerts-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        const ANOMALY_FLAG_LABELS = {
            DUPLICATE_EXTERNAL_ID: 'Email d√©j√† re√ßu (m√™me identifiant)',
            DUPLICATE_CONTENT: 'Contenu identique √† un email existant',
            MISSING_SENDER: 'Exp√©diteur manquant',
            MISSING_SUBJECT: 'Sujet manquant',
            MISSING_BODY: 'Contenu du message manquant'
        };

        function getReadableAnomalyFlag(flag) {
            const key = (flag || '').toString().trim().toUpperCase();
            return ANOMALY_FLAG_LABELS[key] || key || 'Anomalie non pr√©cis√©e';
        }

        function renderReadableAnomalyFlags(flags) {
            if (!Array.isArray(flags) || flags.length === 0) {
                return '<span class="meta-chip">Aucune anomalie</span>';
            }

            return flags
                .filter(Boolean)
                .map(f => {
                    const raw = (f || '').toString().trim().toUpperCase();
                    const label = getReadableAnomalyFlag(raw);
                    return `<span class="meta-chip" title="Code: ${escapeScanHtml(raw)}">${escapeScanHtml(label)}</span>`;
                })
                .join(' ');
        }

        async function markNotificationAsRead(notificationId) {
            if (!token) return;

            try {
                const res = await apiFetchWithFallback(`/api/notifications/${notificationId}/mark-read`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await readResponseDataSafe(res);
                if (!res.ok) {
                    return showResult('alerts-result', `‚ùå Impossible de marquer comme lue: ${data?.message || 'erreur'}`, false);
                }

                showResult('alerts-result', '‚úÖ Notification marqu√©e comme lue (action logu√©e).');
                await loadAlerts();
                await refreshAnomalyBadge();
            } catch (err) {
                showResult('alerts-result', `‚ùå Erreur marquage notification: ${err.message}`, false);
            }
        }

        function getSelectedAlertNotificationIds() {
            return Array.from(document.querySelectorAll('.alert-notification-checkbox:checked'))
                .map(input => input.value)
                .filter(Boolean);
        }

        function toggleAllAlertNotifications(checked) {
            document.querySelectorAll('.alert-notification-checkbox').forEach(input => {
                input.checked = checked === true;
            });
        }

        async function closeSelectedNotificationsManually() {
            if (!token) return;

            const ids = getSelectedAlertNotificationIds();
            if (ids.length === 0) {
                return showResult('alerts-result', '‚ö†Ô∏è Cochez au moins une notification √† cl√¥turer.', false);
            }

            const resolution = prompt(
                `Action de cl√¥ture √† journaliser pour ${ids.length} notification(s):`,
                'Cl√¥ture group√©e valid√©e par l\'utilisateur'
            );

            if (!resolution) return;

            let successCount = 0;
            let failureCount = 0;

            for (const notificationId of ids) {
                try {
                    const res = await apiFetchWithFallback(`/api/notifications/${notificationId}/resolve`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ resolution, action: 'MANUAL_CLOSE_BULK' })
                    });

                    if (res.ok) {
                        successCount++;
                    } else {
                        failureCount++;
                    }
                } catch {
                    failureCount++;
                }
            }

            if (failureCount === 0) {
                showResult('alerts-result', `‚úÖ ${successCount} notification(s) cl√¥tur√©e(s) et logu√©e(s).`);
            } else {
                showResult('alerts-result', `‚ö†Ô∏è Cl√¥ture group√©e partielle: ${successCount} r√©ussie(s), ${failureCount} en √©chec.`, false);
            }

            await loadAlerts();
            await refreshAnomalyBadge();

            const anomalyCenterEl = document.getElementById('anomaly-center-result');
            if (anomalyCenterEl && anomalyCenterEl.innerHTML.trim().length > 0) {
                await loadAnomalyCenter();
            }
        }

        async function closeNotificationManually(notificationId) {
            if (!token) return;

            const resolution = prompt('Action de cl√¥ture √† journaliser:', 'Cl√¥ture manuelle valid√©e par l\'utilisateur');
            if (!resolution) return;

            try {
                const res = await apiFetchWithFallback(`/api/notifications/${notificationId}/resolve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ resolution, action: 'MANUAL_CLOSE' })
                });

                const data = await readResponseDataSafe(res);
                if (!res.ok) {
                    return showResult('alerts-result', `‚ùå Cl√¥ture manuelle impossible: ${data?.message || 'erreur'}`, false);
                }

                showResult('alerts-result', '‚úÖ Notification cl√¥tur√©e manuellement et logu√©e dans l\'audit.');
                await loadAlerts();
                await refreshAnomalyBadge();

                const anomalyCenterEl = document.getElementById('anomaly-center-result');
                if (anomalyCenterEl && anomalyCenterEl.innerHTML.trim().length > 0) {
                    await loadAnomalyCenter();
                }
            } catch (err) {
                showResult('alerts-result', `‚ùå Erreur cl√¥ture manuelle: ${err.message}`, false);
            }
        }

        async function dismissNotificationFromAlerts(notificationId) {
            if (!token) return;

            const reason = prompt('Raison de fermeture (optionnel):', 'Notification trait√©e manuellement');
            if (reason === null) return;

            try {
                const res = await apiFetchWithFallback(`/api/notifications/${notificationId}/dismiss`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ reason })
                });

                const data = await readResponseDataSafe(res);
                if (!res.ok) {
                    return showResult('alerts-result', `‚ùå Fermeture impossible: ${data?.message || 'erreur'}`, false);
                }

                showResult('alerts-result', '‚úÖ Notification ferm√©e et logu√©e.');
                await loadAlerts();
                await refreshAnomalyBadge();
            } catch (err) {
                showResult('alerts-result', `‚ùå Erreur fermeture notification: ${err.message}`, false);
            }
        }

        async function bulkDeleteAllAttentionEvents(currentCount) {
            if (!token) return showResult('alerts-result', '‚ùå Connectez-vous d\'abord', false);

            const count = Number(currentCount || 0);
            const confirmed = confirm(`Supprimer d'un coup tous les emails n√©cessitant attention pour cet utilisateur ?\nVolume estim√©: ${count}.\nAction irr√©versible.`);
            if (!confirmed) return;

            try {
                const res = await apiFetchWithFallback('/api/events/bulk-delete-attention', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ maxToDelete: Math.max(count, 1) })
                });

                const data = await readResponseDataSafe(res);
                if (!res.ok) {
                    return showResult('alerts-result', `‚ùå Suppression en masse impossible: ${data?.message || 'erreur'}`, false);
                }

                showResult('alerts-result', `‚úÖ ${data.message || 'Suppression en masse effectu√©e'} (${data.deletedCount || 0} supprim√©(s))`);
                await loadAlerts();
                await refreshAnomalyBadge();

                const anomalyCenterEl = document.getElementById('anomaly-center-result');
                if (anomalyCenterEl && anomalyCenterEl.innerHTML.trim().length > 0) {
                    await loadAnomalyCenter();
                }
            } catch (err) {
                showResult('alerts-result', `‚ùå Erreur suppression en masse: ${err.message}`, false);
            }
        }

        async function bulkDeleteAttentionExcept(currentCount) {
            if (!token) return showResult('alerts-result', '‚ùå Connectez-vous d\'abord', false);

            const excludedFlag = prompt('Conserver quel type d\'anomalie ? (ex: MISSING_SENDER, DUPLICATE_CONTENT)', 'MISSING_SENDER');
            if (!excludedFlag) return;

            const count = Number(currentCount || 0);
            const confirmed = confirm(`Supprimer tous les emails en attention SAUF ${excludedFlag.trim().toUpperCase()} ?\nVolume estim√©: ${count}.\nAction irr√©versible.`);
            if (!confirmed) return;

            try {
                const res = await apiFetchWithFallback('/api/events/bulk-delete-attention', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        maxToDelete: Math.max(count, 1),
                        excludedValidationFlag: excludedFlag.trim().toUpperCase()
                    })
                });

                const data = await readResponseDataSafe(res);
                if (!res.ok) {
                    return showResult('alerts-result', `‚ùå Suppression en masse impossible: ${data?.message || 'erreur'}`, false);
                }

                showResult('alerts-result',
                    `‚úÖ Suppression en masse effectu√©e (${data.deletedCount || 0} supprim√©(s))<br>` +
                    `Type conserv√©: ${data.excludedValidationFlag || excludedFlag}`);

                await loadAlerts();
                await refreshAnomalyBadge();

                const anomalyCenterEl = document.getElementById('anomaly-center-result');
                if (anomalyCenterEl && anomalyCenterEl.innerHTML.trim().length > 0) {
                    await loadAnomalyCenter();
                }
            } catch (err) {
                showResult('alerts-result', `‚ùå Erreur suppression en masse: ${err.message}`, false);
            }
        }

        async function loadAudit() {
            if (!token) return showResult('audit-result', '‚ùå Connectez-vous d\'abord', false);
            setLoadingState('audit-result', '‚è≥ Chargement de l\'historique d\'audit...');

            try {
                const res = await apiFetchWithFallback('/api/audit/user-actions?limit=100', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const actions = Array.isArray(data) ? data : (data.actions || []);

                if (res.ok) {
                    let html = `<div class="result success">‚úÖ ${actions.length} action(s) d'audit</div>`;
                    html += '<div class="event-list">';
                    actions.forEach(a => {
                        html += `<div class="event-item">
                            <strong>${a.action}</strong>
                            <div class="date">${new Date(a.occurredAt).toLocaleString('fr-FR')}</div>
                            <div class="content">${(a.metadata || '').toString().substring(0, 200)}</div>
                        </div>`;
                    });
                    html += '</div>';
                    document.getElementById('audit-result').innerHTML = html;
                } else {
                    showResult('audit-result', `‚ùå Erreur`, false);
                }
            } catch (err) {
                showResult('audit-result', `‚ùå Erreur de connexion API: ${err.message}`, false);
            }
        }

        async function deleteEventFromAlert(eventId) {
            if (!token) return showResult('alerts-result', '‚ùå Connectez-vous d\'abord', false);

            if (!confirm('Supprimer cet √©v√©nement ? Cette action est irr√©versible.')) {
                return;
            }

            try {
                const res = await fetch(`${API_URL}/api/events/${eventId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    showResult('alerts-result', `‚úÖ ${data.message} (${eventId})`);
                    await loadAlerts();
                    await refreshAnomalyBadge();
                    const anomalyCenterEl = document.getElementById('anomaly-center-result');
                    if (anomalyCenterEl && anomalyCenterEl.innerHTML.trim().length > 0) {
                        await loadAnomalyCenter();
                    }
                } else {
                    showResult('alerts-result', `‚ùå Suppression impossible`, false);
                }
            } catch (err) {
                showResult('alerts-result', `‚ùå Erreur: ${err.message}`, false);
            }
        }

        async function acquitterDoublon(notificationId) {
            if (!token) return alert('Connectez-vous d\'abord');

            const raison = prompt('Raison de l\'acquittement (optionnel):', 'Doublon confirm√© - Email l√©gitime');
            if (raison === null) return;

            try {
                const res = await fetch(`${API_URL}/api/notifications/${notificationId}/dismiss`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ reason: raison })
                });
                const data = await res.json();
                if (res.ok) {
                    document.getElementById('ingest-result').innerHTML = `<div class="result success">‚úÖ Doublon acquitt√© - Action logu√©e dans l'audit</div>`;
                } else {
                    alert('Erreur lors de l\'acquittement');
                }
            } catch (err) {
                alert(`Erreur: ${err.message}`);
            }
        }

        document.getElementById('installBtn')?.addEventListener('click', async () => {
            try {
                await installApp();
            } catch (err) {
                alert(`Erreur installation: ${err.message}`);
            }
        });

        document.getElementById('stopBtn')?.addEventListener('click', async () => {
            try {
                await stopApplication();
            } catch (err) {
                alert(`Erreur arr√™t: ${err.message}`);
            }
        });

        prefillDemoFields();
        restoreSession();
        applyAccessMode();
        autoConnectDefaultUser();
        keepPinnedSessionAlive();
        refreshServiceStatus();
        setInterval(refreshServiceStatus, 5000);
        setInterval(() => {
            if (token) refreshAnomalyBadge();
        }, 8000);
        setInterval(keepPinnedSessionAlive, 180000);

        // Team management functions
        async function loadTeamData() {
            if (!token) {
                document.getElementById('teamMembersList').innerHTML = 'Connectez-vous d\'abord';
                document.getElementById('teamPendingList').innerHTML = 'Connectez-vous d\'abord';
                return;
            }

            setLoadingState('teamMembersList', '‚è≥ Chargement des membres...');
            setLoadingState('teamPendingList', '‚è≥ Chargement des invitations...');
            
            try {
                const response = await apiFetchWithFallback('/api/team/members', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await readResponseDataSafe(response);
                
                if (response.ok) {
                    displayTeamMembers(data.members || []);
                    displayPendingInvitations(data.pendingInvitations || []);
                } else {
                    const errorMessage = typeof data === 'string' ? data : (data?.message || 'Erreur de chargement');
                    document.getElementById('teamMembersList').innerHTML = `Erreur: ${errorMessage}`;
                    document.getElementById('teamPendingList').innerHTML = `Erreur: ${errorMessage}`;
                }
            } catch (error) {
                document.getElementById('teamMembersList').innerHTML = 'Erreur de connexion';
                document.getElementById('teamPendingList').innerHTML = 'Erreur de connexion';
            }
        }
        
        function displayTeamMembers(members) {
            const container = document.getElementById('teamMembersList');
            if (!members || members.length === 0) {
                container.innerHTML = 'Aucun membre dans l\'√©quipe. Invitez des collaborateurs ci-dessus.';
                return;
            }
            
            let html = '<div class="event-list">';
            members.forEach(member => {
                const memberId = pickValue(member, 'id', 'Id');
                const user = pickValue(member, 'user', 'User') || {};
                const role = pickValue(member, 'role', 'Role') || 'N/A';
                const joinedAt = pickValue(member, 'joinedAt', 'JoinedAt');
                const roleLabel = getRoleLabel(role);

                const roleOptions = ['OWNER', 'PARTNER', 'LAWYER', 'PARALEGAL', 'SECRETARY', 'INTERN']
                    .map(r => `<option value="${r}" ${r === role ? 'selected' : ''}>${getRoleLabel(r)}</option>`)
                    .join('');

                html += `<div class="event-item">
                    <strong>${pickValue(user, 'name', 'Name') || 'N/A'}</strong>
                    <div class="date">${pickValue(user, 'email', 'Email') || 'N/A'} - ${roleLabel}</div>
                    <div class="content">Rejoint le ${joinedAt ? new Date(joinedAt).toLocaleDateString('fr-FR') : 'N/A'}</div>
                    <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                        <select id="team-role-${memberId}" style="padding:6px; border-radius:4px; border:1px solid #ddd;">
                            ${roleOptions}
                        </select>
                        <button class="btn" onclick="updateTeamMemberRole('${memberId}')">Changer r√¥le</button>
                        <button class="btn" style="background:#c62828;" onclick="removeTeamMember('${memberId}')">Retirer membre</button>
                    </div>
                </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function displayPendingInvitations(invitations) {
            const container = document.getElementById('teamPendingList');
            if (!invitations || invitations.length === 0) {
                container.innerHTML = 'Aucune invitation en attente.';
                return;
            }
            
            let html = '<div class="event-list">';
            invitations.forEach(inv => {
                const role = pickValue(inv, 'role', 'Role') || 'N/A';
                const email = pickValue(inv, 'email', 'Email') || 'N/A';
                const createdAt = pickValue(inv, 'createdAt', 'CreatedAt');
                const expiresAt = pickValue(inv, 'expiresAt', 'ExpiresAt');
                const roleLabel = getRoleLabel(role);
                const encodedEmail = encodeURIComponent(email);
                const encodedRole = encodeURIComponent(role);
                html += `<div class="event-item">
                    <strong>${email}</strong>
                    <div class="date">${roleLabel}</div>
                    <div class="content">Envoy√©e le ${createdAt ? new Date(createdAt).toLocaleDateString('fr-FR') : 'N/A'}</div>
                    <div class="content">Expire le ${expiresAt ? new Date(expiresAt).toLocaleDateString('fr-FR') : 'N/A'}</div>
                    <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn" onclick="resendPendingInvitation('${encodedEmail}','${encodedRole}')">Renvoyer invitation</button>
                    </div>
                </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function getRoleLabel(role) {
            const labels = {
                'OWNER': 'Propri√©taire',
                'PARTNER': 'Associ√©',
                'LAWYER': 'Avocat',
                'PARALEGAL': 'Juriste',
                'SECRETARY': 'Secr√©taire',
                'INTERN': 'Stagiaire'
            };
            return labels[role] || role;
        }

        async function updateTeamMemberRole(memberId) {
            if (!token) return showResult('teamInviteResult', 'Connectez-vous d\'abord', false);

            const select = document.getElementById(`team-role-${memberId}`);
            const role = select?.value;
            if (!role) {
                return showResult('teamInviteResult', 'R√¥le invalide', false);
            }

            try {
                const response = await apiFetchWithFallback(`/api/team/members/${memberId}/role`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ role })
                });

                const data = await readResponseDataSafe(response);
                if (!response.ok) {
                    const msg = typeof data === 'string' ? data : (data?.message || 'Mise √† jour impossible');
                    return showResult('teamInviteResult', `‚ùå ${msg}`, false);
                }

                showResult('teamInviteResult', `‚úÖ R√¥le mis √† jour (${getRoleLabel(role)}).`);
                await loadTeamData();
            } catch (error) {
                showResult('teamInviteResult', '‚ùå Erreur de connexion', false);
            }
        }

        async function removeTeamMember(memberId) {
            if (!token) return showResult('teamInviteResult', 'Connectez-vous d\'abord', false);

            const confirmed = confirm('Retirer ce membre de l\'√©quipe ?');
            if (!confirmed) return;

            try {
                const response = await apiFetchWithFallback(`/api/team/members/${memberId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await readResponseDataSafe(response);
                if (!response.ok) {
                    const msg = typeof data === 'string' ? data : (data?.message || 'Suppression impossible');
                    return showResult('teamInviteResult', `‚ùå ${msg}`, false);
                }

                showResult('teamInviteResult', '‚úÖ Membre retir√© de l\'√©quipe.');
                await loadTeamData();
            } catch (error) {
                showResult('teamInviteResult', '‚ùå Erreur de connexion', false);
            }
        }

        async function copyTeamInviteUrl(encodedUrl) {
            const inviteUrl = decodeURIComponent(encodedUrl || '');
            if (!inviteUrl) return;

            try {
                await navigator.clipboard.writeText(inviteUrl);
                showResult('teamInviteResult', `‚úÖ Lien d'invitation copi√©.<br><small>${inviteUrl}</small>`);
            } catch {
                showResult('teamInviteResult', `‚úÖ Invitation cr√©√©e. Copiez ce lien:<br><small>${inviteUrl}</small>`);
            }
        }

        async function resendPendingInvitation(emailEnc, roleEnc) {
            if (!token) return showResult('teamInviteResult', 'Connectez-vous d\'abord', false);

            const email = decodeURIComponent(emailEnc || '');
            const role = decodeURIComponent(roleEnc || '');

            if (!email || !role) {
                return showResult('teamInviteResult', 'Invitation invalide', false);
            }

            try {
                const response = await apiFetchWithFallback('/api/team/invite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ email, role })
                });

                const data = await readResponseDataSafe(response);
                if (!response.ok) {
                    const msg = typeof data === 'string' ? data : (data?.message || 'Impossible de renvoyer l\'invitation');
                    return showResult('teamInviteResult', `‚ùå ${msg}`, false);
                }

                const inviteUrl = (data?.inviteUrl || '').toString();
                const encodedInviteUrl = encodeURIComponent(inviteUrl);
                let message = `‚úÖ Invitation renvoy√©e √† ${email}`;

                if (inviteUrl) {
                    message += `<br><small>Lien: ${inviteUrl}</small>`;
                    message += `<br><button class="btn" onclick="copyTeamInviteUrl('${encodedInviteUrl}')">Copier le lien d'invitation</button>`;
                }

                showResult('teamInviteResult', message);
                await loadTeamData();
            } catch {
                showResult('teamInviteResult', '‚ùå Erreur de connexion', false);
            }
        }
        
        // Team invite form handler
        document.addEventListener('DOMContentLoaded', function() {
            const teamForm = document.getElementById('teamInviteForm');
            if (teamForm) {
                teamForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    if (!token) {
                        showResult('teamInviteResult', 'Connectez-vous d\'abord', false);
                        return;
                    }
                    
                    const email = document.getElementById('teamInviteEmail').value;
                    const role = document.getElementById('teamInviteRole').value;
                    
                    try {
                        const response = await fetch(`${API_URL}/api/team/invite`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ email, role })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const inviteUrl = (data?.inviteUrl || '').toString();
                            const encodedInviteUrl = encodeURIComponent(inviteUrl);

                            let message = `‚úÖ Invitation envoy√©e √† ${email}`;
                            if (inviteUrl) {
                                message += `<br><small>Lien: ${inviteUrl}</small>`;
                                message += `<br><button class="btn" onclick="copyTeamInviteUrl('${encodedInviteUrl}')">Copier le lien d'invitation</button>`;
                            }

                            showResult('teamInviteResult', message);
                            document.getElementById('teamInviteForm').reset();
                            loadTeamData();
                        } else {
                            const errorData = await response.json().catch(() => ({}));
                            showResult('teamInviteResult', `Erreur: ${errorData.message || 'Impossible d\'envoyer l\'invitation'}`, false);
                        }
                    } catch (error) {
                        showResult('teamInviteResult', 'Erreur de connexion', false);
                    }
                });
            }
        });
        
        // showTab g√®re directement le chargement de l'onglet √©quipe.
    </script>
</body>
</html>

